<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>Lua/APR binding documentation</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
body { font-family: sans-serif; padding: 1em 30% 10em 1em; cursor: default; }
a:link, a:visited { color: #000080; }
a:hover, a:active { color: #F00; }
pre, code, tt { font-family: Monaco, Consolas, monospace; }
pre, code { border: 1px solid #CCC; background: #F0F0F0; }
pre code, h1 code, h2 code, h3 code, h4 code, h5 code, h6 code { border: none; background: none; }
pre { padding: .3em; margin: 0 4em 0 2em; }
code { padding: .05em .2em; }
pre code { padding: none; }
p, li { text-align: justify; line-height: 1.75em; }
h1 { margin: 0; padding: 0 30% 0 0; color: #AAA; text-shadow: #000 1px 1px 0; }
h2, h3 { border-bottom: 2px solid #F6F6F6; margin: 2em 0 0 0; padding-left: 0.5em; }
h2 a:link, h2 a:visited, h3 a:link, h3 a:visited { padding: .2em; text-decoration: none; color: inherit; }
h2 a:hover, h3 a:hover { color: #F00; }
</style>
</head>
<body>
<h1>Lua/APR binding documentation</h1>

<p>The <a href="http://peterodding.com/code/lua/apr/">Lua/APR binding</a> aims to bring most of the functionality in the
<a href="http://en.wikipedia.org/wiki/Apache_Portable_Runtime">Apache Portable Runtime (APR)</a> to the small and flexible
<a href="http://en.wikipedia.org/wiki/Lua_%2528programming_language%2529">programming language Lua</a>. This document contains the documentation
for the Lua/APR binding. Some notes about this documentation:</p>

<ul>
<li><p>Most of the documentation is based on the <a href="http://apr.apache.org/docs/apr/trunk/modules.html">official APR documentation</a> but I've had to consult the APR source code here and there when
the official documentation didn&rsquo;t suffice. If anything seems amiss <a href="mailto:peter%40peterodding.com">please
let me know</a>.</p></li>
<li><p>The entries for all functions are automatically generated from the C and Lua
source code of the binding to prevent that documentation and implementation
become out of sync.</p></li>
</ul>


<p><em>This document was generated from the Lua/APR <strong>0.18-2</strong> source code.</em></p>

<h2>Table of contents</h2>

<dl>
<dt style="margin: 1em 0; font-weight: bold"><a href="#base64_encoding">Base64 encoding</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.base64_encode" style="text-decoration:none">apr.base64_encode()</a></li>
<li style="float: left; width: 16em"><a href="#apr.base64_decode" style="text-decoration:none">apr.base64_decode()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#cryptography_routines">Cryptography routines</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.md5_encode" style="text-decoration:none">apr.md5_encode()</a></li>
<li style="float: left; width: 16em"><a href="#apr.password_validate" style="text-decoration:none">apr.password_validate()</a></li>
<li style="float: left; width: 16em"><a href="#apr.password_get" style="text-decoration:none">apr.password_get()</a></li>
<li style="float: left; width: 16em"><a href="#apr.md5_init" style="text-decoration:none">apr.md5_init()</a></li>
<li style="float: left; width: 16em"><a href="#md5_context:update" style="text-decoration:none">md5_context:update()</a></li>
<li style="float: left; width: 16em"><a href="#md5_context:digest" style="text-decoration:none">md5_context:digest()</a></li>
<li style="float: left; width: 16em"><a href="#md5_context:reset" style="text-decoration:none">md5_context:reset()</a></li>
<li style="float: left; width: 16em"><a href="#apr.sha1_init" style="text-decoration:none">apr.sha1_init()</a></li>
<li style="float: left; width: 16em"><a href="#sha1_context:update" style="text-decoration:none">sha1_context:update()</a></li>
<li style="float: left; width: 16em"><a href="#sha1_context:digest" style="text-decoration:none">sha1_context:digest()</a></li>
<li style="float: left; width: 16em"><a href="#sha1_context:reset" style="text-decoration:none">sha1_context:reset()</a></li>
<li style="float: left; width: 16em"><a href="#apr.md5" style="text-decoration:none">apr.md5()</a></li>
<li style="float: left; width: 16em"><a href="#apr.sha1" style="text-decoration:none">apr.sha1()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#date_parsing">Date parsing</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.date_parse_http" style="text-decoration:none">apr.date_parse_http()</a></li>
<li style="float: left; width: 16em"><a href="#apr.date_parse_rfc" style="text-decoration:none">apr.date_parse_rfc()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#relational_database_drivers">Relational database drivers</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.dbd" style="text-decoration:none">apr.dbd()</a></li>
<li style="float: left; width: 16em"><a href="#driver:open" style="text-decoration:none">driver:open()</a></li>
<li style="float: left; width: 16em"><a href="#driver:dbname" style="text-decoration:none">driver:dbname()</a></li>
<li style="float: left; width: 16em"><a href="#driver:driver" style="text-decoration:none">driver:driver()</a></li>
<li style="float: left; width: 16em"><a href="#driver:check" style="text-decoration:none">driver:check()</a></li>
<li style="float: left; width: 16em"><a href="#driver:query" style="text-decoration:none">driver:query()</a></li>
<li style="float: left; width: 16em"><a href="#driver:select" style="text-decoration:none">driver:select()</a></li>
<li style="float: left; width: 16em"><a href="#driver:transaction_start" style="text-decoration:none">driver:transaction_start()</a></li>
<li style="float: left; width: 16em"><a href="#driver:transaction_end" style="text-decoration:none">driver:transaction_end()</a></li>
<li style="float: left; width: 16em"><a href="#driver:transaction_mode" style="text-decoration:none">driver:transaction_mode()</a></li>
<li style="float: left; width: 16em"><a href="#driver:prepare" style="text-decoration:none">driver:prepare()</a></li>
<li style="float: left; width: 16em"><a href="#prepared_statement:query" style="text-decoration:none">prepared_statement:query()</a></li>
<li style="float: left; width: 16em"><a href="#prepared_statement:select" style="text-decoration:none">prepared_statement:select()</a></li>
<li style="float: left; width: 16em"><a href="#result_set:columns" style="text-decoration:none">result_set:columns()</a></li>
<li style="float: left; width: 16em"><a href="#result_set:row" style="text-decoration:none">result_set:row()</a></li>
<li style="float: left; width: 16em"><a href="#result_set:rows" style="text-decoration:none">result_set:rows()</a></li>
<li style="float: left; width: 16em"><a href="#result_set:tuple" style="text-decoration:none">result_set:tuple()</a></li>
<li style="float: left; width: 16em"><a href="#result_set:tuples" style="text-decoration:none">result_set:tuples()</a></li>
<li style="float: left; width: 16em"><a href="#result_set:pairs" style="text-decoration:none">result_set:pairs()</a></li>
<li style="float: left; width: 16em"><a href="#result_set:__len" style="text-decoration:none">#result_set</a></li>
<li style="float: left; width: 16em"><a href="#driver:close" style="text-decoration:none">driver:close()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#dbm_routines">DBM routines</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.dbm_open" style="text-decoration:none">apr.dbm_open()</a></li>
<li style="float: left; width: 16em"><a href="#apr.dbm_getnames" style="text-decoration:none">apr.dbm_getnames()</a></li>
<li style="float: left; width: 16em"><a href="#dbm:exists" style="text-decoration:none">dbm:exists()</a></li>
<li style="float: left; width: 16em"><a href="#dbm:fetch" style="text-decoration:none">dbm:fetch()</a></li>
<li style="float: left; width: 16em"><a href="#dbm:store" style="text-decoration:none">dbm:store()</a></li>
<li style="float: left; width: 16em"><a href="#dbm:delete" style="text-decoration:none">dbm:delete()</a></li>
<li style="float: left; width: 16em"><a href="#dbm:firstkey" style="text-decoration:none">dbm:firstkey()</a></li>
<li style="float: left; width: 16em"><a href="#dbm:nextkey" style="text-decoration:none">dbm:nextkey()</a></li>
<li style="float: left; width: 16em"><a href="#dbm:close" style="text-decoration:none">dbm:close()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#environment_manipulation">Environment manipulation</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.env_get" style="text-decoration:none">apr.env_get()</a></li>
<li style="float: left; width: 16em"><a href="#apr.env_set" style="text-decoration:none">apr.env_set()</a></li>
<li style="float: left; width: 16em"><a href="#apr.env_delete" style="text-decoration:none">apr.env_delete()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#file_path_manipulation">File path manipulation</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.filepath_root" style="text-decoration:none">apr.filepath_root()</a></li>
<li style="float: left; width: 16em"><a href="#apr.filepath_parent" style="text-decoration:none">apr.filepath_parent()</a></li>
<li style="float: left; width: 16em"><a href="#apr.filepath_name" style="text-decoration:none">apr.filepath_name()</a></li>
<li style="float: left; width: 16em"><a href="#apr.filepath_merge" style="text-decoration:none">apr.filepath_merge()</a></li>
<li style="float: left; width: 16em"><a href="#apr.filepath_list_split" style="text-decoration:none">apr.filepath_list_split()</a></li>
<li style="float: left; width: 16em"><a href="#apr.filepath_list_merge" style="text-decoration:none">apr.filepath_list_merge()</a></li>
<li style="float: left; width: 16em"><a href="#apr.filepath_get" style="text-decoration:none">apr.filepath_get()</a></li>
<li style="float: left; width: 16em"><a href="#apr.filepath_set" style="text-decoration:none">apr.filepath_set()</a></li>
<li style="float: left; width: 16em"><a href="#apr.filepath_which" style="text-decoration:none">apr.filepath_which()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#filename_matching">Filename matching</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.fnmatch" style="text-decoration:none">apr.fnmatch()</a></li>
<li style="float: left; width: 16em"><a href="#apr.fnmatch_test" style="text-decoration:none">apr.fnmatch_test()</a></li>
<li style="float: left; width: 16em"><a href="#apr.glob" style="text-decoration:none">apr.glob()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#directory_manipulation">Directory manipulation</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.temp_dir_get" style="text-decoration:none">apr.temp_dir_get()</a></li>
<li style="float: left; width: 16em"><a href="#apr.dir_make" style="text-decoration:none">apr.dir_make()</a></li>
<li style="float: left; width: 16em"><a href="#apr.dir_make_recursive" style="text-decoration:none">apr.dir_make_recursive()</a></li>
<li style="float: left; width: 16em"><a href="#apr.dir_remove" style="text-decoration:none">apr.dir_remove()</a></li>
<li style="float: left; width: 16em"><a href="#apr.dir_remove_recursive" style="text-decoration:none">apr.dir_remove_recursive()</a></li>
<li style="float: left; width: 16em"><a href="#apr.dir_open" style="text-decoration:none">apr.dir_open()</a></li>
<li style="float: left; width: 16em"><a href="#directory:read" style="text-decoration:none">directory:read()</a></li>
<li style="float: left; width: 16em"><a href="#directory:rewind" style="text-decoration:none">directory:rewind()</a></li>
<li style="float: left; width: 16em"><a href="#directory:entries" style="text-decoration:none">directory:entries()</a></li>
<li style="float: left; width: 16em"><a href="#directory:close" style="text-decoration:none">directory:close()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#file_i_o_handling">File I/O handling</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.file_link" style="text-decoration:none">apr.file_link()</a></li>
<li style="float: left; width: 16em"><a href="#apr.file_copy" style="text-decoration:none">apr.file_copy()</a></li>
<li style="float: left; width: 16em"><a href="#apr.file_append" style="text-decoration:none">apr.file_append()</a></li>
<li style="float: left; width: 16em"><a href="#apr.file_rename" style="text-decoration:none">apr.file_rename()</a></li>
<li style="float: left; width: 16em"><a href="#apr.file_remove" style="text-decoration:none">apr.file_remove()</a></li>
<li style="float: left; width: 16em"><a href="#apr.file_mtime_set" style="text-decoration:none">apr.file_mtime_set()</a></li>
<li style="float: left; width: 16em"><a href="#apr.file_attrs_set" style="text-decoration:none">apr.file_attrs_set()</a></li>
<li style="float: left; width: 16em"><a href="#apr.file_perms_set" style="text-decoration:none">apr.file_perms_set()</a></li>
<li style="float: left; width: 16em"><a href="#apr.stat" style="text-decoration:none">apr.stat()</a></li>
<li style="float: left; width: 16em"><a href="#apr.file_open" style="text-decoration:none">apr.file_open()</a></li>
<li style="float: left; width: 16em"><a href="#file:stat" style="text-decoration:none">file:stat()</a></li>
<li style="float: left; width: 16em"><a href="#file:lines" style="text-decoration:none">file:lines()</a></li>
<li style="float: left; width: 16em"><a href="#file:read" style="text-decoration:none">file:read()</a></li>
<li style="float: left; width: 16em"><a href="#file:write" style="text-decoration:none">file:write()</a></li>
<li style="float: left; width: 16em"><a href="#file:seek" style="text-decoration:none">file:seek()</a></li>
<li style="float: left; width: 16em"><a href="#file:flush" style="text-decoration:none">file:flush()</a></li>
<li style="float: left; width: 16em"><a href="#file:lock" style="text-decoration:none">file:lock()</a></li>
<li style="float: left; width: 16em"><a href="#file:unlock" style="text-decoration:none">file:unlock()</a></li>
<li style="float: left; width: 16em"><a href="#pipe:timeout_get" style="text-decoration:none">pipe:timeout_get()</a></li>
<li style="float: left; width: 16em"><a href="#pipe:timeout_set" style="text-decoration:none">pipe:timeout_set()</a></li>
<li style="float: left; width: 16em"><a href="#file:inherit_set" style="text-decoration:none">file:inherit_set()</a></li>
<li style="float: left; width: 16em"><a href="#file:inherit_unset" style="text-decoration:none">file:inherit_unset()</a></li>
<li style="float: left; width: 16em"><a href="#file:close" style="text-decoration:none">file:close()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#network_i_o_handling">Network I/O handling</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.socket_create" style="text-decoration:none">apr.socket_create()</a></li>
<li style="float: left; width: 16em"><a href="#apr.hostname_get" style="text-decoration:none">apr.hostname_get()</a></li>
<li style="float: left; width: 16em"><a href="#apr.host_to_addr" style="text-decoration:none">apr.host_to_addr()</a></li>
<li style="float: left; width: 16em"><a href="#apr.addr_to_host" style="text-decoration:none">apr.addr_to_host()</a></li>
<li style="float: left; width: 16em"><a href="#socket:connect" style="text-decoration:none">socket:connect()</a></li>
<li style="float: left; width: 16em"><a href="#socket:bind" style="text-decoration:none">socket:bind()</a></li>
<li style="float: left; width: 16em"><a href="#socket:listen" style="text-decoration:none">socket:listen()</a></li>
<li style="float: left; width: 16em"><a href="#socket:accept" style="text-decoration:none">socket:accept()</a></li>
<li style="float: left; width: 16em"><a href="#socket:read" style="text-decoration:none">socket:read()</a></li>
<li style="float: left; width: 16em"><a href="#socket:write" style="text-decoration:none">socket:write()</a></li>
<li style="float: left; width: 16em"><a href="#socket:lines" style="text-decoration:none">socket:lines()</a></li>
<li style="float: left; width: 16em"><a href="#socket:timeout_get" style="text-decoration:none">socket:timeout_get()</a></li>
<li style="float: left; width: 16em"><a href="#socket:timeout_set" style="text-decoration:none">socket:timeout_set()</a></li>
<li style="float: left; width: 16em"><a href="#socket:opt_get" style="text-decoration:none">socket:opt_get()</a></li>
<li style="float: left; width: 16em"><a href="#socket:opt_set" style="text-decoration:none">socket:opt_set()</a></li>
<li style="float: left; width: 16em"><a href="#socket:addr_get" style="text-decoration:none">socket:addr_get()</a></li>
<li style="float: left; width: 16em"><a href="#socket:shutdown" style="text-decoration:none">socket:shutdown()</a></li>
<li style="float: left; width: 16em"><a href="#socket:close" style="text-decoration:none">socket:close()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#pipe_i_o_handling">Pipe I/O handling</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.pipe_open_stdin" style="text-decoration:none">apr.pipe_open_stdin()</a></li>
<li style="float: left; width: 16em"><a href="#apr.pipe_open_stdout" style="text-decoration:none">apr.pipe_open_stdout()</a></li>
<li style="float: left; width: 16em"><a href="#apr.pipe_open_stderr" style="text-decoration:none">apr.pipe_open_stderr()</a></li>
<li style="float: left; width: 16em"><a href="#apr.namedpipe_create" style="text-decoration:none">apr.namedpipe_create()</a></li>
<li style="float: left; width: 16em"><a href="#apr.pipe_create" style="text-decoration:none">apr.pipe_create()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#memcached_client">Memcached client</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.memcache" style="text-decoration:none">apr.memcache()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:hash" style="text-decoration:none">mc_client:hash()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:find_server_hash" style="text-decoration:none">mc_client:find_server_hash()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:add_server" style="text-decoration:none">mc_client:add_server()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:find_server" style="text-decoration:none">mc_client:find_server()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:enable_server" style="text-decoration:none">mc_client:enable_server()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:disable_server" style="text-decoration:none">mc_client:disable_server()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:get" style="text-decoration:none">mc_client:get()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:set" style="text-decoration:none">mc_client:set()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:add" style="text-decoration:none">mc_client:add()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:replace" style="text-decoration:none">mc_client:replace()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:delete" style="text-decoration:none">mc_client:delete()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:incr" style="text-decoration:none">mc_client:incr()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:decr" style="text-decoration:none">mc_client:decr()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:version" style="text-decoration:none">mc_client:version()</a></li>
<li style="float: left; width: 16em"><a href="#mc_client:stats" style="text-decoration:none">mc_client:stats()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#command_argument_parsing">Command argument parsing</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.getopt" style="text-decoration:none">apr.getopt()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#http_request_parsing">HTTP request parsing</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.parse_headers" style="text-decoration:none">apr.parse_headers()</a></li>
<li style="float: left; width: 16em"><a href="#apr.parse_multipart" style="text-decoration:none">apr.parse_multipart()</a></li>
<li style="float: left; width: 16em"><a href="#apr.parse_cookie_header" style="text-decoration:none">apr.parse_cookie_header()</a></li>
<li style="float: left; width: 16em"><a href="#apr.parse_query_string" style="text-decoration:none">apr.parse_query_string()</a></li>
<li style="float: left; width: 16em"><a href="#apr.header_attribute" style="text-decoration:none">apr.header_attribute()</a></li>
<li style="float: left; width: 16em"><a href="#apr.uri_encode" style="text-decoration:none">apr.uri_encode()</a></li>
<li style="float: left; width: 16em"><a href="#apr.uri_decode" style="text-decoration:none">apr.uri_decode()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#process_handling">Process handling</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.proc_create" style="text-decoration:none">apr.proc_create()</a></li>
<li style="float: left; width: 16em"><a href="#apr.proc_detach" style="text-decoration:none">apr.proc_detach()</a></li>
<li style="float: left; width: 16em"><a href="#apr.proc_fork" style="text-decoration:none">apr.proc_fork()</a></li>
<li style="float: left; width: 16em"><a href="#process:addrspace_set" style="text-decoration:none">process:addrspace_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:user_set" style="text-decoration:none">process:user_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:group_set" style="text-decoration:none">process:group_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:cmdtype_set" style="text-decoration:none">process:cmdtype_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:env_set" style="text-decoration:none">process:env_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:dir_set" style="text-decoration:none">process:dir_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:detach_set" style="text-decoration:none">process:detach_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:error_check_set" style="text-decoration:none">process:error_check_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:io_set" style="text-decoration:none">process:io_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:in_set" style="text-decoration:none">process:in_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:out_set" style="text-decoration:none">process:out_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:err_set" style="text-decoration:none">process:err_set()</a></li>
<li style="float: left; width: 16em"><a href="#process:in_get" style="text-decoration:none">process:in_get()</a></li>
<li style="float: left; width: 16em"><a href="#process:out_get" style="text-decoration:none">process:out_get()</a></li>
<li style="float: left; width: 16em"><a href="#process:err_get" style="text-decoration:none">process:err_get()</a></li>
<li style="float: left; width: 16em"><a href="#process:exec" style="text-decoration:none">process:exec()</a></li>
<li style="float: left; width: 16em"><a href="#process:wait" style="text-decoration:none">process:wait()</a></li>
<li style="float: left; width: 16em"><a href="#process:kill" style="text-decoration:none">process:kill()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#shared_memory">Shared memory</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.shm_create" style="text-decoration:none">apr.shm_create()</a></li>
<li style="float: left; width: 16em"><a href="#apr.shm_attach" style="text-decoration:none">apr.shm_attach()</a></li>
<li style="float: left; width: 16em"><a href="#apr.shm_remove" style="text-decoration:none">apr.shm_remove()</a></li>
<li style="float: left; width: 16em"><a href="#shm:read" style="text-decoration:none">shm:read()</a></li>
<li style="float: left; width: 16em"><a href="#shm:write" style="text-decoration:none">shm:write()</a></li>
<li style="float: left; width: 16em"><a href="#shm:seek" style="text-decoration:none">shm:seek()</a></li>
<li style="float: left; width: 16em"><a href="#shm:detach" style="text-decoration:none">shm:detach()</a></li>
<li style="float: left; width: 16em"><a href="#shm:destroy" style="text-decoration:none">shm:destroy()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#string_routines">String routines</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.strnatcmp" style="text-decoration:none">apr.strnatcmp()</a></li>
<li style="float: left; width: 16em"><a href="#apr.strnatcasecmp" style="text-decoration:none">apr.strnatcasecmp()</a></li>
<li style="float: left; width: 16em"><a href="#apr.strfsize" style="text-decoration:none">apr.strfsize()</a></li>
<li style="float: left; width: 16em"><a href="#apr.tokenize_to_argv" style="text-decoration:none">apr.tokenize_to_argv()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#multi_threading">Multi threading</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.thread_create" style="text-decoration:none">apr.thread_create()</a></li>
<li style="float: left; width: 16em"><a href="#apr.thread_yield" style="text-decoration:none">apr.thread_yield()</a></li>
<li style="float: left; width: 16em"><a href="#thread:join" style="text-decoration:none">thread:join()</a></li>
<li style="float: left; width: 16em"><a href="#thread:status" style="text-decoration:none">thread:status()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#thread_queues">Thread queues</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.thread_queue" style="text-decoration:none">apr.thread_queue()</a></li>
<li style="float: left; width: 16em"><a href="#queue:push" style="text-decoration:none">queue:push()</a></li>
<li style="float: left; width: 16em"><a href="#queue:pop" style="text-decoration:none">queue:pop()</a></li>
<li style="float: left; width: 16em"><a href="#queue:trypush" style="text-decoration:none">queue:trypush()</a></li>
<li style="float: left; width: 16em"><a href="#queue:trypop" style="text-decoration:none">queue:trypop()</a></li>
<li style="float: left; width: 16em"><a href="#queue:interrupt" style="text-decoration:none">queue:interrupt()</a></li>
<li style="float: left; width: 16em"><a href="#queue:terminate" style="text-decoration:none">queue:terminate()</a></li>
<li style="float: left; width: 16em"><a href="#queue:close" style="text-decoration:none">queue:close()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#time_routines">Time routines</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.sleep" style="text-decoration:none">apr.sleep()</a></li>
<li style="float: left; width: 16em"><a href="#apr.time_now" style="text-decoration:none">apr.time_now()</a></li>
<li style="float: left; width: 16em"><a href="#apr.time_explode" style="text-decoration:none">apr.time_explode()</a></li>
<li style="float: left; width: 16em"><a href="#apr.time_implode" style="text-decoration:none">apr.time_implode()</a></li>
<li style="float: left; width: 16em"><a href="#apr.time_format" style="text-decoration:none">apr.time_format()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#uniform_resource_identifier_parsing">Uniform resource identifier parsing</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.uri_parse" style="text-decoration:none">apr.uri_parse()</a></li>
<li style="float: left; width: 16em"><a href="#apr.uri_unparse" style="text-decoration:none">apr.uri_unparse()</a></li>
<li style="float: left; width: 16em"><a href="#apr.uri_port_of_scheme" style="text-decoration:none">apr.uri_port_of_scheme()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#user_group_identification">User/group identification</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.user_get" style="text-decoration:none">apr.user_get()</a></li>
<li style="float: left; width: 16em"><a href="#apr.user_homepath_get" style="text-decoration:none">apr.user_homepath_get()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#universally_unique_identifiers">Universally unique identifiers</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.uuid_get" style="text-decoration:none">apr.uuid_get()</a></li>
<li style="float: left; width: 16em"><a href="#apr.uuid_format" style="text-decoration:none">apr.uuid_format()</a></li>
<li style="float: left; width: 16em"><a href="#apr.uuid_parse" style="text-decoration:none">apr.uuid_parse()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#character_encoding_translation">Character encoding translation</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.xlate" style="text-decoration:none">apr.xlate()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#xml_parsing">XML parsing</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.xml" style="text-decoration:none">apr.xml()</a></li>
<li style="float: left; width: 16em"><a href="#xml_parser:feed" style="text-decoration:none">xml_parser:feed()</a></li>
<li style="float: left; width: 16em"><a href="#xml_parser:done" style="text-decoration:none">xml_parser:done()</a></li>
<li style="float: left; width: 16em"><a href="#xml_parser:geterror" style="text-decoration:none">xml_parser:geterror()</a></li>
<li style="float: left; width: 16em"><a href="#xml_parser:getinfo" style="text-decoration:none">xml_parser:getinfo()</a></li>
<li style="float: left; width: 16em"><a href="#xml_parser:close" style="text-decoration:none">xml_parser:close()</a></li>
</ul><br style="clear: both"></dd>
<dt style="margin: 1em 0; font-weight: bold"><a href="#miscellaneous_functions">Miscellaneous functions</a></dt>
<dd><ul>
<li style="float: left; width: 16em"><a href="#apr.platform_get" style="text-decoration:none">apr.platform_get()</a></li>
<li style="float: left; width: 16em"><a href="#apr.version_get" style="text-decoration:none">apr.version_get()</a></li>
<li style="float: left; width: 16em"><a href="#apr.os_default_encoding" style="text-decoration:none">apr.os_default_encoding()</a></li>
<li style="float: left; width: 16em"><a href="#apr.os_locale_encoding" style="text-decoration:none">apr.os_locale_encoding()</a></li>
<li style="float: left; width: 16em"><a href="#apr.type" style="text-decoration:none">apr.type()</a></li>
</ul><br style="clear: both"></dd>
<dt style="padding: 1em 0; font-weight: bold">Miscellaneous sections</dt>
<dd><ul>
<li><a href="#file_system_permissions">File system permissions</a></li>
<li><a href="#error_handling">Error handling</a></li>
<li><a href="#example_http_client">Example: HTTP client</a></li>
<li><a href="#example_single_threaded_webserver">Example: Single threaded webserver</a></li>
<li><a href="#example_multi_threaded_webserver">Example: Multi threaded webserver</a></li>
</ul></dd>
</dl>


<h2><a name="base64_encoding" href="#base64_encoding">Base64 encoding</a></h2>

<p>The functions in this module can be used to encode strings in base64 and to
decode base64 encoded strings. The base64 format uses the printable
characters <code>A-Z</code>, <code>a-z</code>, <code>0-9</code>, <code>+</code> and <code>/</code> to encode binary data. This can
be useful when your data is used in a context that isn&rsquo;t 8-bit clean, for
example in e-mail attachments and <a href="http://en.wikipedia.org/wiki/Data_URI_scheme">data:</a> URLs. You can read
more about base64 encoding in <a href="http://en.wikipedia.org/wiki/Base64">this</a> Wikipedia article.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 91%<br></span> <a name="apr.base64_encode" href="#apr.base64_encode"><code>apr.base64_encode(plain) → coded</code></a></h3>

<p>Encode the string <tt><em>plain</em></tt> using base64 encoding. On success the coded string
is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. As an
example, here is how to convert an image file into a <a href="http://en.wikipedia.org/wiki/Data_URI_scheme">data: URL</a>:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;image&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.open" style="color: #0e7c6b; text-decoration: none">io.open</a>&nbsp;<span style="color: #a8660d">'lua-logo.png'</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;encoded_data&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.base64_encode" style="color: #0e7c6b; text-decoration: none">apr.base64_encode</a><span style="color: #2239a8; font-weight: bold">(</span>image<span style="color: #2239a8; font-weight: bold">:</span>read&nbsp;<span style="color: #a8660d">'*a'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;data_url&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'data:image/png;base64,'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;encoded_data<br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'&lt;img&nbsp;src="'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;url&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">'"&nbsp;width=16&nbsp;height=16&nbsp;alt="Lua&nbsp;logo"&gt;'</span><br><span style="color: #2239a8; font-weight: bold">&lt;</span>img&nbsp;src<span style="color: #2239a8; font-weight: bold">=</span><span style="color: #a8660d">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAm5JREFUOMt9k01LW0EUhp+Z5CaxatSbljRioaQgmCIKoUo3XXRRF241tUuhIEgWIgRSKzhtNLZbKf0BulL6C1x234WgoS0otIoWP4Ji48ed3Dtd9CoSW18YBs45z8uZjyOokVKqGQgBzZZlHQshHM/zGqrVaiCRSGyOjOwmhXDngZgxjAUvwLm5uXC5XI5Ho9G98fHxQ2AXVNS3/QFQLBZjdXXuu7MzegCE4IO4CiulfoK6LSUTxvAcaPX9t4Vg0fMoSskbYxj14ysBgN7e3oRSahPepoUwn4FnQONFd11d8cZstvexbUderq0dKCk5iUTEL63lqCgWi3eklE4+fxYWghXg7tU7aWmJsLExRlNTGIC+voWD5eWtDqUcY9v2sXRdtyGfzx9JyataGKCtLXoJA7S3x2JSOhNKqf1yuXxPuq57DGAML/iHVld3WVpaA6BU2mNxce2yNhgMnkrLsgIw2wLEC4Wn1wyMgaGhT9j2ezo7P7K/fwIQB2VXq9VT6XleFIRXC05OPrncM5mHDAykGB19dLXEC4VCASml/A35I2CL/+jkRHN6qkkm7YvQFqhDx3GapNZa+59iIRAQZLM9DA93U6k4DA6miMVukU4n0NrDtusIhQIIwfyFt1BKtaVSqZ1MptQoBF+AJDdrwxjSs7NhEQwGHamU2iqVSg9AHRpDP7B+A7xuDP3GTB2dn5/X53K5ivQH6HuhUOgA9dUYuo3hNbAKaH+tGiMm/uamvk1PT99PpVI7AKJmEpPAtlLqzH9EPy8MwMzMTEJrHfh75Ix7zcA3abUsy9VaG8AGDgEHiNbX1+/lcrnK1fo/txYAMvuVJrYAAAAASUVORK5CYII="</span>&nbsp;width<span style="color: #2239a8; font-weight: bold">=</span><span style="color: #a8660d">16</span>&nbsp;height<span style="color: #2239a8; font-weight: bold">=</span><span style="color: #a8660d">16</span>&nbsp;alt<span style="color: #2239a8; font-weight: bold">=</span><span style="color: #a8660d">"Lua&nbsp;logo"</span><span style="color: #2239a8; font-weight: bold">&gt;</span><br></pre>

<p>This is what the result looks like (might not work in older web browsers):
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAm5JREFUOMt9k01LW0EUhp+Z5CaxatSbljRioaQgmCIKoUo3XXRRF241tUuhIEgWIgRSKzhtNLZbKf0BulL6C1x234WgoS0otIoWP4Ji48ed3Dtd9CoSW18YBs45z8uZjyOokVKqGQgBzZZlHQshHM/zGqrVaiCRSGyOjOwmhXDngZgxjAUvwLm5uXC5XI5Ho9G98fHxQ2AXVNS3/QFQLBZjdXXuu7MzegCE4IO4CiulfoK6LSUTxvAcaPX9t4Vg0fMoSskbYxj14ysBgN7e3oRSahPepoUwn4FnQONFd11d8cZstvexbUderq0dKCk5iUTEL63lqCgWi3eklE4+fxYWghXg7tU7aWmJsLExRlNTGIC+voWD5eWtDqUcY9v2sXRdtyGfzx9JyataGKCtLXoJA7S3x2JSOhNKqf1yuXxPuq57DGAML/iHVld3WVpaA6BU2mNxce2yNhgMnkrLsgIw2wLEC4Wn1wyMgaGhT9j2ezo7P7K/fwIQB2VXq9VT6XleFIRXC05OPrncM5mHDAykGB19dLXEC4VCASml/A35I2CL/+jkRHN6qkkm7YvQFqhDx3GapNZa+59iIRAQZLM9DA93U6k4DA6miMVukU4n0NrDtusIhQIIwfyFt1BKtaVSqZ1MptQoBF+AJDdrwxjSs7NhEQwGHamU2iqVSg9AHRpDP7B+A7xuDP3GTB2dn5/X53K5ivQH6HuhUOgA9dUYuo3hNbAKaH+tGiMm/uamvk1PT99PpVI7AKJmEpPAtlLqzH9EPy8MwMzMTEJrHfh75Ix7zcA3abUsy9VaG8AGDgEHiNbX1+/lcrnK1fo/txYAMvuVJrYAAAAASUVORK5CYII=" width=16 height=16 alt="Lua logo"></p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 83%<br></span> <a name="apr.base64_decode" href="#apr.base64_decode"><code>apr.base64_decode(coded) → plain</code></a></h3>

<p>Decode the base64 encoded string <tt><em>coded</em></tt>. On success the decoded string is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is binary safe.</em></p>

<h2><a name="cryptography_routines" href="#cryptography_routines">Cryptography routines</a></h2>

<p>These functions support the <a href="http://en.wikipedia.org/wiki/MD5">MD5</a> and <a href="http://en.wikipedia.org/wiki/SHA1">SHA1</a> cryptographic hash
functions. You can also use them to encrypt plain text passwords using a
<a href="http://en.wikipedia.org/wiki/Salt_%28cryptography%29">salt</a>, validate plain text passwords against their encrypted, salted
digest and read passwords from standard input while masking the characters
typed by the user.</p>

<p>The MD5 and SHA1 functions can be used to hash binary data. This is useful
because the hash is only 16 or 32 bytes long, yet it still changes
significantly when the binary data changes by just one byte.</p>

<p>If that doesn&rsquo;t look useful consider the following scenario: The Lua authors
have just finished a new release of Lua and are about to publish the source
code on <a href="http://lua.org">http://lua.org</a>. Before they publish the <a href="http://en.wikipedia.org/wiki/Tar_%28file_format%29">tarball</a> they first
calculate its MD5 and SHA1 hashes. They then publish the archive and hashes
on the <a href="http://www.lua.org/ftp/">downloads page</a>. When a user downloads the tarball
they can verify whether it was corrupted or manipulated since it was
published on <a href="http://lua.org">http://lua.org</a> by comparing the published hash against the
hash of the tarball they just downloaded:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;handle&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.open" style="color: #0e7c6b; text-decoration: none">io.open</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'lua-5.1.4.tar.gz'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'rb'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;data&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;handle<span style="color: #2239a8; font-weight: bold">:</span>read<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'*a'</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">;</span>&nbsp;handle<span style="color: #2239a8; font-weight: bold">:</span>close<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.md5" style="color: #0e7c6b; text-decoration: none">apr.md5</a><span style="color: #2239a8; font-weight: bold">(</span>data<span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">==</span>&nbsp;<span style="color: #a8660d">'d0870f2de55d59c1c8419f36e8fac150'</span><br><span style="color: #a8660d">true</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.sha1" style="color: #0e7c6b; text-decoration: none">apr.sha1</a><span style="color: #2239a8; font-weight: bold">(</span>data<span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">==</span>&nbsp;<span style="color: #a8660d">'2b11c8e60306efb7f0734b747588f57995493db7'</span><br><span style="color: #a8660d">true</span><br></pre>

<h3><a name="apr.md5" href="#apr.md5"><code>apr.md5(input [, binary]) → digest</code></a></h3>

<p>Calculate the <a href="http://en.wikipedia.org/wiki/MD5">MD5</a> message digest of the string <tt><em>input</em></tt>. On success
the digest is returned as a string of 32 hexadecimal characters, or a string
of 16 bytes if <tt><em>binary</em></tt> evaluates to <tt><em>true</em></tt>. Otherwise a <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.md5_encode" href="#apr.md5_encode"><code>apr.md5_encode(password, salt) → digest</code></a></h3>

<p>Encode the string <tt><em>password</em></tt> using the <a href="http://en.wikipedia.org/wiki/MD5">MD5</a> algorithm and a <a href="http://en.wikipedia.org/wiki/Salt_%28cryptography%29">salt</a> string. On success the digest is returned, otherwise a <tt><em>nil</em></tt> followed
by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.password_validate" href="#apr.password_validate"><code>apr.password_validate(password, digest) → valid</code></a></h3>

<p>Validate the string <tt><em>password</em></tt> against a <tt><em>digest</em></tt> created by one of the
APR-supported algorithms (<a href="http://en.wikipedia.org/wiki/MD5">MD5</a> and <a href="http://en.wikipedia.org/wiki/SHA1">SHA1</a>). On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>Hashes created by crypt are supported only on platforms that provide
<a href="http://linux.die.net/man/3/crypt">crypt(3)</a>, so don&rsquo;t rely on that function unless you know that
your application will be run only on platforms that support it. On platforms
that don&rsquo;t support crypt(3), this falls back to a clear text string
comparison.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="apr.password_get" href="#apr.password_get"><code>apr.password_get(prompt) → password</code></a></h3>

<p>Display the string <tt><em>prompt</em></tt> on the command-line prompt and read in a password
from standard input. If your platform allows it, the typed password will be
masked by a placeholder like <code>*</code>. On success the password is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 75%<br></span> <a name="apr.md5_init" href="#apr.md5_init"><code>apr.md5_init() → md5_context</code></a></h3>

<p>Create and return an object that can be used to calculate <a href="http://en.wikipedia.org/wiki/MD5">MD5</a>
message digests in steps. If an error occurs a <tt><em>nil</em></tt> followed by an error
message is returned. This can be useful when you want to calculate message
digests of large inputs, for example files like <a href="http://en.wikipedia.org/wiki/ISO_image">ISO images</a> and
backups:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">function</span>&nbsp;md5_file<span style="color: #2239a8; font-weight: bold">(</span>path<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;binary<span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;handle&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.open" style="color: #0e7c6b; text-decoration: none">io.open</a><span style="color: #2239a8; font-weight: bold">(</span>path<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'rb'</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;context&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.md5_init" style="color: #0e7c6b; text-decoration: none">apr.md5_init</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">while</span>&nbsp;<span style="color: #a8660d">true</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;block&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;handle<span style="color: #2239a8; font-weight: bold">:</span>read<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">1024</span>&nbsp;<span style="color: #2239a8; font-weight: bold">*</span>&nbsp;<span style="color: #a8660d">1024</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;<span style="color: #2239a8; font-weight: bold">not</span>&nbsp;block&nbsp;<span style="color: #2239a8; font-weight: bold">then</span>&nbsp;<span style="color: #2239a8; font-weight: bold">break</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>context<span style="color: #2239a8; font-weight: bold">:</span>update<span style="color: #2239a8; font-weight: bold">(</span>block<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">return</span>&nbsp;context<span style="color: #2239a8; font-weight: bold">:</span>digest<span style="color: #2239a8; font-weight: bold">(</span>binary<span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;md5_file&nbsp;<span style="color: #a8660d">'ubuntu-10.04-desktop-i386.iso'</span><br><span style="color: #a8660d">'d044a2a0c8103fc3e5b7e18b0f7de1c8'</span><br></pre>

<h3><a name="md5_context:update" href="#md5_context:update"><code>md5_context:update(input) → status</code></a></h3>

<p>Continue an <a href="http://en.wikipedia.org/wiki/MD5">MD5</a> message digest operation by processing another
message block and updating the context. On success <tt><em>true</em></tt> is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is binary safe.</em></p>

<h3><a name="md5_context:digest" href="#md5_context:digest"><code>md5_context:digest([binary]) → digest</code></a></h3>

<p>End an <a href="http://en.wikipedia.org/wiki/MD5">MD5</a> message digest operation. On success the digest is
returned as a string of 32 hexadecimal characters, or a string of 16 bytes
if <tt><em>binary</em></tt> evaluates to <tt><em>true</em></tt>. Otherwise a <tt><em>nil</em></tt> followed by an error message
is returned.</p>

<p>If you want to re-use the context object after calling this method
see <a href="#md5_context:reset">md5_context:reset()</a>.</p>

<h3><a name="md5_context:reset" href="#md5_context:reset"><code>md5_context:reset() → status</code></a></h3>

<p>Use this method to reset the context after calling <a href="#md5_context:digest">md5_context:digest()</a>.
This enables you to re-use the same context to perform another message
digest calculation. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by
an error message is returned.</p>

<h3><a name="apr.sha1" href="#apr.sha1"><code>apr.sha1(input [, binary]) → digest</code></a></h3>

<p>Calculate the <a href="http://en.wikipedia.org/wiki/SHA1">SHA1</a> message digest of the string <tt><em>input</em></tt>. On success
the digest is returned as a string of 40 hexadecimal characters, or a string
of 20 bytes if <tt><em>binary</em></tt> evaluates to <tt><em>true</em></tt>. Otherwise a <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 83%<br></span> <a name="apr.sha1_init" href="#apr.sha1_init"><code>apr.sha1_init() → sha1_context</code></a></h3>

<p>Create and return an object that can be used to calculate <a href="http://en.wikipedia.org/wiki/SHA1">SHA1</a>
message digests in steps. See also the example for <a href="#apr.md5_init">apr.md5_init()</a>.</p>

<h3><a name="sha1_context:update" href="#sha1_context:update"><code>sha1_context:update(input) → status</code></a></h3>

<p>Continue an <a href="http://en.wikipedia.org/wiki/SHA1">SHA1</a> message digest operation by processing another
message block and updating the context.</p>

<p><em>This function is binary safe.</em></p>

<h3><a name="sha1_context:digest" href="#sha1_context:digest"><code>sha1_context:digest([binary]) → digest</code></a></h3>

<p>End an <a href="http://en.wikipedia.org/wiki/SHA1">SHA1</a> message digest operation. On success the digest is
returned as a string of 40 hexadecimal characters, or a string of 20 bytes
if <tt><em>binary</em></tt> evaluates to <tt><em>true</em></tt>. Otherwise a <tt><em>nil</em></tt> followed by an error message
is returned.</p>

<p>If you want to re-use the context object after calling this method
see <a href="#sha1_context:reset">sha1_context:reset()</a>.</p>

<h3><a name="sha1_context:reset" href="#sha1_context:reset"><code>sha1_context:reset() → status</code></a></h3>

<p>Use this method to reset the context after calling <a href="#sha1_context:digest">sha1_context:digest()</a>.
This enables you to re-use the same context to perform another message
digest calculation.</p>

<h2><a name="date_parsing" href="#date_parsing">Date parsing</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 85%<br></span> <a name="apr.date_parse_http" href="#apr.date_parse_http"><code>apr.date_parse_http(string) → time</code></a></h3>

<p>Parses an <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a> date in one of three standard forms:</p>

<ul>
<li><code>'Sun, 06 Nov 1994 08:49:37 GMT'</code> &ndash; <a href="http://tools.ietf.org/html/rfc822">RFC 822</a>, updated by <a href="http://tools.ietf.org/html/rfc1123">RFC 1123</a></li>
<li><code>'Sunday, 06-Nov-94 08:49:37 GMT'</code> &ndash; <a href="http://tools.ietf.org/html/rfc850">RFC 850</a>, obsoleted by <a href="http://tools.ietf.org/html/rfc1036">RFC 1036</a></li>
<li><code>'Sun Nov  6 08:49:37 1994'</code> &ndash; ANSI C&rsquo;s <a href="http://linux.die.net/man/3/asctime">asctime()</a> format</li>
</ul>


<p>On success the date is returned as a number like documented under <a href="#time_routines">time
routines</a>. If the date string is out of range or invalid <tt><em>nil</em></tt>
is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 85%<br></span> <a name="apr.date_parse_rfc" href="#apr.date_parse_rfc"><code>apr.date_parse_rfc(string) → time</code></a></h3>

<p>Parses a string resembling an <a href="http://tools.ietf.org/html/rfc822">RFC 822</a> date. This is meant to be
lenient in its parsing of dates and hence will parse a wider range of dates
than <a href="#apr.date_parse_http">apr.date_parse_http()</a>.</p>

<p>The prominent mailer (or poster, if mailer is unknown) that has been seen in
the wild is included for the unknown formats:</p>

<ul>
<li><code>'Sun, 06 Nov 1994 08:49:37 GMT'</code> &ndash; <a href="http://tools.ietf.org/html/rfc822">RFC 822</a>, updated by <a href="http://tools.ietf.org/html/rfc1123">RFC 1123</a></li>
<li><code>'Sunday, 06-Nov-94 08:49:37 GMT'</code> &ndash; <a href="http://tools.ietf.org/html/rfc850">RFC 850</a>, obsoleted by <a href="http://tools.ietf.org/html/rfc1036">RFC 1036</a></li>
<li><code>'Sun Nov  6 08:49:37 1994'</code> &ndash; ANSI C&rsquo;s <a href="http://linux.die.net/man/3/asctime">asctime()</a> format</li>
<li><code>'Sun, 6 Nov 1994 08:49:37 GMT'</code> &ndash; <a href="http://tools.ietf.org/html/rfc822">RFC 822</a>, updated by <a href="http://tools.ietf.org/html/rfc1123">RFC 1123</a></li>
<li><code>'Sun, 06 Nov 94 08:49:37 GMT'</code> &ndash; <a href="http://tools.ietf.org/html/rfc822">RFC 822</a></li>
<li><code>'Sun, 6 Nov 94 08:49:37 GMT'</code> &ndash; <a href="http://tools.ietf.org/html/rfc822">RFC 822</a></li>
<li><code>'Sun, 06 Nov 94 08:49 GMT'</code> &ndash; Unknown [drtr@ast.cam.ac.uk]</li>
<li><code>'Sun, 6 Nov 94 08:49 GMT'</code> &ndash; Unknown [drtr@ast.cam.ac.uk]</li>
<li><code>'Sun, 06 Nov 94 8:49:37 GMT'</code> &ndash; Unknown [Elm 70.85]</li>
<li><code>'Sun, 6 Nov 94 8:49:37 GMT'</code> &ndash; Unknown [Elm 70.85]</li>
</ul>


<p>On success the date is returned as a number like documented under <a href="#time_routines">time
routines</a>. If the date string is out of range or invalid <tt><em>nil</em></tt>
is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h2><a name="relational_database_drivers" href="#relational_database_drivers">Relational database drivers</a></h2>

<p>The APR DBD module makes it possible to query relational database engines
like <a href="http://en.wikipedia.org/wiki/SQLite">SQLite</a>, <a href="http://en.wikipedia.org/wiki/MySQL">MySQL</a>, <a href="http://en.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a>, <a href="http://en.wikipedia.org/wiki/Oracle_Database">Oracle</a>, <a href="http://en.wikipedia.org/wiki/ODBC">ODBC</a> and <a href="http://en.wikipedia.org/wiki/FreeTDS">FreeTDS</a>. This module currently has
some drawbacks which appear to be unavoidable given the design of the Apache
Portable Runtime DBD framework:</p>

<ul>
<li><p>Booleans and numbers are returned as strings because result set types are
not known to the Lua/APR binding (and type guessing is too error prone)</p></li>
<li><p>String arguments and results are not binary safe, this means they will
be truncated at the first zero byte (see the <a href="http://apr.apache.org/mailing-lists.html">apr-dev mailing list</a> thread <a href="http://marc.info/?l=apr-dev&amp;m=114969441721086&amp;w=2">&ldquo;current dbd initiatives&rdquo;</a> for
discussion about this limitation of APR)</p></li>
</ul>


<p>Note that if you control the data going into the database you can overcome
the second limitation by using APR&rsquo;s built in support for
<a href="#base64_encoding">Base64 encoding</a>.</p>

<h3>Installing drivers</h3>

<p>On Debian/Ubuntu Linux you can install one or more of the following packages
to enable support for the corresponding database driver (dependencies will
be installed automatically by the package management system):</p>

<ul>
<li><a href="http://packages.ubuntu.com/lucid/libaprutil1-dbd-sqlite3">libaprutil1-dbd-sqlite3</a></li>
<li><a href="http://packages.ubuntu.com/lucid/libaprutil1-dbd-mysql">libaprutil1-dbd-mysql</a></li>
<li><a href="http://packages.ubuntu.com/lucid/libaprutil1-dbd-pgsql">libaprutil1-dbd-pgsql</a></li>
<li><a href="http://packages.ubuntu.com/lucid/libaprutil1-dbd-odbc">libaprutil1-dbd-odbc</a></li>
<li><a href="http://packages.ubuntu.com/lucid/libaprutil1-dbd-freetds">libaprutil1-dbd-freetds</a></li>
</ul>


<h3>Debugging &ldquo;DSO load failed&rdquo; errors</h3>

<p>In my initial tests on Ubuntu I installed <a href="http://packages.ubuntu.com/lucid/libaprutil1-dbd-sqlite3">libaprutil1-dbd-sqlite3</a> but kept getting an error when trying to load the driver:</p>

<pre style="color: black; background: white" class="sourcecode lua">$&nbsp;lua&nbsp;<span style="color: #2239a8; font-weight: bold">-</span>e&nbsp;<span style="color: #a8660d">"print(require('apr').dbd('sqlite3'))"</span><br><span style="color: #a8660d">nil</span>&nbsp;&nbsp;DSO&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-load" style="color: #0e7c6b; text-decoration: none">load</a>&nbsp;failed&nbsp;&nbsp;EDSOOPEN<br></pre>

<p>After a while I found the problem using <a href="http://www.wlug.org.nz/LD_DEBUG">LD_DEBUG</a>:</p>

<pre style="color: black; background: white" class="sourcecode lua">$&nbsp;LD_DEBUG<span style="color: #2239a8; font-weight: bold">=</span>libs&nbsp;lua&nbsp;<span style="color: #2239a8; font-weight: bold">-</span>e&nbsp;<span style="color: #a8660d">"require('apr').dbd('sqlite3')"</span>&nbsp;<span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&amp;<span style="color: #a8660d">1</span>&nbsp;|&nbsp;grep&nbsp;undefined<br><span style="color: #2239a8; font-weight: bold">/</span>usr<span style="color: #2239a8; font-weight: bold">/</span>lib<span style="color: #2239a8; font-weight: bold">/</span>apr<span style="color: #2239a8; font-weight: bold">-</span>util<span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">/</span>apr_dbd_sqlite3<span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">1.</span>so<span style="color: #2239a8; font-weight: bold">:</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-error" style="color: #0e7c6b; text-decoration: none">error</a><span style="color: #2239a8; font-weight: bold">:</span>&nbsp;symbol&nbsp;lookup&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-error" style="color: #0e7c6b; text-decoration: none">error</a><span style="color: #2239a8; font-weight: bold">:</span>&nbsp;undefined&nbsp;symbol<span style="color: #2239a8; font-weight: bold">:</span>&nbsp;apr_pool_cleanup_null&nbsp;<span style="color: #2239a8; font-weight: bold">(</span>fatal<span style="color: #2239a8; font-weight: bold">)</span><br></pre>

<p>Having identified the problem, finding a workaround was easy:</p>

<pre style="color: black; background: white" class="sourcecode lua">$&nbsp;export&nbsp;LD_PRELOAD<span style="color: #2239a8; font-weight: bold">=</span><span style="color: #a8660d">'/usr/lib/libapr-1.so.0:/usr/lib/libaprutil-1.so.0'</span><br>$&nbsp;lua&nbsp;<span style="color: #2239a8; font-weight: bold">-</span>e&nbsp;<span style="color: #a8660d">"print(require('apr').dbd('sqlite3'))"</span><br>database&nbsp;driver&nbsp;<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">0x853bdfc</span><span style="color: #2239a8; font-weight: bold">)</span><br></pre>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 77%<br></span> <a name="apr.dbd" href="#apr.dbd"><code>apr.dbd(name) → driver</code></a></h3>

<p>Create a database driver object. The string <tt><em>name</em></tt> decides which database
engine to use. On success the driver object is returned, otherwise a <tt><em>nil</em></tt>
followed by an error message is returned. Currently supported engines
include:</p>

<ul>
<li><code>'mysql'</code></li>
<li><code>'pgsql'</code></li>
<li><code>'sqlite3'</code></li>
<li><code>'sqlite2'</code></li>
<li><code>'oracle'</code></li>
<li><code>'freetds'</code></li>
<li><code>'odbc'</code></li>
</ul>


<p>Note that in its default configuration the Apache Portable Runtime uses
dynamic loading to load database drivers which means <a href="#apr.dbd">apr.dbd()</a> can fail
because a driver can&rsquo;t be loaded.</p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 50%<br></span> <a name="driver:open" href="#driver:open"><code>driver:open(params) → status</code></a></h3>

<p>Open a connection to a backend. The string <tt><em>params</em></tt> contains the arguments to
the driver (implementation-dependent). On success <tt><em>true</em></tt> is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned. The syntax of
<tt><em>params</em></tt> is as follows:</p>

<ul>
<li><p><strong>PostgreSQL:</strong> <tt><em>params</em></tt> is passed directly to the <a href="http://www.postgresql.org/docs/current/interactive/libpq-connect.html#LIBPQ-PQCONNECTDB">PQconnectdb()</a> function, check the PostgreSQL documentation for more
details on the syntax</p></li>
<li><p><strong>SQLite2:</strong> <tt><em>params</em></tt> is split on a colon, with the first part used as the
filename and the second part converted to an integer and used as the file
mode</p></li>
<li><p><strong>SQLite3:</strong> <tt><em>params</em></tt> is passed directly to the <a href="http://www.sqlite.org/c3ref/open.html">sqlite3_open()</a> function as a filename to be opened, check the SQLite3
documentation for more details (hint: if <tt><em>params</em></tt> is <code>':memory:'</code> a
private, temporary in-memory database is created for the connection)</p></li>
<li><p><strong>Oracle:</strong> <tt><em>params</em></tt> can have &lsquo;user&rsquo;, &lsquo;pass&rsquo;, &lsquo;dbname&rsquo; and &lsquo;server&rsquo; keys,
each followed by an equal sign and a value. Such key/value pairs can be
delimited by space, CR, LF, tab, semicolon, vertical bar or comma</p></li>
<li><p><strong>MySQL:</strong> <tt><em>params</em></tt> can have &lsquo;host&rsquo;, &lsquo;port&rsquo;, &lsquo;user&rsquo;, &lsquo;pass&rsquo;, &lsquo;dbname&rsquo;,
&lsquo;sock&rsquo;, &lsquo;flags&rsquo; &lsquo;fldsz&rsquo;, &lsquo;group&rsquo; and &lsquo;reconnect&rsquo; keys, each followed by
an equal sign and a value. Such key/value pairs can be delimited by
space, CR, LF, tab, semicolon, vertical bar or comma. For now, &lsquo;flags&rsquo;
can only recognize <code>CLIENT_FOUND_ROWS</code> (check MySQL manual for details).
The value associated with &lsquo;fldsz&rsquo; determines maximum amount of memory (in
bytes) for each of the fields in the result set of prepared statements.
By default, this value is 1 MB. The value associated with &lsquo;group&rsquo;
determines which group from configuration file to use (see
<code>MYSQL_READ_DEFAULT_GROUP</code> option of <a href="http://dev.mysql.com/doc/refman/5.5/en/mysql-options.html">mysql_options()</a> in
MySQL manual). Reconnect is set to 1 by default (i.e. <tt><em>true</em></tt>)</p></li>
<li><p><strong>FreeTDS:</strong> <tt><em>params</em></tt> can have &lsquo;username&rsquo;, &lsquo;password&rsquo;, &lsquo;appname&rsquo;,
&lsquo;dbname&rsquo;, &lsquo;host&rsquo;, &lsquo;charset&rsquo;, &lsquo;lang&rsquo; and &lsquo;server&rsquo; keys, each followed by
an equal sign and a value</p></li>
</ul>


<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="driver:dbname" href="#driver:dbname"><code>driver:dbname(name) → status</code></a></h3>

<p>Select the database <tt><em>name</em></tt>. On succes <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt>
followed by an error message is returned. Not supported for all drivers
(e.g. SQLite by definition only knows a single database).</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="driver:driver" href="#driver:driver"><code>driver:driver() → name</code></a></h3>

<p>Get the name of the database driver. Returns one of the strings listed for
<a href="#apr.dbd">apr.dbd()</a>.</p>

<h3><a name="driver:check" href="#driver:check"><code>driver:check() → status</code></a></h3>

<p>Check the status of the database connection. When the connection is still
alive <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="driver:query" href="#driver:query"><code>driver:query(sql) → status, affected_rows</code></a></h3>

<p>Execute an SQL query that doesn&rsquo;t return a result set. On success <tt><em>true</em></tt>
followed by the number of affected rows is returned, otherwise a <tt><em>nil</em></tt>
followed by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 88%<br></span> <a name="driver:select" href="#driver:select"><code>driver:select(sql [, random_access]) → result_set</code></a></h3>

<p>Execute an SQL query that returns a result set. On success a result set
object is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned. To enable support for random access you can pass the optional
argument <tt><em>random_access</em></tt> as <tt><em>true</em></tt>.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="driver:transaction_start" href="#driver:transaction_start"><code>driver:transaction_start() → status</code></a></h3>

<p>Start a transaction. May be a no-op. On success <tt><em>true</em></tt> is returned, otherwise
a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>Note that transaction modes, set by calling <a href="#driver:transaction_mode">driver:transaction_mode()</a>,
will affect all query/select calls within a transaction. By default, any
error in query/select during a transaction will cause the transaction to
inherit the error code and any further query/select calls will fail
immediately. Put transaction in <code>'ignore-errors'</code> mode to avoid that. Use
<code>'rollback'</code> mode to do explicit rollback.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="driver:transaction_end" href="#driver:transaction_end"><code>driver:transaction_end() → status</code></a></h3>

<p>End a transaction (commit on success, rollback on error). May be a no-op. On
success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 84%<br></span> <a name="driver:transaction_mode" href="#driver:transaction_mode"><code>driver:transaction_mode([mode]) → mode</code></a></h3>

<p>Get or set the transaction mode, one of:</p>

<ul>
<li><code>'commit'</code>: commit the transaction</li>
<li><code>'rollback'</code>: rollback the transaction</li>
<li><code>'ignore-errors'</code>: ignore transaction errors</li>
</ul>


<p>On success the new transaction mode is returned, otherwise a <tt><em>nil</em></tt> followed by
an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 87%<br></span> <a name="driver:prepare" href="#driver:prepare"><code>driver:prepare(sql) → prepared_statement</code></a></h3>

<p>Prepare a statement. On success a prepared statement object is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>To specify parameters of the prepared query, use <code>%s</code>, <code>%d</code> etc. (see below
for full list) in place of database specific parameter syntax (e.g. for
PostgreSQL, this would be <code>$1</code>, <code>$2</code>, for SQLite3 this would be <code>?</code>, etc.).
For instance: <code>SELECT name FROM customers WHERE name = %s</code> would be a query
that this function understands. Here is the list of supported format
specifiers and what they map to in SQL (generally you'll only need the types
marked in bold text):</p>

<ul>
<li><code>%hhd</code>: TINY INT</li>
<li><code>%hhu</code>: UNSIGNED TINY INT</li>
<li><code>%hd</code>: SHORT</li>
<li><code>%hu</code>: UNSIGNED SHORT</li>
<li><strong><code>%d</code>: INT</strong></li>
<li><strong><code>%u</code>: UNSIGNED INT</strong></li>
<li><code>%ld</code>: LONG</li>
<li><code>%lu</code>: UNSIGNED LONG</li>
<li><code>%lld</code>: LONG LONG</li>
<li><code>%llu</code>: UNSIGNED LONG LONG</li>
<li><strong><code>%f</code>: FLOAT, REAL</strong></li>
<li><strong><code>%lf</code>: DOUBLE PRECISION</strong></li>
<li><strong><code>%s</code>: VARCHAR</strong></li>
<li><strong><code>%pDt</code>: TEXT</strong></li>
<li><code>%pDi</code>: TIME</li>
<li><code>%pDd</code>: DATE</li>
<li><code>%pDa</code>: DATETIME</li>
<li><code>%pDs</code>: TIMESTAMP</li>
<li><code>%pDz</code>: TIMESTAMP WITH TIME ZONE</li>
<li><code>%pDn</code>: NULL</li>
</ul>


<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="prepared_statement:query" href="#prepared_statement:query"><code>prepared_statement:query(...) → status</code></a></h3>

<p>Using a prepared statement, execute an SQL query that doesn&rsquo;t return a
result set. On success <tt><em>true</em></tt> followed by the number of affected rows is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>If you pass a list then the values in the list become query parameters,
otherwise all function arguments become query parameters.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="prepared_statement:select" href="#prepared_statement:select"><code>prepared_statement:select(random_access, ...) → result_set</code></a></h3>

<p>Using a prepared statement, execute an SQL query that returns a result set.
On success a result set object is returned, otherwise a <tt><em>nil</em></tt> followed by an
error message is returned. To enable support for random access pass
<tt><em>random_access</em></tt> as <tt><em>true</em></tt>, otherwise pass it as <tt><em>false</em></tt>.</p>

<p>If you pass a list then the values in the list become query parameters,
otherwise all function arguments after <tt><em>random_access</em></tt> become query
parameters.</p>

<p>TODO Make the <tt><em>random_access</em></tt> argument an attribute of the prepared
statement object so that we can get rid of the argument here?!</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="result_set:columns" href="#result_set:columns"><code>result_set:columns([num]) → name [, ...]</code></a></h3>

<p>If no arguments are given return the names of all columns in the result set,
otherwise return the name of the column with index <tt><em>num</em></tt> (counting from one).
For example:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;driver&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>apr.dbd&nbsp;<span style="color: #a8660d">'sqlite3'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>driver<span style="color: #2239a8; font-weight: bold">:</span>open&nbsp;<span style="color: #a8660d">':memory:'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;results&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>driver<span style="color: #2239a8; font-weight: bold">:</span><a href="http://www.lua.org/manual/5.1/manual.html#pdf-select" style="color: #0e7c6b; text-decoration: none">select</a>&nbsp;[[&nbsp;SELECT&nbsp;1&nbsp;AS&nbsp;col1,&nbsp;2&nbsp;AS&nbsp;col2&nbsp;]]<span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>results<span style="color: #2239a8; font-weight: bold">:</span>columns<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">{</span>&nbsp;<span style="color: #a8660d">'col1'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'col2'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">}</span><br></pre>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="result_set:row" href="#result_set:row"><code>result_set:row(num) → row</code></a></h3>

<p>Return a table with named fields for the next row in the result set or the
row with index <tt><em>rownum</em></tt> if given. When there are no more rows nothing is
returned, in case of an error a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="result_set:rows" href="#result_set:rows"><code>result_set:rows() → iterator</code></a></h3>

<p>Return an iterator that produces a table with named fields for each
(remaining) row in the result set.</p>

<p>In Lua 5.2 you can also use <code>pairs(result_set)</code>.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="result_set:tuple" href="#result_set:tuple"><code>result_set:tuple([rownum]) → value [, ...]</code></a></h3>

<p>Return a tuple for the next row in the result set or the row with index
<tt><em>rownum</em></tt> if given. If more than one value is returned, the return values will
be in the same order as the column list in the SQL query. When there are no
more rows nothing is returned, in case of an error a <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="result_set:tuples" href="#result_set:tuples"><code>result_set:tuples() → iterator</code></a></h3>

<p>Return an iterator that produces a tuple for each (remaining) row in the
result set. The tuples produced by the iterator are in the same order as the
column list in the SQL query, for example:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;driver&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>apr.dbd&nbsp;<span style="color: #a8660d">'sqlite3'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>driver<span style="color: #2239a8; font-weight: bold">:</span>open&nbsp;<span style="color: #a8660d">'quotes.sqlite3'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;results&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>driver<span style="color: #2239a8; font-weight: bold">:</span><a href="http://www.lua.org/manual/5.1/manual.html#pdf-select" style="color: #0e7c6b; text-decoration: none">select</a>&nbsp;[[&nbsp;SELECT&nbsp;author,&nbsp;quote&nbsp;FROM&nbsp;quotes&nbsp;]]<span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">for</span>&nbsp;author<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;quote&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;results<span style="color: #2239a8; font-weight: bold">:</span>tuples<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span>author<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'wrote:'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span>quote<span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br></pre>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="result_set:pairs" href="#result_set:pairs"><code>result_set:pairs() → iterator</code></a></h3>

<p>Return an iterator that produces a row number and a table with named fields
for each (remaining) row in the result set.</p>

<p>In Lua 5.2 you can also use <code>ipairs(result_set)</code>.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="result_set:__len" href="#result_set:__len"><code>#result_set → num_tuples</code></a></h3>

<p>Get the number of rows in a result set of a synchronous select. If the
results are asynchronous -1 is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="driver:close" href="#driver:close"><code>driver:close() → status</code></a></h3>

<p>Close a connection to a backend.</p>

<h2><a name="dbm_routines" href="#dbm_routines">DBM routines</a></h2>

<p>This module enables the creation and manipulation of <a href="http://en.wikipedia.org/wiki/dbm">dbm</a> databases.
If you've never heard of dbm before you can think of it as a Lua table that
only supports string keys and values but is backed by a file, so that you
can stop and restart your application and find the exact same contents.
This module supports the following libraries/implementations:</p>

<ul>
<li><code>'db'</code> for <a href="http://en.wikipedia.org/wiki/Berkeley_DB">Berkeley DB</a> files</li>
<li><code>'gdbm'</code> for GDBM files</li>
<li><code>'ndbm'</code> for NDBM files</li>
<li><code>'sdbm'</code> for SDBM files (the default)</li>
</ul>


<p>The SDBM format is the default database format for Lua/APR because APR has
built-in support for SDBM while the other libraries need to be separately
installed. This is why not all types may be available at run time.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 87%<br></span> <a name="apr.dbm_open" href="#apr.dbm_open"><code>apr.dbm_open(path [, mode [, permissions [, type ]]]) → dbm object</code></a></h3>

<p>Open a <a href="http://en.wikipedia.org/wiki/dbm">dbm</a> file by <tt><em>path</em></tt>. On success a database object is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned. The following
<tt><em>mode</em></tt> strings are supported:</p>

<ul>
<li><code>'r'</code> to open an existing database for reading only (this is the default)</li>
<li><code>'w'</code> to open an existing database for reading and writing</li>
<li><code>'c'</code> to open a database for reading and writing, creating it if it
doesn&rsquo;t exist</li>
<li><code>'n'</code> to open a database for reading and writing, truncating it if it
already exists</li>
</ul>


<p>The <a href="#file_system_permissions">permissions</a> string is documented elsewhere. Valid values for <tt><em>type</em></tt> are
listed in the introductory text for this module. Also note that the <tt><em>path</em></tt>
string may not be a real file name, as many <a href="http://en.wikipedia.org/wiki/dbm">dbm</a> packages append
suffixes for separate data and index files (see also
<a href="#apr.dbm_getnames">apr.dbm_getnames()</a>).</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 84%<br></span> <a name="apr.dbm_getnames" href="#apr.dbm_getnames"><code>apr.dbm_getnames(path [, type]) → used1 [, used2]</code></a></h3>

<p>If the specified <tt><em>path</em></tt> were passed to <a href="#apr.dbm_open">apr.dbm_open()</a>, return the actual
pathnames which would be (created and) used. At most, two files may be used;
<tt><em>used2</em></tt> is <tt><em>nil</em></tt> if only one file is used. The <a href="http://en.wikipedia.org/wiki/dbm">dbm</a> file(s) don&rsquo;t need
to exist because this function only manipulates the pathnames. Valid values
for <tt><em>type</em></tt> are listed in the introductory text for this module.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="dbm:exists" href="#dbm:exists"><code>dbm:exists(key) → status</code></a></h3>

<p>Check whether the <a href="http://en.wikipedia.org/wiki/dbm">dbm</a> record with the given string <tt><em>key</em></tt> exists.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="dbm:fetch" href="#dbm:fetch"><code>dbm:fetch(key) → value</code></a></h3>

<p>Fetch the <a href="http://en.wikipedia.org/wiki/dbm">dbm</a> record with the given string <tt><em>key</em></tt>. On success the
fetched value is returned as a string, if the key doesn&rsquo;t exist nothing is
returned and on error a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="dbm:store" href="#dbm:store"><code>dbm:store(key, value) → status</code></a></h3>

<p>Store the <a href="http://en.wikipedia.org/wiki/dbm">dbm</a> record <tt><em>value</em></tt> (a string) by the given string <tt><em>key</em></tt>. On
success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="dbm:delete" href="#dbm:delete"><code>dbm:delete(key) → status</code></a></h3>

<p>Delete the <a href="http://en.wikipedia.org/wiki/dbm">dbm</a> record with the given string <tt><em>key</em></tt>. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 88%<br></span> <a name="dbm:firstkey" href="#dbm:firstkey"><code>dbm:firstkey() → key</code></a></h3>

<p>Retrieve the first record key from a <a href="http://en.wikipedia.org/wiki/dbm">dbm</a>. On success the first key
is returned as a string, when there are no keys nothing is returned. In case
of error a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 70%<br></span> <a name="dbm:nextkey" href="#dbm:nextkey"><code>dbm:nextkey(key1) → key2</code></a></h3>

<p>Retrieve the next record key from a <a href="http://en.wikipedia.org/wiki/dbm">dbm</a>. This function works just
like Lua&rsquo;s <a href="http://www.lua.org/manual/5.1/manual.html#pdf-next">next()</a> function: On success the next key is returned as a
string, when there are no more keys nothing is returned. In case of error a
<tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="dbm:close" href="#dbm:close"><code>dbm:close() → status</code></a></h3>

<p>Close a <a href="http://en.wikipedia.org/wiki/dbm">dbm</a> database handle and return <tt><em>true</em></tt> (this can&rsquo;t fail).</p>

<h2><a name="environment_manipulation" href="#environment_manipulation">Environment manipulation</a></h2>

<p>Operating systems organize tasks into processes. One of the simplest means
of communication between processes is the use of environment variables. If
you're not familiar with environment variables, picture every process on
your computer having an associated Lua table with string key/value pairs.
When a process creates or overwrites a key/value pair only the table of that
process changes. When the process spawns a child process the child gets a
copy of the table which from that point onwards is no longer associated with
the parent process.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.env_get" href="#apr.env_get"><code>apr.env_get(name) → value</code></a></h3>

<p>Get the value of the environment variable <tt><em>name</em></tt>. On success the string value
is returned. If the variable does not exist nothing is returned. Otherwise a
<tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.env_set" href="#apr.env_set"><code>apr.env_set(name, value) → status</code></a></h3>

<p>Set the value of the environment variable <tt><em>name</em></tt> to the string <tt><em>value</em></tt>. On
success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.env_delete" href="#apr.env_delete"><code>apr.env_delete(name) → status</code></a></h3>

<p>Delete the environment variable <tt><em>name</em></tt>. On success <tt><em>true</em></tt> is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h2><a name="file_path_manipulation" href="#file_path_manipulation">File path manipulation</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.filepath_root" href="#apr.filepath_root"><code>apr.filepath_root(path [, option, ...]) → root, path</code></a></h3>

<p>Extract the root from the file path <tt><em>path</em></tt>. On success the extracted root and
the relative path following the root are returned, otherwise a <tt><em>nil</em></tt> followed
by an error message is returned. Either or both of the following options may
be given after <tt><em>path</em></tt>:</p>

<ul>
<li><code>'true-name'</code> verifies that the root exists and resolves its <tt><em>true</em></tt> case.
If the root does not exist, a <tt><em>nil</em></tt> followed by an error message is
returned</li>
<li><code>'native'</code> uses the file system&rsquo;s native path format (e.g. path delimiters
of <code>:</code> on MacOS9, <code>\</code> on Win32, etc.) in the resulting root</li>
</ul>


<p>These options only influence the resulting root. The path after the root is
returned as is. If you want to convert a whole file path to its <tt><em>true</em></tt> case
and/or native format use <a href="#apr.filepath_merge">apr.filepath_merge()</a> instead.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 80%<br></span> <a name="apr.filepath_parent" href="#apr.filepath_parent"><code>apr.filepath_parent(path [, option, ...]) → parent, filename</code></a></h3>

<p>Split the file path <tt><em>path</em></tt> into its parent path and filename. This function
supports the same options as <a href="#apr.filepath_root">apr.filepath_root()</a>. If any options are given
they're applied to <tt><em>path</em></tt> before it is split, so the options influence both
of the resulting values. If <tt><em>path</em></tt> is a filename and the <code>'true-name'</code> option
isn&rsquo;t given then the returned parent path will be an empty string.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.filepath_name" href="#apr.filepath_name"><code>apr.filepath_name(path [, split]) → filename [, extension]</code></a></h3>

<p>Extract the filename (the final element) from the file path <tt><em>path</em></tt>. If <tt><em>split</em></tt>
evaluates <tt><em>true</em></tt> then the extension will be split from the filename and
returned separately. Some examples of what is considered a filename or an
extension:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;regular&nbsp;file&nbsp;path<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.filepath_name" style="color: #0e7c6b; text-decoration: none">apr.filepath_name</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'/usr/bin/lua'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">true</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'lua'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">''</span><br><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;hidden&nbsp;file&nbsp;on&nbsp;UNIX<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.filepath_name" style="color: #0e7c6b; text-decoration: none">apr.filepath_name</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'/home/xolox/.vimrc'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">true</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'.vimrc'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">''</span><br><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;multiple&nbsp;extensions<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.filepath_name" style="color: #0e7c6b; text-decoration: none">apr.filepath_name</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'index.html.en'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">true</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'index.html'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'.en'</span><br></pre>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 86%<br></span> <a name="apr.filepath_merge" href="#apr.filepath_merge"><code>apr.filepath_merge(root, path [, option, ...]) → merged</code></a></h3>

<p>Merge the file paths <tt><em>root</em></tt> and <tt><em>path</em></tt>. On success the merged file path is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. Any
combination of one or more of the following options may be given:</p>

<ul>
<li><code>'true-name'</code> resolves the <tt><em>true</em></tt> case of existing elements in <tt><em>path</em></tt>,
resolving any aliases on Windows, and appends a trailing slash if the
final element is a directory</li>
<li><code>'native'</code> uses the file system&rsquo;s native path format (e.g. path delimiters
of <code>:</code> on MacOS9, <code>\</code> on Win32, etc.)</li>
<li><code>'not-above-root'</code> fails if <tt><em>path</em></tt> is above <tt><em>root</em></tt>, e.g. if <tt><em>root</em></tt> is
<code>/foo/bar</code> and <tt><em>path</em></tt> is <code>../baz</code></li>
<li><code>'not-absolute'</code> fails if the merged path is absolute</li>
<li><code>'not-relative'</code> fails if the merged path is relative</li>
<li><code>'secure-root'</code> fails if <tt><em>path</em></tt> is above <tt><em>root</em></tt>, even given the <tt><em>root</em></tt>
<code>/foo/bar</code> and the <tt><em>path</em></tt> <code>../bar/bash</code></li>
</ul>


<p>This function can be used to generate absolute file paths as follows:</p>

<pre style="color: black; background: white" class="sourcecode lua"><a href="http://peterodding.com/code/lua/apr/docs/#apr.filepath_merge" style="color: #0e7c6b; text-decoration: none">apr.filepath_merge</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'.'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'filepath.c'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'not-relative'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #558817">--&nbsp;the&nbsp;above&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;below:<br></span><a href="http://peterodding.com/code/lua/apr/docs/#apr.filepath_merge" style="color: #0e7c6b; text-decoration: none">apr.filepath_merge</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.filepath_get" style="color: #0e7c6b; text-decoration: none">apr.filepath_get</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'filepath.c'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'not-relative'</span><span style="color: #2239a8; font-weight: bold">)</span><br></pre>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.filepath_list_split" href="#apr.filepath_list_split"><code>apr.filepath_list_split(searchpath) → components</code></a></h3>

<p>Split a search path string into a table of separate components. On success
the table of components is returned, otherwise a <tt><em>nil</em></tt> followed by an error
message is returned. Empty elements do not become part of the returned
table.</p>

<p>An example of a search path is the <a href="http://en.wikipedia.org/wiki/PATH_%2528variable%2529">$PATH</a> environment variable
available in UNIX and Windows operating systems which controls the way
program names are resolved to absolute pathnames (see
<a href="#apr.filepath_which">apr.filepath_which()</a>).</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 77%<br></span> <a name="apr.filepath_list_merge" href="#apr.filepath_list_merge"><code>apr.filepath_list_merge(components) → searchpath</code></a></h3>

<p>Merge a table of search path components into a single search path string. On
success the table of components is returned, otherwise a <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 87%<br></span> <a name="apr.filepath_get" href="#apr.filepath_get"><code>apr.filepath_get([native]) → path</code></a></h3>

<p>Get the default filepath for relative filenames. If <tt><em>native</em></tt> evaluates <tt><em>true</em></tt>
the file system&rsquo;s native path format is used. On success the filepath is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>On at least Windows and UNIX the default file path for relative file names
is the current working directory. Because some operating systems supported
by APR don&rsquo;t use this convention Lua/APR uses the term &lsquo;default filepath&rsquo;
instead.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.filepath_set" href="#apr.filepath_set"><code>apr.filepath_set(path) → status</code></a></h3>

<p>Set the default file path for relative file names to the string <tt><em>path</em></tt>. On
success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned. Also see the notes for <a href="#apr.filepath_get">apr.filepath_get()</a>.</p>

<p><em>This function is not binary safe.</em></p>

<h3><a name="apr.filepath_which" href="#apr.filepath_which"><code>apr.filepath_which(program [, find_all]) → pathname</code></a></h3>

<p>Find the full pathname of <tt><em>program</em></tt> by searching the directories in the
<a href="http://en.wikipedia.org/wiki/PATH_%2528variable%2529">$PATH</a> environment variable and return the pathname of the
first program that&rsquo;s found. If <tt><em>find_all</em></tt> is <tt><em>true</em></tt> then a list with the
pathnames of all matching programs is returned instead.</p>

<h2><a name="filename_matching" href="#filename_matching">Filename matching</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.fnmatch" href="#apr.fnmatch"><code>apr.fnmatch(pattern, input [, ignorecase]) → status</code></a></h3>

<p>Try to match a string against a filename pattern. When the string matches
the pattern <tt><em>true</em></tt> is returned, otherwise <tt><em>false</em></tt>. The supported pattern items
are the following subset of shell wild cards:</p>

<ul>
<li><code>?</code> matches one character (any character)</li>
<li><code>*</code> matches zero or more characters (any character)</li>
<li><code>\x</code> escapes the special meaning of the character <code>x</code></li>
<li><code>[set]</code> matches one character within set. A range of characters can be
specified by separating the characters of the range with a
<code>-</code> character</li>
<li><code>[^set]</code> matches the complement of set, where set is defined as above</li>
</ul>


<p>If the optional argument <tt><em>ignorecase</em></tt> is <tt><em>true</em></tt>, characters are compared
case-insensitively.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.fnmatch_test" href="#apr.fnmatch_test"><code>apr.fnmatch_test(pattern) → status</code></a></h3>

<p>Determine if a file path <tt><em>pattern</em></tt> contains one or more of the wild cards
that are supported by <a href="#apr.fnmatch">apr.fnmatch()</a>. On success <tt><em>true</em></tt> is returned,
otherwise <tt><em>false</em></tt>.</p>

<p><em>This function is not binary safe.</em></p>

<h3><a name="apr.glob" href="#apr.glob"><code>apr.glob(pattern [, ignorecase]) → iterator</code></a></h3>

<p>Split <tt><em>pattern</em></tt> into a directory path and a filename pattern and return an
iterator which returns all filenames in the directory that match the
extracted filename pattern. The <a href="#apr.fnmatch">apr.fnmatch()</a> function is used for
filename matching so the documentation there applies.</p>

<p><em>This function is not binary safe.</em></p>

<h2><a name="directory_manipulation" href="#directory_manipulation">Directory manipulation</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 85%<br></span> <a name="apr.temp_dir_get" href="#apr.temp_dir_get"><code>apr.temp_dir_get() → path</code></a></h3>

<p>Find an existing directory suitable as a temporary storage location. On
success the directory file path is returned, otherwise a <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.dir_make" href="#apr.dir_make"><code>apr.dir_make(path [, permissions]) → status</code></a></h3>

<p>Create the directory <tt><em>path</em></tt> on the file system. On success <tt><em>true</em></tt> is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned. See the
documentation on <a href="#file_system_permissions">permissions</a> for the optional second argument.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.dir_make_recursive" href="#apr.dir_make_recursive"><code>apr.dir_make_recursive(path [, permissions]) → status</code></a></h3>

<p>Create the directory <tt><em>path</em></tt> on the file system, creating intermediate
directories as required. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt>
followed by an error message is returned. See the documentation on
<a href="#file_system_permissions">permissions</a> for the optional second argument.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.dir_remove" href="#apr.dir_remove"><code>apr.dir_remove(path) → status</code></a></h3>

<p>Remove the <em>empty</em> directory <tt><em>path</em></tt> from the file system. On success <tt><em>true</em></tt>
is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 78%<br></span> <a name="apr.dir_remove_recursive" href="#apr.dir_remove_recursive"><code>apr.dir_remove_recursive(path) → status</code></a></h3>

<p>Remove the directory <tt><em>path</em></tt> <em>and all its contents</em> from the file system.
On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p>Note: This function isn&rsquo;t part of the Apache Portable Runtime but has been
implemented on top of it by the author of the Lua/APR binding. <em>It also
hasn&rsquo;t been properly tested yet</em>.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 66%<br></span> <a name="apr.dir_open" href="#apr.dir_open"><code>apr.dir_open(path) → directory handle</code></a></h3>

<p>Open the directory <tt><em>path</em></tt> for reading. On success a directory object is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 61%<br></span> <a name="directory:read" href="#directory:read"><code>directory:read([property, ...]) → value, ...</code></a></h3>

<p>Return the requested properties for the next directory entry. On success the
requested properties are returned, otherwise a <tt><em>nil</em></tt> followed by an error
message is returned. This function implements the same interface as
<a href="#apr.stat">apr.stat()</a>.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="directory:rewind" href="#directory:rewind"><code>directory:rewind() → status</code></a></h3>

<p>Rewind the directory handle to start from the first entry. On success <tt><em>true</em></tt>
is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="directory:entries" href="#directory:entries"><code>directory:entries([property, ...]) → iterator, directory handle</code></a></h3>

<p>Return a function that iterates over the (remaining) directory entries and
returns the requested properties for each entry. If you don&rsquo;t request any
properties, a table with the available properties will be returned for each
directory entry:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;directory&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.dir_open" style="color: #0e7c6b; text-decoration: none">apr.dir_open</a>&nbsp;<span style="color: #a8660d">'examples'</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">for</span>&nbsp;info&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;directory<span style="color: #2239a8; font-weight: bold">:</span>entries<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span>info<span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">{</span><br>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-type" style="color: #0e7c6b; text-decoration: none">type</a>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'file'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;name&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'webserver.lua'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;user&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'peter'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;group&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'peter'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;protection&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'rw-r--r--'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;size&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">2789</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;csize&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">4096</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;inode&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">12455648</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;dev&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">64514</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;nlink&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;path&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'/home/peter/Development/Lua/APR/examples/webserver.lua'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;mtime&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1293753884.3382</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;atime&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1293994993.3855</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;ctime&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1293753884.3382</span><span style="color: #2239a8; font-weight: bold">,</span><br><span style="color: #2239a8; font-weight: bold">}</span><br><span style="color: #2239a8; font-weight: bold">{</span><br>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-type" style="color: #0e7c6b; text-decoration: none">type</a>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'file'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;name&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'download.lua'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;user&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'peter'</span>&nbsp;group&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'peter'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;protection&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'rw-r--r--'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;size&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">2580</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;csize&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">4096</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;inode&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">12455598</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;dev&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">64514</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;nlink&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;path&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'/home/peter/Development/Lua/APR/examples/download.lua'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;mtime&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1293753884.3382</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;atime&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1293994993.3855</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;ctime&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1293753884.3382</span><span style="color: #2239a8; font-weight: bold">,</span><br><span style="color: #2239a8; font-weight: bold">}</span><br></pre>

<p>This function implements the same interface as <a href="#apr.stat">apr.stat()</a> with one
exception: If you pass property names to <a href="#directory:entries">directory:entries()</a> that are not
available they will be returned as <tt><em>false</em></tt> instead of <tt><em>nil</em></tt> because of a
technical limitation in the <a href="http://www.lua.org/manual/5.1/manual.html#2.4.5">Lua iterator protocol</a>:</p>

<blockquote><p>&ldquo;On each iteration, the iterator function is called to
produce a new value, stopping when this new value is <tt><em>nil</em></tt>.&rdquo;</p></blockquote>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="directory:close" href="#directory:close"><code>directory:close() → status</code></a></h3>

<p>Close the directory handle. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt>
followed by an error message is returned.</p>

<h2><a name="file_i_o_handling" href="#file_i_o_handling">File I/O handling</a></h2>

<h3><a name="apr.file_link" href="#apr.file_link"><code>apr.file_link(source, target) → status</code></a></h3>

<p>Create a <a href="http://en.wikipedia.org/wiki/Hard_link">hard link</a> to the specified file. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. Both
files must reside on the same device.</p>

<p>Please note that this function will only be available when the Lua/APR
binding is compiled against APR 1.4 or newer because the <a href="http://apr.apache.org/docs/apr/trunk/group__apr__file__io.html#ga7911275c0e97edc064b8167be658f9e">apr_file_link()</a> function wasn&rsquo;t available in earlier releases.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.file_copy" href="#apr.file_copy"><code>apr.file_copy(source, target [, permissions]) → status</code></a></h3>

<p>Copy the file <tt><em>source</em></tt> to <tt><em>target</em></tt>. On success <tt><em>true</em></tt> is returned, otherwise a
<tt><em>nil</em></tt> followed by an error message is returned. The <a href="#file_system_permissions">permissions</a> argument is
documented elsewhere. The new file does not need to exist, it will be
created if required. If the new file already exists, its contents will be
overwritten.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.file_append" href="#apr.file_append"><code>apr.file_append(source, target [, permissions]) → status</code></a></h3>

<p>Append the file <tt><em>source</em></tt> to <tt><em>target</em></tt>. On success <tt><em>true</em></tt> is returned, otherwise a
<tt><em>nil</em></tt> followed by an error message is returned. The <a href="#file_system_permissions">permissions</a> argument is
documented elsewhere. The new file does not need to exist, it will be
created if required.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.file_rename" href="#apr.file_rename"><code>apr.file_rename(source, target) → status</code></a></h3>

<p>Rename the file <tt><em>source</em></tt> to <tt><em>target</em></tt>. On success <tt><em>true</em></tt> is returned, otherwise a
<tt><em>nil</em></tt> followed by an error message is returned. If a file exists at the new
location, then it will be overwritten. Moving files or directories across
devices may not be possible.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.file_remove" href="#apr.file_remove"><code>apr.file_remove(path) → status</code></a></h3>

<p>Delete the file pointed to by <tt><em>path</em></tt>. On success <tt><em>true</em></tt> is returned, otherwise
a <tt><em>nil</em></tt> followed by an error message is returned. If the file is open, it
won&rsquo;t be removed until all instances of the file are closed.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.file_mtime_set" href="#apr.file_mtime_set"><code>apr.file_mtime_set(path, mtime) → status</code></a></h3>

<p>Set the last modified time of the file pointed to by <tt><em>path</em></tt> to <tt><em>mtime</em></tt>. On
success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 60%<br></span> <a name="apr.file_attrs_set" href="#apr.file_attrs_set"><code>apr.file_attrs_set(path, attributes) → status</code></a></h3>

<p>Set the attributes of the file pointed to by <tt><em>path</em></tt>. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>The table <tt><em>attributes</em></tt> should consist of string keys and boolean values. The
supported attributes are <code>readonly</code>, <code>hidden</code> and <code>executable</code>.</p>

<p>This function should be used in preference to explicit manipulation of the
file permissions, because the operations to provide these attributes are
platform specific and may involve more than simply setting permission bits.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.file_perms_set" href="#apr.file_perms_set"><code>apr.file_perms_set(path, permissions) → status</code></a></h3>

<p>Set the permissions of the file specified by <tt><em>path</em></tt>. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>Warning: Some platforms may not be able to apply all of the available
permission bits, in this case a third value <code>'INCOMPLETE'</code> is returned (see
<a href="#error_handling">error handling</a>).</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.stat" href="#apr.stat"><code>apr.stat(path [, property, ...]) → value, ...</code></a></h3>

<p>Get the status of the file pointed to by <tt><em>path</em></tt>. On success, if no properties
are given a table of property name/value pairs is returned, otherwise the
named properties are returned in the same order as the arguments. On failure
a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>The following fields are supported:</p>

<ul>
<li><code>name</code> is a string containing the name of the file in proper case</li>
<li><code>path</code> is a string containing the absolute pathname of the file</li>
<li><code>type</code> is one of the strings <code>'directory'</code>, <code>'file'</code>, <code>'link'</code>, <code>'pipe'</code>,
<code>'socket'</code>, <code>'block device'</code>, <code>'character device'</code> or <code>'unknown'</code></li>
<li><code>user</code> is a string containing the name of user that owns the file</li>
<li><code>group</code> is a string containing the name of the group that owns the file</li>
<li><code>size</code> is a number containing the size of the file in bytes</li>
<li><code>csize</code> is a number containing the storage size consumed by the file</li>
<li><code>ctime</code> is the time the file was created, or the inode was last changed</li>
<li><code>atime</code> is the time the file was last accessed</li>
<li><code>mtime</code> is the time the file was last modified</li>
<li><code>nlink</code> is the number of hard links to the file</li>
<li><code>inode</code> is a unique number within the file system on which the file
resides</li>
<li><code>dev</code> is a number identifying the device on which the file is stored</li>
<li><code>protection</code> is a 9 character string with the file system <a href="#file_system_permissions">permissions</a></li>
<li><code>link</code> <em>is a special flag that does not return a field</em>, instead it is
used to signal that symbolic links should not be followed, i.e. the
status of the link itself should be returned</li>
</ul>


<p>Here are some examples:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;Here's&nbsp;an&nbsp;example&nbsp;of&nbsp;a&nbsp;table&nbsp;with&nbsp;all&nbsp;properties:<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.stat" style="color: #0e7c6b; text-decoration: none">apr.stat</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'lua-5.1.4.tar.gz'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">{</span><br>&nbsp;name&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'lua-5.1.4.tar.gz'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;path&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'lua-5.1.4.tar.gz'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-type" style="color: #0e7c6b; text-decoration: none">type</a>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'file'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;user&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'peter'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;group&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'peter'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;size&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">216679</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;csize&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">217088</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;ctime&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1284159662.7264</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;atime&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1287954158.6019</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;mtime&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1279317348.194</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;nlink&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;inode&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1838576</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;dev&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">64514</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;protection&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">'rw-r--r--'</span><span style="color: #2239a8; font-weight: bold">,</span><br><span style="color: #2239a8; font-weight: bold">}</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;To&nbsp;check&nbsp;whether&nbsp;a&nbsp;directory&nbsp;exists:<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">function</span>&nbsp;isdir<span style="color: #2239a8; font-weight: bold">(</span>p<span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">return</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.stat" style="color: #0e7c6b; text-decoration: none">apr.stat</a><span style="color: #2239a8; font-weight: bold">(</span>p<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'type'</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">==</span>&nbsp;<span style="color: #a8660d">'directory'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;isdir<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'.'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">true</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;To&nbsp;get&nbsp;a&nbsp;file's&nbsp;size&nbsp;in&nbsp;bytes:<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">function</span>&nbsp;filesize<span style="color: #2239a8; font-weight: bold">(</span>p<span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">return</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.stat" style="color: #0e7c6b; text-decoration: none">apr.stat</a><span style="color: #2239a8; font-weight: bold">(</span>p<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'size'</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;filesize<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'lua-5.1.4.tar.gz'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">216679</span><br></pre>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 78%<br></span> <a name="apr.file_open" href="#apr.file_open"><code>apr.file_open(path [, mode [, permissions]]) → file</code></a></h3>

<p><em>This function imitates Lua&rsquo;s <a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.open">io.open()</a> function, so here is the
documentation for that function:</em></p>

<p>This function opens a file, in the mode specified in the string <tt><em>mode</em></tt>. It
returns a new file handle, or, in case of errors, <tt><em>nil</em></tt> plus an error
message. The <tt><em>mode</em></tt> string can be any of the following:</p>

<ul>
<li><code>'r'</code>: read mode (the default)</li>
<li><code>'w'</code>: write mode</li>
<li><code>'a'</code>: append mode</li>
<li><code>'r+'</code>: update mode, all previous data is preserved</li>
<li><code>'w+'</code>: update mode, all previous data is erased</li>
<li><code>'a+'</code>: append update mode, previous data is preserved, writing is only
allowed at the end of file</li>
</ul>


<p>The <tt><em>mode</em></tt> string may also have a <code>b</code> at the end, which is needed in some
systems to open the file in binary mode. This string is exactly what is used
in the standard C function <a href="http://linux.die.net/man/3/fopen">fopen()</a>. The <a href="#file_system_permissions">permissions</a> argument is
documented elsewhere.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="file:stat" href="#file:stat"><code>file:stat([field, ...]) → value, ...</code></a></h3>

<p>This method works like <a href="#apr.stat">apr.stat()</a> except that it uses a file handle
instead of a filepath to access the file.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="file:lines" href="#file:lines"><code>file:lines() → iterator</code></a></h3>

<p><em>This function implements the interface of the <a href="http://www.lua.org/manual/5.1/manual.html#pdf-file:lines">file:lines()</a> function described in the Lua 5.1 reference manual. Here is the description from the reference manual:</em></p>

<p>Return an iterator function that, each time it is called, returns a new line read from the file. Therefore, the construction</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">for</span>&nbsp;line&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;file<span style="color: #2239a8; font-weight: bold">:</span>lines<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span>&nbsp;body&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br></pre>

<p>will iterate over all lines. This function does not close the file when the loop ends.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="file:read" href="#file:read"><code>file:read([format, ...]) → mixed value, ...</code></a></h3>

<p><em>This function implements the interface of the <a href="http://www.lua.org/manual/5.1/manual.html#pdf-file:read">file:read()</a> function described in the Lua 5.1 reference manual. Here is the description from the reference manual:</em></p>

<p>Read from file, according to the given formats, which specify what to read. For each format, the function returns a string (or a number) with the characters read, or <tt><em>nil</em></tt> if it cannot read data with the specified format. When called without formats, it uses a default format that reads the entire next line (see below).</p>

<p>The available formats are:</p>

<ul>
<li><code>'*n'</code>: reads a number; this is the only format that returns a number instead of a string</li>
<li><code>'*a'</code>: reads all data from the file, starting at the current position. On end of input, it returns the empty string</li>
<li><code>'*l'</code>: reads the next line (skipping the end of line), returning <tt><em>nil</em></tt> on end of input (this is the default format)</li>
<li><code>number</code>: reads a string with up to this number of characters, returning <tt><em>nil</em></tt> on end of input. If number is zero, it reads nothing and returns an empty string, or <tt><em>nil</em></tt> on end of input</li>
</ul>


<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="file:write" href="#file:write"><code>file:write(value [, ...]) → status</code></a></h3>

<p><em>This function implements the interface of the <a href="http://www.lua.org/manual/5.1/manual.html#pdf-file:write">file:write()</a> function described in the Lua 5.1 reference manual. Here is the description from the reference manual:</em></p>

<p>Write the value of each argument to file. The arguments must be strings or numbers. To write other values, use <a href="http://www.lua.org/manual/5.1/manual.html#pdf-tostring">tostring()</a> or <a href="http://www.lua.org/manual/5.1/manual.html#pdf-string.format">string.format()</a> before this function.</p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 70%<br></span> <a name="file:seek" href="#file:seek"><code>file:seek([whence [, offset]]) → offset</code></a></h3>

<p><em>This function implements the interface of the <a href="http://www.lua.org/manual/5.1/manual.html#pdf-file:seek">file:seek()</a> function described in the Lua 5.1 reference manual. Here is the description from the reference manual:</em></p>

<p>Sets and gets the file position, measured from the beginning of the file, to
the position given by <tt><em>offset</em></tt> plus a base specified by the string <tt><em>whence</em></tt>, as
follows:</p>

<ul>
<li><code>'set'</code>:  base is position 0 (beginning of the file)</li>
<li><code>'cur'</code>:  base is current position</li>
<li><code>'end'</code>:  base is end of file</li>
</ul>


<p>In case of success, function <code>seek</code> returns the final file position, measured
in bytes from the beginning of the file. If this function fails, it returns
<tt><em>nil</em></tt>, plus a string describing the error.</p>

<p>The default value for <tt><em>whence</em></tt> is <code>'cur'</code>, and for offset is 0. Therefore, the
call <a href="#file:seek">file:seek()</a> returns the current file position, without changing it; the
call <code>file:seek('set')</code> sets the position to the beginning of the file (and
returns 0); and the call <code>file:seek('end')</code> sets the position to the end of the
file, and returns its size.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="file:flush" href="#file:flush"><code>file:flush() → status</code></a></h3>

<p>Saves any written data to <tt><em>file</em></tt>. On success <tt><em>true</em></tt> is returned, otherwise a
<tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="file:lock" href="#file:lock"><code>file:lock(type [, nonblocking ]) → status</code></a></h3>

<p>Establish a lock on the open file <tt><em>file</em></tt>. On success <tt><em>true</em></tt> is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned. The <tt><em>type</em></tt> must be
one of:</p>

<ul>
<li><code>'shared'</code>: Shared lock. More than one process or thread can hold a
shared lock at any given time. Essentially, this is a &ldquo;read lock&rdquo;,
preventing writers from establishing an exclusive lock</li>
<li><code>'exclusive'</code>: Exclusive lock. Only one process may hold an exclusive
lock at any given time. This is analogous to a &ldquo;write lock&rdquo;</li>
</ul>


<p>If <tt><em>nonblocking</em></tt> is <tt><em>true</em></tt> the call will not block while acquiring the file
lock.</p>

<p>The lock may be advisory or mandatory, at the discretion of the platform.
The lock applies to the file as a whole, rather than a specific range. Locks
are established on a per-thread/process basis; a second lock by the same
thread will not block.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="file:unlock" href="#file:unlock"><code>file:unlock() → status</code></a></h3>

<p>Remove any outstanding locks on the file. On success <tt><em>true</em></tt> is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="pipe:timeout_get" href="#pipe:timeout_get"><code>pipe:timeout_get() → timeout</code></a></h3>

<p>Get the timeout value or blocking state of <tt><em>pipe</em></tt>. On success the timeout
value is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>The <tt><em>timeout</em></tt> <tt><em>true</em></tt> means wait forever, <tt><em>false</em></tt> means don&rsquo;t wait at all and a
number is the microseconds to wait.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="pipe:timeout_set" href="#pipe:timeout_set"><code>pipe:timeout_set(timeout) → status</code></a></h3>

<p>Set the timeout value or blocking state of <tt><em>pipe</em></tt>. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>The <tt><em>timeout</em></tt> <tt><em>true</em></tt> means wait forever, <tt><em>false</em></tt> means don&rsquo;t wait at all and a
number is the microseconds to wait. For example:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #558817">--&nbsp;Configure&nbsp;read&nbsp;end&nbsp;of&nbsp;pipe&nbsp;to&nbsp;block&nbsp;for&nbsp;a&nbsp;maximum&nbsp;of&nbsp;5&nbsp;seconds.<br></span>pipe<span style="color: #2239a8; font-weight: bold">:</span>timeout_set<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">1000000</span>&nbsp;<span style="color: #2239a8; font-weight: bold">*</span>&nbsp;<span style="color: #a8660d">5</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">for</span>&nbsp;line&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;pipe<span style="color: #2239a8; font-weight: bold">:</span>lines<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span>line<span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">end</span><br></pre>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="file:inherit_set" href="#file:inherit_set"><code>file:inherit_set() → status</code></a></h3>

<p>Set a file to be inherited by child processes. By default, file descriptors
will not be inherited by child processes created by <a href="#apr.proc_create">apr.proc_create()</a>.</p>

<p>At the time of writing this <a href="http://marc.info/?l=apache-httpd-dev&amp;m=104361635329125&amp;w=2">seems to only apply to UNIX</a> where
APR will close all open file handles after performing a <a href="http://linux.die.net/man/2/fork">fork()</a>
unless you explicitly set your files to be inheritable.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="file:inherit_unset" href="#file:inherit_unset"><code>file:inherit_unset() → status</code></a></h3>

<p>Unset a file from being inherited by child processes.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="file:close" href="#file:close"><code>file:close() → status</code></a></h3>

<p>Close <tt><em>file</em></tt>. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<h2><a name="network_i_o_handling" href="#network_i_o_handling">Network I/O handling</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 92%<br></span> <a name="apr.socket_create" href="#apr.socket_create"><code>apr.socket_create([protocol [, family]]) → socket</code></a></h3>

<p>Create a network socket. On success the new socket object is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned. Valid values for
the <tt><em>protocol</em></tt> argument are:</p>

<ul>
<li><code>'tcp'</code> to create a <a href="http://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a> socket (this is the default)</li>
<li><code>'udp'</code> to create a <a href="http://en.wikipedia.org/wiki/User_Datagram_Protocol">UDP</a> socket</li>
</ul>


<p>These are the valid values for the <tt><em>family</em></tt> argument:</p>

<ul>
<li><code>'inet'</code> to create a socket using the <a href="http://en.wikipedia.org/wiki/IPv4">IPv4</a> address family</li>
<li><code>'inet6'</code> to create a socket using the <a href="http://en.wikipedia.org/wiki/IPv6">IPv6</a> address family</li>
<li><code>'unspec'</code> to pick the system default type (this is the default)</li>
</ul>


<p>Note that <code>'inet6'</code> is only supported when <code>apr.socket_supports_ipv6</code> is
<tt><em>true</em></tt>.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 85%<br></span> <a name="apr.hostname_get" href="#apr.hostname_get"><code>apr.hostname_get() → name</code></a></h3>

<p>Get the name of the current machine. On success the host name string is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.host_to_addr" href="#apr.host_to_addr"><code>apr.host_to_addr(hostname [, family]) → ip_address</code></a></h3>

<p>Resolve a host name to an IP-address. On success the IP-address is returned
as a string, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. The
optional <tt><em>family</em></tt> argument is documented under <a href="#apr.socket_create">apr.socket_create()</a>.</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.host_to_addr" style="color: #0e7c6b; text-decoration: none">apr.host_to_addr</a>&nbsp;<span style="color: #a8660d">'www.lua.org'</span><br><span style="color: #a8660d">'89.238.129.35'</span><br></pre>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.addr_to_host" href="#apr.addr_to_host"><code>apr.addr_to_host(ip_address [, family]) → hostname</code></a></h3>

<p>Look up the host name from an IP-address (also known as a reverse <a href="http://en.wikipedia.org/wiki/Domain_Name_System">DNS</a> lookup). On success the host name is returned as a string, otherwise a
<tt><em>nil</em></tt> followed by an error message is returned. The optional <tt><em>family</em></tt> argument
is documented under <a href="#apr.socket_create">apr.socket_create()</a>.</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.addr_to_host" style="color: #0e7c6b; text-decoration: none">apr.addr_to_host</a>&nbsp;<span style="color: #a8660d">'89.238.129.35'</span><br><span style="color: #a8660d">'flounder.pepperfish.net'</span><br></pre>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="socket:connect" href="#socket:connect"><code>socket:connect(host, port) → status</code></a></h3>

<p>Issue a connection request to a socket either on the same machine or a
different one, as indicated by the <tt><em>host</em></tt> string and <tt><em>port</em></tt> number. On success
<tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="socket:bind" href="#socket:bind"><code>socket:bind(host, port) → status</code></a></h3>

<p>Bind the socket to the given <tt><em>host</em></tt> string and <tt><em>port</em></tt> number. On success <tt><em>true</em></tt>
is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. The
special <tt><em>host</em></tt> value <code>'*'</code> can be used to select the default &lsquo;any&rsquo; address.
For example if you want to create a web server you can start with the
following:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #558817">--&nbsp;Basic&nbsp;single&nbsp;threaded&nbsp;server<br></span>server&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.socket_create" style="color: #0e7c6b; text-decoration: none">apr.socket_create</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>server<span style="color: #2239a8; font-weight: bold">:</span>bind<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'*'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">80</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>server<span style="color: #2239a8; font-weight: bold">:</span>listen<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">10</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">while</span>&nbsp;<span style="color: #a8660d">true</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;client&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>server<span style="color: #2239a8; font-weight: bold">:</span>accept<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #558817">--&nbsp;Here&nbsp;you&nbsp;can&nbsp;receive&nbsp;data&nbsp;from&nbsp;the&nbsp;client&nbsp;by&nbsp;calling&nbsp;client:read()<br></span>&nbsp;&nbsp;<span style="color: #558817">--&nbsp;and&nbsp;send&nbsp;data&nbsp;to&nbsp;the&nbsp;client&nbsp;by&nbsp;calling&nbsp;client:write()<br></span><span style="color: #2239a8; font-weight: bold">end</span><br></pre>

<p>This function can fail if you try to bind a port below 1000 without
superuser privileges or if another process is already bound to the given
port number.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="socket:listen" href="#socket:listen"><code>socket:listen(backlog) → status</code></a></h3>

<p>To listen for incoming network connections three steps must be performed:</p>

<ol>
<li>First a socket is created with <a href="#apr.socket_create">apr.socket_create()</a></li>
<li>Next a willingness to accept incoming connections and a queue limit for
incoming connections are specified with <a href="#socket:listen">socket:listen()</a> (this call
doesn&rsquo;t block)</li>
<li>Finally <a href="#socket:accept">socket:accept()</a> is called to wait for incoming connections</li>
</ol>


<p>On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned. The <tt><em>backlog</em></tt> argument indicates the number of outstanding
connections allowed in the socket&rsquo;s listen queue. If this value is less than
zero, the listen queue size is set to zero. As a special case, if you pass
the string <code>'max'</code> as <tt><em>backlog</em></tt> then a platform specific maximum value is
chosen based on the compile time constant <a href="http://www.google.com/search?q=SOMAXCONN">SOMAXCONN</a>.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="socket:accept" href="#socket:accept"><code>socket:accept() → client_socket</code></a></h3>

<p>Accept a connection request on a server socket. On success a socket is
returned which forms the connection to the client, otherwise a <tt><em>nil</em></tt> followed
by an error message is returned. This function blocks until a client
connects.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="socket:read" href="#socket:read"><code>socket:read([format, ...]) → mixed value, ...</code></a></h3>

<p><em>This function implements the interface of the <a href="http://www.lua.org/manual/5.1/manual.html#pdf-file:read">file:read()</a> function described in the Lua 5.1 reference manual. Here is the description from the reference manual:</em></p>

<p>Read from socket, according to the given formats, which specify what to read. For each format, the function returns a string (or a number) with the characters read, or <tt><em>nil</em></tt> if it cannot read data with the specified format. When called without formats, it uses a default format that reads the entire next line (see below).</p>

<p>The available formats are:</p>

<ul>
<li><code>'*n'</code>: reads a number; this is the only format that returns a number instead of a string</li>
<li><code>'*a'</code>: reads all data from the socket, starting at the current position. On end of input, it returns the empty string</li>
<li><code>'*l'</code>: reads the next line (skipping the end of line), returning <tt><em>nil</em></tt> on end of input (this is the default format)</li>
<li><code>number</code>: reads a string with up to this number of characters, returning <tt><em>nil</em></tt> on end of input. If number is zero, it reads nothing and returns an empty string, or <tt><em>nil</em></tt> on end of input</li>
</ul>


<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 85%<br></span> <a name="socket:write" href="#socket:write"><code>socket:write(value [, ...]) → status</code></a></h3>

<p><em>This function implements the interface of the <a href="http://www.lua.org/manual/5.1/manual.html#pdf-file:write">file:write()</a> function described in the Lua 5.1 reference manual. Here is the description from the reference manual:</em></p>

<p>Write the value of each argument to socket. The arguments must be strings or numbers. To write other values, use <a href="http://www.lua.org/manual/5.1/manual.html#pdf-tostring">tostring()</a> or <a href="http://www.lua.org/manual/5.1/manual.html#pdf-string.format">string.format()</a> before this function.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="socket:lines" href="#socket:lines"><code>socket:lines() → iterator</code></a></h3>

<p><em>This function implements the interface of the <a href="http://www.lua.org/manual/5.1/manual.html#pdf-file:lines">file:lines()</a> function described in the Lua 5.1 reference manual. Here is the description from the reference manual:</em></p>

<p>Return an iterator function that, each time it is called, returns a new line read from the socket. Therefore, the construction</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">for</span>&nbsp;line&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;socket<span style="color: #2239a8; font-weight: bold">:</span>lines<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span>&nbsp;body&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br></pre>

<p>will iterate over all lines. This function does not close the socket when the loop ends.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="socket:timeout_get" href="#socket:timeout_get"><code>socket:timeout_get() → timeout</code></a></h3>

<p>Get the timeout value or blocking state of <tt><em>socket</em></tt>. On success the timeout
value is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>The <tt><em>timeout</em></tt> <tt><em>true</em></tt> means wait forever, <tt><em>false</em></tt> means don&rsquo;t wait at all and a
number is the microseconds to wait.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="socket:timeout_set" href="#socket:timeout_set"><code>socket:timeout_set(timeout) → status</code></a></h3>

<p>Set the timeout value or blocking state of <tt><em>socket</em></tt>. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>The <tt><em>timeout</em></tt> <tt><em>true</em></tt> means wait forever, <tt><em>false</em></tt> means don&rsquo;t wait at all and a
number is the microseconds to wait.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="socket:opt_get" href="#socket:opt_get"><code>socket:opt_get(name) → value</code></a></h3>

<p>Query socket options for the specified socket. Valid values for <tt><em>name</em></tt> are:</p>

<ul>
<li><code>'debug'</code>: turn on debugging information</li>
<li><code>'keep-alive'</code>: keep connections active</li>
<li><code>'linger'</code>: lingers on close if data is present</li>
<li><code>'non-block'</code>: turns blocking on/off for socket</li>
<li><code>'reuse-addr'</code>: the rules used in validating addresses supplied to bind
should allow reuse of local addresses</li>
<li><code>'sndbuf'</code>: set the send buffer size</li>
<li><code>'rcvbuf'</code>: set the receive buffer size</li>
<li><code>'disconnected'</code>: query the disconnected state of the socket (currently only used on Windows)</li>
</ul>


<p>The <code>'sndbuf'</code> and <code>'rcvbuf'</code> options have integer values, all other options
have a boolean value.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="socket:opt_set" href="#socket:opt_set"><code>socket:opt_set(name, value) → status</code></a></h3>

<p>Setup socket options for the specified socket. Valid values for <tt><em>name</em></tt> are
documented under <a href="#socket:opt_get">socket:opt_get()</a>, <tt><em>value</em></tt> should be a boolean or integer
value. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error
message is returned.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="socket:addr_get" href="#socket:addr_get"><code>socket:addr_get([type]) → ip_address, port [, hostname]</code></a></h3>

<p>Get one of the IP-address / port pairs associated with <tt><em>socket</em></tt>, according to
<tt><em>type</em></tt>:</p>

<ul>
<li><code>'local'</code> to get the address/port to which the socket is bound locally</li>
<li><code>'remote'</code> to get the address/port of the peer to which the socket is
connected (this is the default)</li>
</ul>


<p>On success the local or remote IP-address (a string) and the port (a number)
are returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. If a
host name is available that will be returned as the third value.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="socket:shutdown" href="#socket:shutdown"><code>socket:shutdown(mode) → status</code></a></h3>

<p>Shutdown either reading, writing, or both sides of a socket. On success <tt><em>true</em></tt>
is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. Valid
values for <tt><em>mode</em></tt> are:</p>

<ul>
<li><code>'read'</code>: no longer allow read requests</li>
<li><code>'write'</code>: no longer allow write requests</li>
<li><code>'both'</code>: no longer allow read or write requests</li>
</ul>


<p>This does not actually close the socket descriptor, it just controls which
calls are still valid on the socket. To close sockets see <a href="#socket:close">socket:close()</a>.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="socket:close" href="#socket:close"><code>socket:close() → status</code></a></h3>

<p>Close <tt><em>socket</em></tt>. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<h2><a name="pipe_i_o_handling" href="#pipe_i_o_handling">Pipe I/O handling</a></h2>

<p>Lua/APR represents <a href="http://en.wikipedia.org/wiki/Pipeline_%28Unix%29">pipes</a> as files just like Lua&rsquo;s standard
library function <a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.popen">io.popen()</a> does because it works fairly well, however
there are some differences between files and pipes which impact the API:</p>

<ul>
<li><p>File objects implement <a href="#pipe:timeout_get">pipe:timeout_get()</a> and <a href="#pipe:timeout_set">pipe:timeout_set()</a> even
though these methods only make sense for pipe objects</p></li>
<li><p>Pipe objects implement <a href="#file:seek">file:seek()</a> but don&rsquo;t support it</p></li>
</ul>


<p>One of the reasons that file/pipe support is so interwoven in APR and thus
Lua/APR is that you can create a named pipe with <a href="#apr.namedpipe_create">apr.namedpipe_create()</a>
and access it using <a href="#apr.file_open">apr.file_open()</a> and APR won&rsquo;t know or even care that
you're reading/writing a pipe instead of a file.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.pipe_open_stdin" href="#apr.pipe_open_stdin"><code>apr.pipe_open_stdin() → pipe</code></a></h3>

<p>Open standard input as a pipe. On success the pipe is returned, otherwise a
<tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.pipe_open_stdout" href="#apr.pipe_open_stdout"><code>apr.pipe_open_stdout() → pipe</code></a></h3>

<p>Open standard output as a pipe. On success the pipe is returned, otherwise a
<tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.pipe_open_stderr" href="#apr.pipe_open_stderr"><code>apr.pipe_open_stderr() → pipe</code></a></h3>

<p>Open standard error as a pipe. On success the pipe is returned, otherwise a
<tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.namedpipe_create" href="#apr.namedpipe_create"><code>apr.namedpipe_create(name [, permissions]) → status</code></a></h3>

<p>Create a <a href="http://en.wikipedia.org/wiki/Named_pipe">named pipe</a>. On success <tt><em>true</em></tt> is returned, otherwise a
<tt><em>nil</em></tt> followed by an error message is returned. The <a href="#file_system_permissions">permissions</a> argument is
documented elsewhere.</p>

<p>Named pipes can be used for interprocess communication:</p>

<ol>
<li>Check if the named pipe already exists, if it doesn&rsquo;t then create it</li>
<li>Have each process access the named pipe using <a href="#apr.file_open">apr.file_open()</a></li>
<li>Communicate between the two processes over the read/write ends of the
named pipe and close it when the communication is finished.</li>
</ol>


<p>Note that APR supports named pipes on UNIX but not on Windows. If you try
anyhow the error message &ldquo;This function has not been implemented on this
platform&rdquo; is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="apr.pipe_create" href="#apr.pipe_create"><code>apr.pipe_create() → input, output</code></a></h3>

<p>Create an <a href="http://en.wikipedia.org/wiki/Anonymous_pipe">anonymous pipe</a>. On success the write and read ends
of the pipe are returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned. There&rsquo;s an example use of this function in the documentation for
<a href="#process:in_set">process:in_set()</a>.</p>

<h2><a name="memcached_client" href="#memcached_client">Memcached client</a></h2>

<p><a href="http://memcached.org/">Memcached</a> is a &ldquo;distributed memory object caching system&rdquo;.
It&rsquo;s designed as an in-memory key-value store for small chunks of arbitrary
data (strings, objects) from results of database calls, API calls, or page
rendering. The memcached client module makes it possible to read from and
write to one or more memcached servers over a network socket in Lua.</p>

<p>To-do: Find out if &ldquo;flags&rdquo; can be any 32 bits value and how useful it is
to Lua.</p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 72%<br></span> <a name="apr.memcache" href="#apr.memcache"><code>apr.memcache([max_servers]) → mc_client</code></a></h3>

<p>Create a memcached client. The optional argument <tt><em>max_servers</em></tt> determines the
maximum number of memcached servers supported by the client (defaults to
10). On success the client object is returned, otherwise <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="mc_client:hash" href="#mc_client:hash"><code>mc_client:hash(str) → hash</code></a></h3>

<p>Create a <a href="http://en.wikipedia.org/wiki/Cyclic_redundancy_check">CRC32</a> hash used to split keys between servers.
The hash is not compatible with old memcached clients.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 88%<br></span> <a name="mc_client:find_server_hash" href="#mc_client:find_server_hash"><code>mc_client:find_server_hash(hash) → mc_server</code></a></h3>

<p>Picks a server based on a hash. Returns the info of the server that controls
the specified hash.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 89%<br></span> <a name="mc_client:add_server" href="#mc_client:add_server"><code>mc_client:add_server(host, port [, min [, smax [, max [, ttl]]]]) → mc_server</code></a></h3>

<p>Create a new server object and add it to the client object. On success the
server object is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned. The parameters have the following meaning:</p>

<ul>
<li><tt><em>host</em></tt>: hostname of server</li>
<li><tt><em>port</em></tt>: port of server (usually 11211)</li>
<li><tt><em>min</em></tt>:  minimum number of client sockets to open (defaults to 0)</li>
<li><tt><em>smax</em></tt>: soft maximum number of client connections to open (defaults to 1)</li>
<li><tt><em>max</em></tt>:  hard maximum number of client connections (defaults to 1)</li>
<li><tt><em>ttl</em></tt>:  time to live in microseconds of a client connection (defaults to 60000)</li>
</ul>


<p>Note that <tt><em>min</em></tt>, <tt><em>smax</em></tt> and <tt><em>max</em></tt> are only used when APR was compiled with
threads. Also a word of caution: Changing servers after startup may cause
keys to go to different servers.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="mc_client:find_server" href="#mc_client:find_server"><code>mc_client:find_server(host, port) → mc_server</code></a></h3>

<p>Finds a server object based on a (hostname, port) pair. On success the
server with matching host name and port is returned, otherwise nothing is
returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="mc_client:enable_server" href="#mc_client:enable_server"><code>mc_client:enable_server(mc_server) → status</code></a></h3>

<p>Enable a server for use again after disabling the server with
<a href="#mc_client:disable_server">mc_client:disable_server()</a>. On success <tt><em>true</em></tt> is returned,
otherwise <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="mc_client:disable_server" href="#mc_client:disable_server"><code>mc_client:disable_server(mc_server) → status</code></a></h3>

<p>Disable a server. On success <tt><em>true</em></tt> is returned, otherwise <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 85%<br></span> <a name="mc_client:get" href="#mc_client:get"><code>mc_client:get(key [, ...]) → status, value [, ...]</code></a></h3>

<p>Get one or more values from the server. On success <tt><em>true</em></tt> is returned followed
by the retrieved value(s), otherwise <tt><em>nil</em></tt> followed by an error message is
returned. The keys are null terminated strings and the return values are
binary safe strings. Keys that don&rsquo;t have an associated value result in <tt><em>nil</em></tt>.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="mc_client:set" href="#mc_client:set"><code>mc_client:set(key, value [, timeout]) → status</code></a></h3>

<p>Sets a value by key on the server. If the key already exists the old value
will be overwritten. The <tt><em>key</em></tt> is a null terminated string, the <tt><em>value</em></tt> is a
binary safe string and <tt><em>timeout</em></tt> is the time in seconds for the data to live
on the server (a number, defaults to 60 seconds). On success <tt><em>true</em></tt> is
returned, otherwise <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="mc_client:add" href="#mc_client:add"><code>mc_client:add(key, value [, timeout]) → status</code></a></h3>

<p>Adds a value by key on the server. If the key already exists this call will
fail and the old value will be preserved. The arguments and return values
are documented under <a href="#mc_client:set">mc_client:set()</a>.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="mc_client:replace" href="#mc_client:replace"><code>mc_client:replace(key, value [, timeout]) → status</code></a></h3>

<p>Replace a value by key on the server. If the key doesn&rsquo;t exist no value will
be set. The arguments and return values are documented under
<a href="#mc_client:set">mc_client:set()</a>.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="mc_client:delete" href="#mc_client:delete"><code>mc_client:delete(key [, timeout]) → status</code></a></h3>

<p>Delete a key from the server. The <tt><em>key</em></tt> is a null terminated string and
<tt><em>timeout</em></tt> is the time in seconds for the delete to stop other clients from
adding (a number, defaults to 10 seconds). On success <tt><em>true</em></tt> is returned,
otherwise <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 88%<br></span> <a name="mc_client:incr" href="#mc_client:incr"><code>mc_client:incr(key [, number]) → value</code></a></h3>

<p>Increment a value. The <tt><em>key</em></tt> is a null terminated string and the optional
argument <tt><em>number</em></tt> is the number to increment by (defaults to 1). On success
the new value after incrementing is returned, otherwise <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 88%<br></span> <a name="mc_client:decr" href="#mc_client:decr"><code>mc_client:decr(key [, number]) → value</code></a></h3>

<p>Decrement a value. The <tt><em>key</em></tt> is a null terminated string and the optional
argument <tt><em>number</em></tt> is the number to decrement by (defaults to 1). On success
the new value after decrementing is returned, otherwise <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="mc_client:version" href="#mc_client:version"><code>mc_client:version(mc_server) → version</code></a></h3>

<p>Query a server&rsquo;s version. On success the version string is returned,
otherwise <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 96%<br></span> <a name="mc_client:stats" href="#mc_client:stats"><code>mc_client:stats() → statistics</code></a></h3>

<p>Query a server for statistics. On success a table with information is
returned, otherwise <tt><em>nil</em></tt> followed by an error message is returned. The
following fields are supported:</p>

<ul>
<li><tt><em>version</em></tt>: version string of the server</li>
<li><tt><em>pid</em></tt>: process ID of the server process</li>
<li><tt><em>uptime</em></tt>: number of seconds this server has been running</li>
<li><tt><em>time</em></tt>: current UNIX time according to the server</li>
<li><tt><em>rusage_user</em></tt>: accumulated user time for this process</li>
<li><tt><em>rusage_system</em></tt>: accumulated system time for this process</li>
<li><tt><em>curr_items</em></tt>: current number of items stored by the server</li>
<li><tt><em>total_items</em></tt>: total number of items stored by this server</li>
<li><tt><em>bytes</em></tt>: current number of bytes used by this server to store items</li>
<li><tt><em>curr_connections</em></tt>: number of open connections</li>
<li><tt><em>total_connections</em></tt>: total number of connections opened since the server started running</li>
<li><tt><em>connection_structures</em></tt>: number of connection structures allocated by the server</li>
<li><tt><em>cmd_get</em></tt>: cumulative number of retrieval requests</li>
<li><tt><em>cmd_set</em></tt>: Cumulative number of storage requests</li>
<li><tt><em>get_hits</em></tt>: number of keys that have been requested and found present</li>
<li><tt><em>get_misses</em></tt>: number of items that have been requested and not found</li>
<li><tt><em>evictions</em></tt>: number of items removed from cache because they passed their expiration time</li>
<li><tt><em>bytes_read</em></tt>: total number of bytes read by this server</li>
<li><tt><em>bytes_written</em></tt>: total number of bytes sent by this server</li>
<li><tt><em>limit_maxbytes</em></tt>: number of bytes this server is allowed to use for storage</li>
<li><tt><em>threads</em></tt>: number of threads the server is running (if built with threading)</li>
</ul>


<h2><a name="command_argument_parsing" href="#command_argument_parsing">Command argument parsing</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 92%<br></span> <a name="apr.getopt" href="#apr.getopt"><code>apr.getopt(usage [, config ]) → options, arguments</code></a></h3>

<p>Parse the <a href="http://en.wikipedia.org/wiki/Command-line_argument">command line arguments</a> according to the option letters
and/or long options defined in the string <tt><em>usage</em></tt> (see the example below) and
return a table with the matched options and a table with any remaining
positional arguments. When an option is matched multiple times, the
resulting value in <tt><em>options</em></tt> depends on the following context:</p>

<ul>
<li><p>If the option doesn&rsquo;t take an argument, the value will be a number
indicating the number of times that the option was matched</p></li>
<li><p>If the option takes an argument and only one option/argument pair is
matched, the value will be the argument (a string). When more than one
pair is matched for the same option letter/name, the values will be
collected in a table</p></li>
</ul>


<p>The optional <tt><em>config</em></tt> table can be used to change the following defaults:</p>

<ul>
<li><p>When <tt><em>usage</em></tt> mentions <code>-h</code> or <code>--help</code> and either of these options is
matched in the arguments, <a href="#apr.getopt">apr.getopt()</a> will print the usage message
and call <a href="http://www.lua.org/manual/5.1/manual.html#pdf-os.exit">os.exit()</a>. To avoid this set <code>config.show_usage</code> to <tt><em>false</em></tt>
(not <tt><em>nil</em></tt>!)</p></li>
<li><p>When an error is encountered during argument parsing, <a href="#apr.getopt">apr.getopt()</a> will
print a warning about the invalid argument and call <a href="http://www.lua.org/manual/5.1/manual.html#pdf-os.exit">os.exit()</a>. To avoid
this set <code>config.handle_errors</code> to <tt><em>false</em></tt> (not <tt><em>nil</em></tt>!)</p></li>
<li><p>By default the arguments in the global variable <a href="http://www.lua.org/manual/5.1/manual.html#6">arg</a> will
be used, but you can set <code>config.args</code> to a table of arguments to be
used instead</p></li>
</ul>


<p>Here is a short example of a valid Lua script that doesn&rsquo;t really do
anything useful but demonstrates the use of <a href="#apr.getopt">apr.getopt()</a>:</p>

<pre style="color: black; background: white" class="sourcecode lua">apr&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-require" style="color: #0e7c6b; text-decoration: none">require</a>&nbsp;<span style="color: #a8660d">'apr'</span><br>opts<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;args&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;apr.getopt&nbsp;[[<br>Usage:&nbsp;echo.lua&nbsp;[OPTIONS]&nbsp;ARG...<br>&nbsp;&nbsp;-h,&nbsp;--help&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;show&nbsp;this&nbsp;message&nbsp;and&nbsp;exit<br>&nbsp;&nbsp;-v,&nbsp;--verbose&nbsp;&nbsp;make&nbsp;more&nbsp;noise<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--version&nbsp;&nbsp;print&nbsp;version&nbsp;and&nbsp;exit<br>]]<br><span style="color: #2239a8; font-weight: bold">if</span>&nbsp;opts.version&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a>&nbsp;<span style="color: #a8660d">"This&nbsp;is&nbsp;version&nbsp;0.1"</span><br><span style="color: #2239a8; font-weight: bold">else</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;opts.verbose&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">"Got"</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #2239a8; font-weight: bold">#</span>args<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">"arguments"</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;opts.verbose&nbsp;<span style="color: #2239a8; font-weight: bold">&gt;=</span>&nbsp;<span style="color: #a8660d">2</span>&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a>&nbsp;<span style="color: #a8660d">"Here&nbsp;they&nbsp;are:"</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">for</span>&nbsp;i&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #2239a8; font-weight: bold">#</span>args&nbsp;<span style="color: #2239a8; font-weight: bold">do</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span>args<span style="color: #2239a8; font-weight: bold">[</span>i<span style="color: #2239a8; font-weight: bold">]</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">end</span><br></pre>

<p>The <a href="#apr.getopt">apr.getopt()</a> function is very similar to <a href="http://lua-users.org/wiki/LappFramework">Lapp</a> by Steve
Donovan although Lapp is more full featured, for example it validates and
converts argument types.</p>

<h2><a name="http_request_parsing" href="#http_request_parsing">HTTP request parsing</a></h2>

<p>This module is an experimental binding to the <a href="http://httpd.apache.org/apreq/">apreq2</a> library
which enables <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a> request parsing of <a href="http://en.wikipedia.org/wiki/Query_string">query strings</a>,
<a href="http://en.wikipedia.org/wiki/List_of_HTTP_header_fields">headers</a> and <a href="http://en.wikipedia.org/wiki/MIME#Multipart_messages">multipart</a> messages. Some general notes
about the functions in this module:</p>

<ul>
<li><p>None of the extracted strings (except maybe for request bodies) are
binary safe because (AFAIK) HTTP headers are not binary safe</p></li>
<li><p>Parsed name/value pairs are converted to a Lua table using two rules:
names without a value get the value <tt><em>true</em></tt> and duplicate names result in a
table that collects all values for the given name</p></li>
<li><p>When a parse error is encountered after successfully parsing part of the
input, the results of the function are followed by an error message and
error code (see below)</p></li>
</ul>


<p>The functions in this module return three values on error: a <tt><em>nil</em></tt> followed by
an error message and an error code. This module defines the following error
codes (in addition to the <a href="#error_handling">generic Lua/APR error codes</a>):</p>

<ul>
<li><code>'EBADARG'</code>: bad arguments</li>
<li><code>'GENERAL'</code>: internal apreq2 error</li>
<li><code>'TAINTED'</code>: attempted to perform unsafe action with tainted data</li>
<li><code>'INTERRUPT'</code>: parsing interrupted</li>
<li><code>'BADDATA'</code>: invalid input data</li>
<li><code>'BADCHAR'</code>: invalid character</li>
<li><code>'BADSEQ'</code>: invalid byte sequence</li>
<li><code>'BADATTR'</code>: invalid attribute</li>
<li><code>'BADHEADER'</code>: invalid header</li>
<li><code>'BADUTF8'</code>: invalid UTF-8 encoding</li>
<li><code>'NODATA'</code>: missing input data</li>
<li><code>'NOTOKEN'</code>: missing required token</li>
<li><code>'NOATTR'</code>: missing attribute</li>
<li><code>'NOHEADER'</code>: missing header</li>
<li><code>'NOPARSER'</code>: missing parser</li>
<li><code>'MISMATCH'</code>: conflicting information</li>
<li><code>'OVERLIMIT'</code>: exceeds configured maximum limit</li>
<li><code>'UNDERLIMIT'</code>: below configured minimum limit</li>
<li><code>'NOTEMPTY'</code>: setting already configured</li>
</ul>


<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.parse_headers" href="#apr.parse_headers"><code>apr.parse_headers(request) → headers, body</code></a></h3>

<p>Parse the <a href="http://en.wikipedia.org/wiki/List_of_HTTP_header_fields">headers</a> in a <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a> request string according to
<a href="http://tools.ietf.org/html/rfc822">RFC 822</a>. On success a table of header name/value pairs and the
request body string are returned, otherwise <tt><em>nil</em></tt> followed by an error message
is returned.</p>

<p>There are some gotchas in using this function:</p>

<ul>
<li><p>It will fail if anything comes before the headers, so be sure to strip
the status line from the request string before calling this function</p></li>
<li><p>If the request string doesn&rsquo;t contain an empty line to separate the
headers from the body, the last header might be silently discarded</p></li>
</ul>


<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.parse_multipart" href="#apr.parse_multipart"><code>apr.parse_multipart(request, enctype [, limit [, tempdir]]) → parts</code></a></h3>

<p>Parse a <a href="http://en.wikipedia.org/wiki/MIME#Form_Data">multipart/form-data</a> or <a href="http://en.wikipedia.org/wiki/MIME#Related">multipart/related</a> HTTP request body according to <a href="http://tools.ietf.org/html/rfc2388">RFC 2388</a> and the
boundary string in <tt><em>enctype</em></tt>. On success the table with parameter name/value
pairs is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p>The optional number <tt><em>limit</em></tt> gives the maximum in-memory bytes that the data
structure used to parse the request may use (it defaults to 1024 KB), but be
aware that because of internal copying <a href="#apr.parse_multipart">apr.parse_multipart()</a> can use more
than double this amount of memory while parsing a request.</p>

<p>The optional string <tt><em>tempdir</em></tt> is the directory used for temporary storage of
large uploads.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.parse_cookie_header" href="#apr.parse_cookie_header"><code>apr.parse_cookie_header(header) → cookies</code></a></h3>

<p>Parse a cookie header and store the cookies in a Lua table. On success the
table with cookie name/value pairs is returned, otherwise <tt><em>nil</em></tt> followed by an
error message and error code is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.parse_query_string" href="#apr.parse_query_string"><code>apr.parse_query_string(query_string) → parameters</code></a></h3>

<p>Parse a URL encoded string into a Lua table. On success the table with
parameter name/value pairs is returned, otherwise <tt><em>nil</em></tt> followed by an error
message and error code is returned.</p>

<p>This function uses <code>&amp;</code> and <code>;</code> as the set of tokens to delineate words, and
will treat a word without <code>=</code> as a name/value pair with the value <tt><em>true</em></tt>.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.header_attribute" href="#apr.header_attribute"><code>apr.header_attribute(header, name) → value</code></a></h3>

<p>Search a header string for the value of a particular named attribute. On
success the matched value is returned, otherwise <tt><em>nil</em></tt> followed by an error
message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.uri_encode" href="#apr.uri_encode"><code>apr.uri_encode(string) → encoded</code></a></h3>

<p>Encode unsafe bytes in <tt><em>string</em></tt> using <a href="http://en.wikipedia.org/wiki/Percent-encoding">percent-encoding</a> so that
the string can be embedded in a <a href="http://en.wikipedia.org/wiki/Uniform_Resource_Identifier">URI</a> query string.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="apr.uri_decode" href="#apr.uri_decode"><code>apr.uri_decode(encoded) → string</code></a></h3>

<p>Decode all <a href="http://en.wikipedia.org/wiki/Percent-encoding">percent-encoded</a> bytes in the string <tt><em>encoded</em></tt>.</p>

<p><em>This function is binary safe.</em></p>

<h2><a name="process_handling" href="#process_handling">Process handling</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.proc_create" href="#apr.proc_create"><code>apr.proc_create(program) → process</code></a></h3>

<p>Create a child process that will execute the given <tt><em>program</em></tt> when started.
Once you've called this function you still need to execute the process using
the <a href="#process:exec">process:exec()</a> function. Here&rsquo;s a simple example that emulates Lua&rsquo;s
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-os.execute">os.execute()</a> function:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">function</span>&nbsp;execute<span style="color: #2239a8; font-weight: bold">(</span>command<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;arguments&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.tokenize_to_argv" style="color: #0e7c6b; text-decoration: none">apr.tokenize_to_argv</a><span style="color: #2239a8; font-weight: bold">(</span>command<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;progname&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.remove" style="color: #0e7c6b; text-decoration: none">table.remove</a><span style="color: #2239a8; font-weight: bold">(</span>arguments<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;process&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.proc_create" style="color: #0e7c6b; text-decoration: none">apr.proc_create</a><span style="color: #2239a8; font-weight: bold">(</span>progname<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;process<span style="color: #2239a8; font-weight: bold">:</span>cmdtype_set<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'shellcmd/env'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;process<span style="color: #2239a8; font-weight: bold">:</span>exec<span style="color: #2239a8; font-weight: bold">(</span>arguments<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;done<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;code<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;why&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;process<span style="color: #2239a8; font-weight: bold">:</span>wait<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">true</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">return</span>&nbsp;code<br><span style="color: #2239a8; font-weight: bold">end</span><br><br>execute&nbsp;<span style="color: #a8660d">'echo&nbsp;This&nbsp;can&nbsp;be&nbsp;any&nbsp;process...'</span><br></pre>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="apr.proc_detach" href="#apr.proc_detach"><code>apr.proc_detach(daemonize) → status</code></a></h3>

<p>Detach the current process from the controlling terminal. If <tt><em>daemonize</em></tt>
evaluates to <tt><em>true</em></tt> the process will <a href="http://en.wikipedia.org/wiki/Daemon_%28computer_software%29">daemonize</a> and become a
background process, otherwise it will stay in the foreground. On success
<tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 85%<br></span> <a name="apr.proc_fork" href="#apr.proc_fork"><code>apr.proc_fork() → process, context</code></a></h3>

<p>This is currently the only non-portable function in APR and by extension
Lua/APR. It performs a <a href="http://linux.die.net/man/2/fork">standard UNIX fork</a>. If the fork succeeds a
<tt><em>process</em></tt> object and <tt><em>context</em></tt> string (<code>'parent'</code> or <code>'child'</code>) are returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned. The parent process
can use the returned <tt><em>process</em></tt> object to wait for the child process to die:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">if</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.proc_fork" style="color: #0e7c6b; text-decoration: none">apr.proc_fork</a>&nbsp;<span style="color: #2239a8; font-weight: bold">then</span>&nbsp;<span style="color: #558817">--&nbsp;forking&nbsp;supported?<br></span>&nbsp;&nbsp;process<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;context&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.proc_fork" style="color: #0e7c6b; text-decoration: none">apr.proc_fork</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;context&nbsp;<span style="color: #2239a8; font-weight: bold">==</span>&nbsp;<span style="color: #a8660d">'parent'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a>&nbsp;<span style="color: #a8660d">"Parent&nbsp;waiting&nbsp;for&nbsp;child.."</span><br>&nbsp;&nbsp;&nbsp;&nbsp;process<span style="color: #2239a8; font-weight: bold">:</span>wait<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">true</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a>&nbsp;<span style="color: #a8660d">"Parent&nbsp;is&nbsp;done!"</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">else</span>&nbsp;<span style="color: #558817">--&nbsp;context&nbsp;==&nbsp;'child'<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a>&nbsp;<span style="color: #a8660d">"Child&nbsp;simulating&nbsp;activity.."</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.sleep" style="color: #0e7c6b; text-decoration: none">apr.sleep</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">10</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a>&nbsp;<span style="color: #a8660d">"Child&nbsp;is&nbsp;done!"</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">end</span><br></pre>

<p>As the above example implies the <a href="#apr.proc_fork">apr.proc_fork()</a> function will only be
defined when forking is supported on the current platform.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="process:addrspace_set" href="#process:addrspace_set"><code>process:addrspace_set(separate) → status</code></a></h3>

<p>If <tt><em>separate</em></tt> evaluates to <tt><em>true</em></tt> the child process will start in its own
address space, otherwise the child process executes in the current address
space from its parent. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed
by an error message is returned. The default is no on NetWare and yes on
other platforms.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="process:user_set" href="#process:user_set"><code>process:user_set(username [, password]) → status</code></a></h3>

<p>Set the user under which the child process will run. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>On Windows and other platforms where <code>apr.user_set_requires_password</code> is
<tt><em>true</em></tt> this method <em>requires</em> a password.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="process:group_set" href="#process:group_set"><code>process:group_set(groupname) → status</code></a></h3>

<p>Set the group under which the child process will run. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="process:cmdtype_set" href="#process:cmdtype_set"><code>process:cmdtype_set(type) → status</code></a></h3>

<p>Set what type of command the child process will execute. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. The
argument <tt><em>type</em></tt> must be one of:</p>

<ul>
<li><code>'shellcmd'</code>: Use the shell to invoke the program</li>
<li><code>'shellcmd/env'</code>: Use the shell to invoke the program, replicating our environment</li>
<li><code>'program'</code>: Invoke the program directly, without copying the environment</li>
<li><code>'program/env'</code>: Invoke the program directly, replicating our environment</li>
<li><code>'program/env/path'</code>: Find program in <code>$PATH</code>, replicating our environment</li>
</ul>


<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 73%<br></span> <a name="process:env_set" href="#process:env_set"><code>process:env_set(environment) → status</code></a></h3>

<p>Set the environment variables of the child process to the key/value pairs in
the table <tt><em>environment</em></tt>. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt>
followed by an error message is returned.</p>

<p>Please note that the environment table is ignored for the command types
<code>'shellcmd/env'</code>, <code>'program/env'</code> and <code>'program/env/path'</code> (set using the
<a href="#process:cmdtype_set">process:cmdtype_set()</a> method).</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="process:dir_set" href="#process:dir_set"><code>process:dir_set(path) → status</code></a></h3>

<p>Set which directory the child process should start executing in. On success
<tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p>By default child processes inherit this directory from their parent process
at the moment when the <a href="#process:exec">process:exec()</a> call is made. To find out the
current directory see the <a href="#apr.filepath_get">apr.filepath_get()</a> function.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="process:detach_set" href="#process:detach_set"><code>process:detach_set(detach) → status</code></a></h3>

<p>Determine if the child should start in detached state. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. Default
is no.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="process:error_check_set" href="#process:error_check_set"><code>process:error_check_set(enabled) → nothing</code></a></h3>

<p>Specify that <a href="#process:exec">process:exec()</a> should do whatever it can to report failures
directly, rather than find out in the child that something is wrong. This
leads to extra overhead in the calling process, but it may help you handle
these errors more gracefully.</p>

<p>Note that this option is only useful on platforms where <a href="http://linux.die.net/man/2/fork">fork()</a> is
used.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="process:io_set" href="#process:io_set"><code>process:io_set(stdin, stdout, stderr) → status</code></a></h3>

<p>Determine if the child process should be linked to its parent through one or
more pipes. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<p>Each argument gives the blocking mode of a pipe, which can be one of the
following strings:</p>

<ul>
<li><code>'none'</code>: Don&rsquo;t create a pipe</li>
<li><code>'full-block'</code>: Create a pipe that blocks until the child process writes to the pipe or dies</li>
<li><code>'full-nonblock'</code>: Create a pipe that doesn&rsquo;t block</li>
<li><code>'parent-block'</code>: Create a pipe that only blocks on the parent&rsquo;s end</li>
<li><code>'child-block'</code>: Create a pipe that only blocks on the child&rsquo;s end</li>
</ul>


<p><em>Once the child process has been started</em> with <a href="#process:exec">process:exec()</a>, the pipes
can be accessed with the methods <a href="#process:in_get">process:in_get()</a>, <a href="#process:out_get">process:out_get()</a>
and <a href="#process:err_get">process:err_get()</a>.</p>

<p>Here&rsquo;s an example that executes the external command <code>tr a-z A-Z</code> to
translate some characters to uppercase:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;p&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.proc_create" style="color: #0e7c6b; text-decoration: none">apr.proc_create</a>&nbsp;<span style="color: #a8660d">'tr'</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;p<span style="color: #2239a8; font-weight: bold">:</span>cmdtype_set<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'shellcmd/env'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;p<span style="color: #2239a8; font-weight: bold">:</span>io_set<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'child-block'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'parent-block'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'none'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;p<span style="color: #2239a8; font-weight: bold">:</span>exec<span style="color: #2239a8; font-weight: bold">{</span><span style="color: #a8660d">'a-z'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'A-Z'</span><span style="color: #2239a8; font-weight: bold">}</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;input&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;p<span style="color: #2239a8; font-weight: bold">:</span>in_get<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;output&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;p<span style="color: #2239a8; font-weight: bold">:</span>out_get<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;input<span style="color: #2239a8; font-weight: bold">:</span>write<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'Testing,&nbsp;1,&nbsp;2,&nbsp;3<span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;input<span style="color: #2239a8; font-weight: bold">:</span>close<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span>output<span style="color: #2239a8; font-weight: bold">:</span>read<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>TESTING<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">3</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;output<span style="color: #2239a8; font-weight: bold">:</span>close<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;p<span style="color: #2239a8; font-weight: bold">:</span>wait<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">true</span><span style="color: #2239a8; font-weight: bold">)</span><br></pre>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="process:in_set" href="#process:in_set"><code>process:in_set(child_in [, parent_in]) → status</code></a></h3>

<p>Initialize the <a href="http://en.wikipedia.org/wiki/Standard_streams#Standard_input_.28stdin.29">standard input pipe</a> of the child process to an
existing pipe or a pair of pipes. This can be useful if you have already
opened a pipe (or multiple files) that you wish to use, perhaps persistently
across multiple process invocations &ndash; such as a log file. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. Here&rsquo;s
a basic example that connects two processes using an anonymous pipe:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #558817">--&nbsp;Create&nbsp;a&nbsp;gzip&nbsp;process&nbsp;to&nbsp;decompress&nbsp;the&nbsp;Lua&nbsp;source&nbsp;code&nbsp;archive.<br></span>gzip&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.proc_create" style="color: #0e7c6b; text-decoration: none">apr.proc_create</a>&nbsp;<span style="color: #a8660d">'gunzip'</span><br>gzip<span style="color: #2239a8; font-weight: bold">:</span>cmdtype_set&nbsp;<span style="color: #a8660d">'shellcmd/env'</span><br>gzip<span style="color: #2239a8; font-weight: bold">:</span>in_set<span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.file_open" style="color: #0e7c6b; text-decoration: none">apr.file_open</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'lua-5.1.4.tar.gz'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'rb'</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><br><span style="color: #558817">--&nbsp;Create&nbsp;a&nbsp;tar&nbsp;process&nbsp;to&nbsp;list&nbsp;the&nbsp;files&nbsp;in&nbsp;the&nbsp;decompressed&nbsp;archive.<br></span>tar&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.proc_create" style="color: #0e7c6b; text-decoration: none">apr.proc_create</a>&nbsp;<span style="color: #a8660d">'tar'</span><br>tar<span style="color: #2239a8; font-weight: bold">:</span>cmdtype_set&nbsp;<span style="color: #a8660d">'shellcmd/env'</span><br>tar<span style="color: #2239a8; font-weight: bold">:</span>out_set<span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.pipe_open_stdout" style="color: #0e7c6b; text-decoration: none">apr.pipe_open_stdout</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><br><span style="color: #558817">--&nbsp;Connect&nbsp;the&nbsp;two&nbsp;processes&nbsp;using&nbsp;an&nbsp;anonymous&nbsp;pipe.<br></span>input<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;output&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.pipe_create" style="color: #0e7c6b; text-decoration: none">apr.pipe_create</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>gzip<span style="color: #2239a8; font-weight: bold">:</span>out_set<span style="color: #2239a8; font-weight: bold">(</span>output<span style="color: #2239a8; font-weight: bold">)</span><br>tar<span style="color: #2239a8; font-weight: bold">:</span>in_set<span style="color: #2239a8; font-weight: bold">(</span>input<span style="color: #2239a8; font-weight: bold">)</span><br><br><span style="color: #558817">--&nbsp;Start&nbsp;the&nbsp;pipeline&nbsp;by&nbsp;executing&nbsp;both&nbsp;processes.<br></span>gzip<span style="color: #2239a8; font-weight: bold">:</span>exec<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br>tar<span style="color: #2239a8; font-weight: bold">:</span>exec<span style="color: #2239a8; font-weight: bold">{</span><span style="color: #a8660d">'-t'</span><span style="color: #2239a8; font-weight: bold">}</span><br></pre>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="process:out_set" href="#process:out_set"><code>process:out_set(child_out [, parent_out]) → status</code></a></h3>

<p>Initialize the <a href="http://en.wikipedia.org/wiki/Standard_streams#Standard_output_.28stdout.29">standard output pipe</a> of the child process to an
existing pipe or a pair of pipes. This can be useful if you have already
opened a pipe (or multiple files) that you wish to use, perhaps persistently
across multiple process invocations &ndash; such as a log file. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="process:err_set" href="#process:err_set"><code>process:err_set(child_err [, parent_err]) → status</code></a></h3>

<p>Initialize the <a href="http://en.wikipedia.org/wiki/Standard_streams#Standard_error_.28stderr.29">standard error pipe</a> of the child process to an
existing pipe or a pair of pipes. This can be useful if you have already
opened a pipe (or multiple files) that you wish to use, perhaps persistently
across multiple process invocations &ndash; such as a log file. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="process:in_get" href="#process:in_get"><code>process:in_get() → pipe</code></a></h3>

<p>Get the parent end of the standard input pipe (a writable pipe).</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="process:out_get" href="#process:out_get"><code>process:out_get() → pipe</code></a></h3>

<p>Get the parent end of the standard output pipe (a readable pipe).</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="process:err_get" href="#process:err_get"><code>process:err_get() → pipe</code></a></h3>

<p>Get the parent end of the standard error pipe (a readable pipe).</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 91%<br></span> <a name="process:exec" href="#process:exec"><code>process:exec([args]) → status</code></a></h3>

<p>Create the child process and execute a program or shell command inside it.
On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned. If the <tt><em>args</em></tt> array is given the contained strings become the
command line arguments to the child process. The <a href="http://en.wikipedia.org/wiki/BusyBox#Single_binary">program name</a>
for the child process defaults to the name passed into <a href="#apr.proc_create">apr.proc_create()</a>,
but you can change it by setting <code>args[0]</code>.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 73%<br></span> <a name="process:wait" href="#process:wait"><code>process:wait(how) → done [, why, code]</code></a></h3>

<p>Wait for the child process to die. If <tt><em>how</em></tt> is <tt><em>true</em></tt> the call blocks until the
process dies, otherwise the call returns immediately regardless of if the
process is dead or not. The first return value is <tt><em>false</em></tt> if the process isn&rsquo;t
dead yet. If it&rsquo;s <tt><em>true</em></tt> the process died and two more return values are
available. The second return value is the reason the process died, which is
one of:</p>

<ul>
<li><code>'exit'</code>: Process exited normally</li>
<li><code>'signal'</code>: Process exited due to a signal</li>
<li><code>'signal/core'</code>: Process exited and dumped <a href="http://en.wikipedia.org/wiki/Core_dump">a core file</a></li>
</ul>


<p>The third return value is the exit code of the process. If an error occurs a
<tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="process:kill" href="#process:kill"><code>process:kill(how) → status</code></a></h3>

<p>Terminate a running child process. On success <tt><em>true</em></tt> is returned, otherwise a
<tt><em>nil</em></tt> followed by an error message is returned. The parameter <tt><em>how</em></tt> must be one
of:</p>

<ul>
<li><code>'never'</code>: The process is never sent any signals</li>
<li><code>'always'</code>: The process is sent the <a href="http://en.wikipedia.org/wiki/SIGKILL">SIGKILL</a> signal when its
Lua userdata is garbage collected</li>
<li><code>'timeout'</code>: Send the <a href="http://en.wikipedia.org/wiki/SIGTERM">SIGTERM</a> signal, wait for 3 seconds,
then send the <a href="http://en.wikipedia.org/wiki/SIGKILL">SIGKILL</a> signal</li>
<li><code>'wait'</code>: Wait forever for the process to complete</li>
<li><code>'once'</code>: Send the <a href="http://en.wikipedia.org/wiki/SIGTERM">SIGTERM</a> signal and then wait</li>
</ul>


<h2><a name="shared_memory" href="#shared_memory">Shared memory</a></h2>

<p><a href="http://en.wikipedia.org/wiki/Shared_memory">Shared memory</a> is memory that may be simultaneously accessed by
multiple programs with an intent to provide communication among them. The
Lua/APR binding represents shared memory as file objects through the
<a href="#shm:read">shm:read()</a>, <a href="#shm:write">shm:write()</a> and <a href="#shm:seek">shm:seek()</a> methods.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 78%<br></span> <a name="apr.shm_create" href="#apr.shm_create"><code>apr.shm_create(filename, size) → shm object</code></a></h3>

<p>Create and make accessible a shared memory segment. The <tt><em>filename</em></tt> argument
is the file to use for shared memory on platforms that require it. The <tt><em>size</em></tt>
argument is the desired size of the segment.</p>

<p>A note about anonymous vs. named shared memory segments: Not all platforms
support anonymous shared memory segments, but in some cases it is preferred
over other types of shared memory implementations. Passing a <tt><em>nil</em></tt> <tt><em>filename</em></tt>
parameter to this function will cause the subsystem to use anonymous shared
memory segments. If such a system is not available, the error <code>'ENOTIMPL'</code>
is returned as the third return value (the first and second being <tt><em>nil</em></tt> and an
error message string).</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.shm_attach" href="#apr.shm_attach"><code>apr.shm_attach(filename) → shm object</code></a></h3>

<p>Attach to a shared memory segment that was created by another process. The
<tt><em>filename</em></tt> argument is the file used to create the original segment (this
must match the original filename). On success a shared memory object is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.shm_remove" href="#apr.shm_remove"><code>apr.shm_remove(filename) → status</code></a></h3>

<p>Remove the named resource associated with a shared memory segment,
preventing attachments to the resource, but not destroying it. On success
<tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p>This function is only supported on platforms which support name-based shared
memory segments, and will return the error code <code>'ENOTIMPL'</code> on platforms
without such support. Removing the file while the shared memory is in use is
not entirely portable, caller may use this to enhance obscurity of the
resource, but be prepared for the the call to fail, and for concurrent
attempts to create a resource of the same name to also fail.</p>

<p>Note that the named resource is also removed when a shared memory object
created by <a href="#apr.shm_create">apr.shm_create()</a> is garbage collected.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="shm:read" href="#shm:read"><code>shm:read([format, ...]) → mixed value, ...</code></a></h3>

<p><em>This function implements the interface of the <a href="http://www.lua.org/manual/5.1/manual.html#pdf-file:read">file:read()</a> function described in the Lua 5.1 reference manual. Here is the description from the reference manual:</em></p>

<p>Read from shared memory, according to the given formats, which specify what to read. For each format, the function returns a string (or a number) with the characters read, or <tt><em>nil</em></tt> if it cannot read data with the specified format. When called without formats, it uses a default format that reads the entire next line (see below).</p>

<p>The available formats are:</p>

<ul>
<li><code>'*n'</code>: reads a number; this is the only format that returns a number instead of a string</li>
<li><code>'*a'</code>: reads all data from the shared memory, starting at the current position. On end of input, it returns the empty string</li>
<li><code>'*l'</code>: reads the next line (skipping the end of line), returning <tt><em>nil</em></tt> on end of input (this is the default format)</li>
<li><code>number</code>: reads a string with up to this number of characters, returning <tt><em>nil</em></tt> on end of input. If number is zero, it reads nothing and returns an empty string, or <tt><em>nil</em></tt> on end of input</li>
</ul>


<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="shm:write" href="#shm:write"><code>shm:write(value [, ...]) → status</code></a></h3>

<p><em>This function implements the interface of the <a href="http://www.lua.org/manual/5.1/manual.html#pdf-file:write">file:write()</a> function described in the Lua 5.1 reference manual. Here is the description from the reference manual:</em></p>

<p>Write the value of each argument to shared memory. The arguments must be strings or numbers. To write other values, use <a href="http://www.lua.org/manual/5.1/manual.html#pdf-tostring">tostring()</a> or <a href="http://www.lua.org/manual/5.1/manual.html#pdf-string.format">string.format()</a> before this function.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 85%<br></span> <a name="shm:seek" href="#shm:seek"><code>shm:seek([whence [, offset]]) → offset</code></a></h3>

<p><em>This function implements the interface of the <a href="http://www.lua.org/manual/5.1/manual.html#pdf-file:seek">file:seek()</a> function described in the Lua 5.1 reference manual. Here is the description from the reference manual:</em></p>

<p>Sets and gets the shared memory position, measured from the beginning of the shared memory, to
the position given by <tt><em>offset</em></tt> plus a base specified by the string <tt><em>whence</em></tt>, as
follows:</p>

<ul>
<li><code>'set'</code>:  base is position 0 (beginning of the shared memory)</li>
<li><code>'cur'</code>:  base is current position</li>
<li><code>'end'</code>:  base is end of shared memory</li>
</ul>


<p>In case of success, function <code>seek</code> returns the final shared memory position, measured
in bytes from the beginning of the shared memory. If this function fails, it returns
<tt><em>nil</em></tt>, plus a string describing the error.</p>

<p>The default value for <tt><em>whence</em></tt> is <code>'cur'</code>, and for offset is 0. Therefore, the
call <a href="#shm:seek">shm:seek()</a> returns the current shared memory position, without changing it; the
call <code>shm:seek('set')</code> sets the position to the beginning of the shared memory (and
returns 0); and the call <code>shm:seek('end')</code> sets the position to the end of the
shared memory, and returns its size.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="shm:detach" href="#shm:detach"><code>shm:detach() → status</code></a></h3>

<p>Detach from a shared memory segment without destroying it. On success <tt><em>true</em></tt>
is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="shm:destroy" href="#shm:destroy"><code>shm:destroy() → status</code></a></h3>

<p>Destroy a shared memory segment and associated memory. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned. Note
that this will be done automatically when the shared memory object is
garbage collected and has not already been destroyed.</p>

<h2><a name="string_routines" href="#string_routines">String routines</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.strnatcmp" href="#apr.strnatcmp"><code>apr.strnatcmp(left, right) → status</code></a></h3>

<p>Do a <a href="http://sourcefrog.net/projects/natsort/">natural order comparison</a> of two strings. Returns <tt><em>true</em></tt> when
the <tt><em>left</em></tt> string is less than the <tt><em>right</em></tt> string, <tt><em>false</em></tt> otherwise. This
function can be used as a callback for Lua&rsquo;s standard library function
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.sort">table.sort()</a>.</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;the&nbsp;canonical&nbsp;example:<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;list&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #2239a8; font-weight: bold">{</span>&nbsp;<span style="color: #a8660d">'rfc1.txt'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'rfc2086.txt'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'rfc822.txt'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">}</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;collate&nbsp;order:<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.sort" style="color: #0e7c6b; text-decoration: none">table.sort</a><span style="color: #2239a8; font-weight: bold">(</span>list<span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">for</span>&nbsp;_<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;name&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-ipairs" style="color: #0e7c6b; text-decoration: none">ipairs</a><span style="color: #2239a8; font-weight: bold">(</span>list<span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span>name<span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>rfc1.txt<br>rfc2086.txt<br>rfc822.txt<br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;natural&nbsp;order:<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.sort" style="color: #0e7c6b; text-decoration: none">table.sort</a><span style="color: #2239a8; font-weight: bold">(</span>list<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.strnatcmp" style="color: #0e7c6b; text-decoration: none">apr.strnatcmp</a><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">for</span>&nbsp;_<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;name&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-ipairs" style="color: #0e7c6b; text-decoration: none">ipairs</a><span style="color: #2239a8; font-weight: bold">(</span>list<span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span>name<span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>rfc1.txt<br>rfc822.txt<br>rfc2086.txt<br></pre>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.strnatcasecmp" href="#apr.strnatcasecmp"><code>apr.strnatcasecmp(left, right) → status</code></a></h3>

<p>Like <a href="#apr.strnatcmp">apr.strnatcmp()</a>, but ignores the case of the strings.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.strfsize" href="#apr.strfsize"><code>apr.strfsize(number [, padding]) → readable</code></a></h3>

<p>Format a binary size positive <tt><em>number</em></tt> to a compacted human readable string.
If the optional <tt><em>padding</em></tt> argument evaluates to <tt><em>true</em></tt> the resulting string
will be padded with spaces to make it four characters wide, otherwise no
padding will be applied.</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.strfsize" style="color: #0e7c6b; text-decoration: none">apr.strfsize</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">1024</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'1.0K'</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.strfsize" style="color: #0e7c6b; text-decoration: none">apr.strfsize</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">1024</span>&nbsp;<span style="color: #2239a8; font-weight: bold">^</span>&nbsp;<span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'1.0M'</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.strfsize" style="color: #0e7c6b; text-decoration: none">apr.strfsize</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">1024</span>&nbsp;<span style="color: #2239a8; font-weight: bold">^</span>&nbsp;<span style="color: #a8660d">3</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'1.0G'</span><br></pre>

<p>Here&rsquo;s a simplified implementation of the <a href="http://en.wikipedia.org/wiki/Unix">UNIX</a> command <code>ls -l
--human-readable</code> which makes use of the <tt><em>padding</em></tt> argument to nicely line up
 the fields following the size:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">function</span>&nbsp;ls<span style="color: #2239a8; font-weight: bold">(</span>dirpath<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;directory&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.dir_open" style="color: #0e7c6b; text-decoration: none">apr.dir_open</a><span style="color: #2239a8; font-weight: bold">(</span>dirpath<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">for</span>&nbsp;info&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;directory<span style="color: #2239a8; font-weight: bold">:</span>entries<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.write" style="color: #0e7c6b; text-decoration: none">io.write</a><span style="color: #2239a8; font-weight: bold">(</span>info.protection<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'&nbsp;'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.write" style="color: #0e7c6b; text-decoration: none">io.write</a><span style="color: #2239a8; font-weight: bold">(</span>info.user<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'&nbsp;'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.write" style="color: #0e7c6b; text-decoration: none">io.write</a><span style="color: #2239a8; font-weight: bold">(</span>info.group<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'&nbsp;'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.write" style="color: #0e7c6b; text-decoration: none">io.write</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.strfsize" style="color: #0e7c6b; text-decoration: none">apr.strfsize</a><span style="color: #2239a8; font-weight: bold">(</span>info.size<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">true</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'&nbsp;'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.write" style="color: #0e7c6b; text-decoration: none">io.write</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.time_format" style="color: #0e7c6b; text-decoration: none">apr.time_format</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'<span style="color: #844631">%Y</span>-<span style="color: #844631">%m</span>-<span style="color: #844631">%d</span>&nbsp;<span style="color: #844631">%H</span>:<span style="color: #844631">%I</span>'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;info.ctime<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'&nbsp;'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.write" style="color: #0e7c6b; text-decoration: none">io.write</a><span style="color: #2239a8; font-weight: bold">(</span>info.name<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'<span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>directory<span style="color: #2239a8; font-weight: bold">:</span>close<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">end</span><br></pre>

<p>This is what the result looks like for the <a href="https://github.com/xolox/lua-apr/tree/master/src">source code directory</a>
of the Lua/APR project:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;ls&nbsp;<span style="color: #a8660d">'lua-apr/src'</span><br>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;5.4K&nbsp;2011-01-02&nbsp;22:10&nbsp;apr.lua<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;4.7K&nbsp;2011-01-02&nbsp;06:06&nbsp;base64.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;&nbsp;11K&nbsp;2010-10-27&nbsp;13:01&nbsp;buffer.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;&nbsp;13K&nbsp;2011-01-02&nbsp;21:09&nbsp;crypt.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;2.8K&nbsp;2010-12-31&nbsp;01:01&nbsp;date.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;9.4K&nbsp;2011-01-01&nbsp;16:04&nbsp;dbm.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;2.5K&nbsp;2010-09-25&nbsp;23:11&nbsp;env.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;&nbsp;17K&nbsp;2011-01-02&nbsp;22:10&nbsp;errno.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;&nbsp;10K&nbsp;2011-01-02&nbsp;22:10&nbsp;filepath.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;1.9K&nbsp;2011-01-02&nbsp;04:04&nbsp;fnmatch.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;&nbsp;12K&nbsp;2010-12-31&nbsp;01:01&nbsp;io_dir.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;&nbsp;25K&nbsp;2011-01-02&nbsp;04:04&nbsp;io_file.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;&nbsp;17K&nbsp;2010-12-31&nbsp;01:01&nbsp;io_net.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;4.6K&nbsp;2011-01-02&nbsp;22:10&nbsp;io_pipe.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;&nbsp;11K&nbsp;2011-01-02&nbsp;11:11&nbsp;lua_apr.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;9.0K&nbsp;2011-01-02&nbsp;11:11&nbsp;lua_apr.h<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;6.9K&nbsp;2010-12-29&nbsp;14:02&nbsp;permissions.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;&nbsp;26K&nbsp;2011-01-02&nbsp;22:10&nbsp;proc.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;866&nbsp;&nbsp;2010-10-23&nbsp;00:12&nbsp;refpool.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;4.8K&nbsp;2010-12-29&nbsp;14:02&nbsp;stat.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;3.5K&nbsp;2011-01-02&nbsp;22:10&nbsp;str.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;9.8K&nbsp;2010-12-31&nbsp;01:01&nbsp;time.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;4.7K&nbsp;2010-09-25&nbsp;23:11&nbsp;uri.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;2.5K&nbsp;2010-09-25&nbsp;23:11&nbsp;user.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;2.9K&nbsp;2010-10-22&nbsp;19:07&nbsp;uuid.c<br></span>rw<span style="color: #2239a8; font-weight: bold">-</span>r<span style="color: #558817">--r--&nbsp;peter&nbsp;peter&nbsp;3.8K&nbsp;2011-01-02&nbsp;04:04&nbsp;xlate.c<br></span></pre>

<p>Note: It seems that <a href="#apr.strfsize">apr.strfsize()</a> doesn&rsquo;t support terabyte range sizes.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.tokenize_to_argv" href="#apr.tokenize_to_argv"><code>apr.tokenize_to_argv(cmdline) → arguments</code></a></h3>

<p>Convert the string <tt><em>cmdline</em></tt> to a table of arguments. On success the table of
arguments is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p><em>This function is not binary safe.</em></p>

<h2><a name="multi_threading" href="#multi_threading">Multi threading</a></h2>

<p>This is an experimental multi threading module that makes it possible to
execute Lua functions in dedicated <a href="http://www.lua.org/manual/5.1/manual.html#lua_State">Lua states</a> and <a href="http://en.wikipedia.org/wiki/Thread_%2528computer_science%2529">operating
system threads</a>. When you create a thread you can pass it any
number of arguments and when a thread exits it can return any number of
return values. In both cases the following types are valid:</p>

<ul>
<li><tt><em>nil</em></tt></li>
<li>boolean</li>
<li>number</li>
<li>string (binary safe)</li>
<li>any userdata object created by the Lua/APR binding</li>
</ul>


<p>Please consider the following issues when using this module:</p>

<ul>
<li><p>When you pass a userdata object to another thread you shouldn&rsquo;t use it
from the original thread after that, because the Lua/APR binding doesn&rsquo;t
protect object access with a thread safe lock. This will probably be
fixed in the near future (hey, I said it was experimental)</p></li>
<li><p>When you start a thread and let it get garbage collected without having
called <a href="#thread:join">thread:join()</a>, the thread will be joined for you (because
failing to do so while the main thread is terminating can crash the
process)</p></li>
</ul>


<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 69%<br></span> <a name="apr.thread_create" href="#apr.thread_create"><code>apr.thread_create(code [, ...]) → thread</code></a></h3>

<p>Execute the Lua code in the string argument <tt><em>code</em></tt> in a dedicated Lua state
and operating system thread. Any extra arguments are passed onto the Lua
code (where they can be accessed with the expression <code>...</code>). On success a
thread object is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned. You can use <a href="#thread:join">thread:join()</a> to wait for the thread to finish and
get its return values.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.thread_yield" href="#apr.thread_yield"><code>apr.thread_yield() → nothing</code></a></h3>

<p>Force the current thread to yield the processor. This causes the currently
executing thread to temporarily pause and allow other threads to execute.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 78%<br></span> <a name="thread:join" href="#thread:join"><code>thread:join() → status [, result, ...]</code></a></h3>

<p>Block until a thread stops executing and return its result. If the thread
terminated with an error a <tt><em>nil</em></tt> followed by an error message is returned,
otherwise <tt><em>true</em></tt> is returned, followed by any return values of the thread
function.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="thread:status" href="#thread:status"><code>thread:status() → status</code></a></h3>

<p>Returns a string describing the state of the thread:</p>

<ul>
<li><code>'running'</code>: the thread is currently running</li>
<li><code>'done'</code>: the thread terminated successfully</li>
<li><code>'error'</code>: the thread encountered an error</li>
</ul>


<h2><a name="thread_queues" href="#thread_queues">Thread queues</a></h2>

<p>The valid types that can be transported through thread queues are documented
in the <a href="#multi_threading">multi threading</a> module.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 90%<br></span> <a name="apr.thread_queue" href="#apr.thread_queue"><code>apr.thread_queue([capacity]) → queue</code></a></h3>

<p>Create a <a href="http://en.wikipedia.org/wiki/FIFO">FIFO queue</a>. The optional argument <tt><em>capacity</em></tt> controls the
maximum size of the queue and defaults to 1. On success the queue object is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="queue:push" href="#queue:push"><code>queue:push(value [, ...]) → status</code></a></h3>

<p>Add a tuple of one or more values to the queue. This call will block if the
queue is full. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an
error message and error code is returned:</p>

<ul>
<li><code>'APR_EINTR'</code>: the blocking was interrupted (try again)</li>
<li><code>'APR_EOF'</code>: the queue has been terminated</li>
</ul>


<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="queue:pop" href="#queue:pop"><code>queue:pop() → value [, ...]</code></a></h3>

<p>Get an object from the queue. This call will block if the queue is empty. On
success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message and
error code is returned:</p>

<ul>
<li><code>'APR_EINTR'</code>: the blocking was interrupted (try again)</li>
<li><code>'APR_EOF'</code>: the queue has been terminated</li>
</ul>


<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="queue:trypush" href="#queue:trypush"><code>queue:trypush(value [, ...]) → status</code></a></h3>

<p>Add a tuple of one or more values to the queue. This call doesn&rsquo;t block if
the queue is full. On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by
an error message and error code is returned:</p>

<ul>
<li><code>'APR_EINTR'</code>: the blocking was interrupted (try again)</li>
<li><code>'APR_EAGAIN'</code>: the queue is full</li>
<li><code>'APR_EOF'</code>: the queue has been terminated</li>
</ul>


<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="queue:trypop" href="#queue:trypop"><code>queue:trypop() → value [, ...]</code></a></h3>

<p>Get an object from the queue. This call doesn&rsquo;t block if the queue is empty.
On success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message
and error code is returned:</p>

<ul>
<li><code>'APR_EINTR'</code>: the blocking was interrupted (try again)</li>
<li><code>'APR_EAGAIN'</code>: the queue is empty</li>
<li><code>'APR_EOF'</code>: the queue has been terminated</li>
</ul>


<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="queue:interrupt" href="#queue:interrupt"><code>queue:interrupt() → status</code></a></h3>

<p>Interrupt all the threads blocking on this queue. On success <tt><em>true</em></tt> is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="queue:terminate" href="#queue:terminate"><code>queue:terminate() → status</code></a></h3>

<p>Terminate the queue, sending an interrupt to all the blocking threads. On
success <tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="queue:close" href="#queue:close"><code>queue:close() → status</code></a></h3>

<p>Close the handle <tt><em>queue</em></tt> and (if no other threads are using the queue)
destroy the queue and release the associated memory. This function always
returns <tt><em>true</em></tt> (it cannot fail).</p>

<p>This will be done automatically when the <tt><em>queue</em></tt> object is garbage collected
which means you don&rsquo;t need to call this unless you want to reclaim memory as
soon as possible.</p>

<h2><a name="time_routines" href="#time_routines">Time routines</a></h2>

<p>Lua represents dates as numbers though the meaning of these numbers is not
specified. The manual does state (in the documentation for <a href="http://www.lua.org/manual/5.1/manual.html#pdf-os.time">os.time()</a>) that
on <a href="http://en.wikipedia.org/wiki/POSIX">POSIX</a>, Windows and some other systems these numbers count the
number of seconds since some given start time called the epoch. This epoch
is 00:00:00 January 1, 1970 <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a>. The Apache Portable Runtime
<a href="http://apr.apache.org/docs/apr/trunk/group__apr__time.html#gdb4bde16055748190eae190c55aa02bb">represents</a> dates as the number of microseconds since that
same epoch. As a compromise between the two units Lua/APR uses seconds but
supports sub-second resolution in the decimal part of floating point numbers
(see <a href="http://lua-users.org/lists/lua-l/2007-03/threads.html#00309">this thread</a> on <a href="http://lua-users.org/lists/lua-l/">lua-l</a> for discussion about the
API).</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.sleep" href="#apr.sleep"><code>apr.sleep(seconds) → nothing</code></a></h3>

<p>Sleep for the specified number of <tt><em>seconds</em></tt>. Sub-second resolution is
supported so you can for example give 0.5 to sleep for half a second. This
function may sleep for longer than the specified time because of platform
limitations.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.time_now" href="#apr.time_now"><code>apr.time_now() → time</code></a></h3>

<p>Get the current time as the number of seconds since 00:00:00 January 1, 1970
<a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a>. If Lua is compiled with floating point support then more
precision will be available in the decimal part of the returned number.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 87%<br></span> <a name="apr.time_explode" href="#apr.time_explode"><code>apr.time_explode([time [, timezone]]) → components</code></a></h3>

<p>Convert the numeric value <tt><em>time</em></tt> (current time if none given) to its human
readable components. If <tt><em>timezone</em></tt> isn&rsquo;t given or evaluates to <tt><em>false</em></tt> the
local timezone is used. If its a number then this number is used as the
offset in seconds from <a href="http://en.wikipedia.org/wiki/Greenwich_Mean_Time">GMT</a>. The value <tt><em>true</em></tt> is treated the same as 0,
i.e. GMT. On success the table of components is returned, otherwise a <tt><em>nil</em></tt>
followed by an error message is returned. The resulting table contains the
following fields:</p>

<ul>
<li><code>usec</code> is the number of microseconds past <code>sec</code></li>
<li><code>sec</code> is the number of seconds past <code>min</code> (0-61)</li>
<li><code>min</code> is the number of minutes past <code>hour</code> (0-59)</li>
<li><code>hour</code> is the number of hours past midnight (0-23)</li>
<li><code>day</code> is the day of the month (1-31)</li>
<li><code>month</code> is the month of the year (0-11).</li>
<li><code>year</code> is the year since 1900</li>
<li><code>wday</code> is the number of days since Sunday (0-6)</li>
<li><code>yday</code> is the number of days since January 1 (0-365)</li>
<li><code>gmtoff</code> is the number of seconds east of <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a></li>
<li><code>isdst</code> is <tt><em>true</em></tt> when <a href="http://en.wikipedia.org/wiki/Daylight_saving_time">daylight saving time</a> is in effect</li>
</ul>


<p>All of these fields are numbers except for <code>isdst</code> which is a boolean.
Here&rsquo;s an example of the output returned by <a href="#apr.time_explode">apr.time_explode()</a>:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;Note&nbsp;that&nbsp;numeric&nbsp;dates&nbsp;are&nbsp;always&nbsp;in&nbsp;UTC&nbsp;while&nbsp;tables&nbsp;with<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;date&nbsp;components&nbsp;are&nbsp;in&nbsp;the&nbsp;local&nbsp;timezone&nbsp;by&nbsp;default.<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;components&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.time_explode" style="color: #0e7c6b; text-decoration: none">apr.time_explode</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">1032030336.18671</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;components<br><span style="color: #2239a8; font-weight: bold">{</span><br>&nbsp;usec&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">186710</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;sec&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">36</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;min&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">5</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;hour&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">21</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;day&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">14</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;month&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">9</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;year&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">2002</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;wday&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">7</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;yday&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">257</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;gmtoff&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">7200</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #558817">--&nbsp;my&nbsp;local&nbsp;timezone<br></span>&nbsp;isdst&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">true</span><span style="color: #2239a8; font-weight: bold">,</span><br><span style="color: #2239a8; font-weight: bold">}</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;To&nbsp;convert&nbsp;a&nbsp;table&nbsp;of&nbsp;date&nbsp;components&nbsp;back&nbsp;into&nbsp;a&nbsp;number<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #558817">--&nbsp;you&nbsp;can&nbsp;use&nbsp;the&nbsp;apr.time_implode()&nbsp;function&nbsp;as&nbsp;follows:<br></span><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.time_implode" style="color: #0e7c6b; text-decoration: none">apr.time_implode</a><span style="color: #2239a8; font-weight: bold">(</span>components<span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">1032030336.18671</span><br></pre>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 85%<br></span> <a name="apr.time_implode" href="#apr.time_implode"><code>apr.time_implode(components) → time</code></a></h3>

<p>Convert a table of time <tt><em>components</em></tt> to its numeric value. On success the
time is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.
See <a href="#apr.time_explode">apr.time_explode()</a> for a list of supported components.</p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 69%<br></span> <a name="apr.time_format" href="#apr.time_format"><code>apr.time_format(format [, time]) → formatted</code></a></h3>

<p>Format <tt><em>time</em></tt> (current time if none given) according to string <tt><em>format</em></tt>. On
success the formatted time is returned, otherwise a <tt><em>nil</em></tt> followed by an error
message is returned. The two special formats <code>'ctime'</code> and <code>'rfc822'</code> result
in a fixed length string of 24 or 29 characters in length. The <tt><em>time</em></tt>
argument may be either a number or a table with components like those
returned by <a href="#apr.time_explode">apr.time_explode()</a>.</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.time_format" style="color: #0e7c6b; text-decoration: none">apr.time_format</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'<span style="color: #844631">%Y</span>-<span style="color: #844631">%m</span>-<span style="color: #844631">%d</span>&nbsp;<span style="color: #844631">%H</span>:<span style="color: #844631">%I</span>:<span style="color: #844631">%S</span>'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.time_now" style="color: #0e7c6b; text-decoration: none">apr.time_now</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'2010-09-25&nbsp;17:05:08'</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.time_format" style="color: #0e7c6b; text-decoration: none">apr.time_format</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'ctime'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.time_now" style="color: #0e7c6b; text-decoration: none">apr.time_now</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'Sat&nbsp;Sep&nbsp;25&nbsp;17:26:22&nbsp;2010'</span><br><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.time_format" style="color: #0e7c6b; text-decoration: none">apr.time_format</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'rfc822'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.time_now" style="color: #0e7c6b; text-decoration: none">apr.time_now</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'Sat,&nbsp;25&nbsp;Sep&nbsp;2010&nbsp;15:26:36&nbsp;GMT'</span><br></pre>

<p><em>This function is not binary safe.</em></p>

<h2><a name="uniform_resource_identifier_parsing" href="#uniform_resource_identifier_parsing">Uniform resource identifier parsing</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 93%<br></span> <a name="apr.uri_parse" href="#apr.uri_parse"><code>apr.uri_parse(uri) → components</code></a></h3>

<p>Parse the <a href="http://en.wikipedia.org/wiki/Uniform_Resource_Identifier">Uniform Resource Identifier</a> <tt><em>uri</em></tt>. On success a table of
components is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned. The table of components can have the following fields, all
strings:</p>

<ul>
<li><code>scheme</code> is the part of the URI before <code>://</code> (as in <code>http</code>, <code>ftp</code>, etc.)</li>
<li><code>user</code> is the user name, as in <code>scheme://user:pass@host:port/</code></li>
<li><code>password</code> is the password, as in <code>scheme://user:pass@host:port/</code></li>
<li><code>hostinfo</code> is the combined <code>[user[:password]@]hostname[:port]</code></li>
<li><code>hostname</code> is the host name or IP address</li>
<li><code>port</code> is the port number</li>
<li><code>path</code> is the request path (<code>/</code> if only <code>scheme://hostname</code> was given)</li>
<li><code>query</code> is everything after a <code>?</code> in the path, if present</li>
<li><code>fragment</code> is the trailing <code>#fragment</code> string, if present</li>
</ul>


<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.uri_unparse" href="#apr.uri_unparse"><code>apr.uri_unparse(components [, option]) → uri</code></a></h3>

<p>Convert a table of <a href="http://en.wikipedia.org/wiki/Uniform_Resource_Identifier">URI</a> <tt><em>components</em></tt> into a URI string. On success the
URI string is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned. The list of fields in the <tt><em>components</em></tt> table is available in the
documentation for <a href="#apr.uri_parse">apr.uri_parse()</a>. The argument <tt><em>option</em></tt> may be one of the
following:</p>

<ul>
<li><code>hostinfo</code> to unparse the components <code>[user[:password]@]hostname[:port]</code></li>
<li><code>pathinfo</code> to unparse the components <code>path[?query[#fragment]]</code></li>
</ul>


<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 85%<br></span> <a name="apr.uri_port_of_scheme" href="#apr.uri_port_of_scheme"><code>apr.uri_port_of_scheme(scheme) → port</code></a></h3>

<p>Return the default port for the given <a href="http://en.wikipedia.org/wiki/Uniform_Resource_Identifier">URI</a> <tt><em>scheme</em></tt> string. <a href="http://svn.apache.org/viewvc/apr/apr/trunk/uri/apr_uri.c?view=markup#l43">Since at
least APR 1.2.8</a> the following schemes are supported: <code>acap</code>,
<code>ftp</code>, <code>gopher</code>, <code>http</code>, <code>https</code>, <code>imap</code>, <code>ldap</code>, <code>nfs</code>, <code>nntp</code>, <code>pop</code>,
<code>prospero</code>, <code>rtsp</code>, <code>sip</code>, <code>snews</code>, <code>ssh</code>, <code>telnet</code>, <code>tip</code>, <code>wais</code>,
<code>z39.50r</code> and <code>z39.50s</code>.</p>

<h2><a name="user_group_identification" href="#user_group_identification">User/group identification</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 91%<br></span> <a name="apr.user_get" href="#apr.user_get"><code>apr.user_get() → username, groupname</code></a></h3>

<p>Get the username and groupname of the calling process. On success the
username and groupname are returned, otherwise a <tt><em>nil</em></tt> followed by an error
message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 87%<br></span> <a name="apr.user_homepath_get" href="#apr.user_homepath_get"><code>apr.user_homepath_get(username) → homepath</code></a></h3>

<p>Get the <a href="http://en.wikipedia.org/wiki/Home_directory">home directory</a> for the named user. On success the directory
pathname is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p><em>This function is not binary safe.</em></p>

<h2><a name="universally_unique_identifiers" href="#universally_unique_identifiers">Universally unique identifiers</a></h2>

<p><a href="http://en.wikipedia.org/wiki/Universally_unique_identifier">Universally unique identifiers</a> are a standard for generating unique
strings that are specific to the machine on which they are generated and/or
the time at which they are generated. They can be used as primary keys in
databases and are used to uniquely identify file system types and instances
on modern operating systems. This is what a standard format UUID looks like:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.uuid_format" style="color: #0e7c6b; text-decoration: none">apr.uuid_format</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.uuid_get" style="color: #0e7c6b; text-decoration: none">apr.uuid_get</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'0ad5d4a4-591e-41f7-8be4-07d7961a8079'</span><br></pre>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.uuid_get" href="#apr.uuid_get"><code>apr.uuid_get() → binary</code></a></h3>

<p>Generate and return a UUID as a binary string of 16 bytes.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 75%<br></span> <a name="apr.uuid_format" href="#apr.uuid_format"><code>apr.uuid_format(binary) → formatted</code></a></h3>

<p>Format a UUID of 16 bytes following the standard format of 32 hexadecimal
digits, displayed in 5 groups separated by hyphens, in the form <code>8-4-4-4-12</code>
for a total of 36 characters, like <code>f5dc3464-6c8f-654e-a407-b15b7a30f038</code>.
On success the formatted UUID is returned, otherwise a <tt><em>nil</em></tt> followed by an
error message is returned.</p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 70%<br></span> <a name="apr.uuid_parse" href="#apr.uuid_parse"><code>apr.uuid_parse(formatted) → binary</code></a></h3>

<p>Parse a standard format UUID and return its 16-byte equivalent. On success
the parsed UUID is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<h2><a name="character_encoding_translation" href="#character_encoding_translation">Character encoding translation</a></h2>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 71%<br></span> <a name="apr.xlate" href="#apr.xlate"><code>apr.xlate(input, from, to) → translated</code></a></h3>

<p>Translate a string of text from one <a href="http://en.wikipedia.org/wiki/Character_encoding">character encoding</a> to
another. The <tt><em>from</em></tt> and <tt><em>to</em></tt> arguments are strings identifying the source and
target character encoding. The special value <code>'locale'</code> indicates the
character set of the <a href="http://en.wikipedia.org/wiki/Locale">current locale</a>. On success the translated
string is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is
returned.</p>

<p>Which character encodings are supported by <a href="#apr.xlate">apr.xlate()</a> is system dependent
because APR can use both the system&rsquo;s <a href="http://en.wikipedia.org/wiki/Iconv">iconv</a> implementation and the
bundled library <a href="http://apr.apache.org/docs/apr-iconv/trunk/group__apr__iconv.html">apr-iconv</a>. To get a list of valid character
encoding names you can look through the <a href="http://svn.apache.org/viewvc/apr/apr-iconv/trunk/ccs/">apr-iconv/ccs</a> and
<a href="http://svn.apache.org/viewvc/apr/apr-iconv/trunk/ces/">apr-iconv/ces</a> directories (those are links to the web
interface of the apr-iconv repository).</p>

<p><em>This function is binary safe.</em></p>

<h2><a name="xml_parsing" href="#xml_parsing">XML parsing</a></h2>

<p>This module enables parsing of <a href="http://en.wikipedia.org/wiki/XML">XML</a> documents. Unlike <a href="http://www.keplerproject.org/luaexpat/">LuaExpat</a> the parsers returned by <a href="#apr.xml">apr.xml()</a> don&rsquo;t use callbacks, instead they
parse XML into a <a href="http://en.wikipedia.org/wiki/XML#Document_Object_Model_.28DOM.29">document object model</a> which is then exposed to Lua.
Because of this you can&rsquo;t use <a href="#apr.xml">apr.xml()</a> for incremental parsing. To parse
an XML document you follow these steps:</p>

<ol>
<li>Create an XML parser object by calling <a href="#apr.xml">apr.xml()</a></li>
<li>Parse the document by calling <a href="#xml_parser:feed">xml_parser:feed()</a> repeatedly until the
full document has been parsed</li>
<li>Signal to the parser that the full document has been parsed by calling
<a href="#xml_parser:done">xml_parser:done()</a></li>
<li>Get the parse information by calling <a href="#xml_parser:getinfo">xml_parser:getinfo()</a></li>
</ol>


<p>Right now the only way to get the parse information is by calling
<a href="#xml_parser:getinfo">xml_parser:getinfo()</a> which converts the information to a Lua table
following the <a href="http://www.keplerproject.org/luaexpat/lom.html">Lua object model</a> defined by <a href="http://www.keplerproject.org/luaexpat/">LuaExpat</a>. The Lua
object model is a mapping of XML to Lua tables that&rsquo;s not 100% complete
(e.g. it doesn&rsquo;t include namespaces) but makes it a lot easier to deal with
XML in Lua.</p>

<p>In the future this module might expose the full XML parse tree to Lua as
userdata objects, so that Lua has access to all parse information. This
would also make it possible to expose the <a href="http://apr.apache.org/docs/apr/trunk/group___a_p_r___util___x_m_l.html#g4485edce130dc1e9a3da3a633a75ffb3">apr_xml_to_text()</a> function.</p>

<h3><span style="float: right; font-size: small; color: orange; opacity: 0.5">test coverage: 70%<br></span> <a name="apr.xml" href="#apr.xml"><code>apr.xml([filename]) → xml_parser</code></a></h3>

<p>Create an XML parser. If the optional string <tt><em>filename</em></tt> is given, the file
pointed to by <tt><em>filename</em></tt> will be parsed. On success the parser object is
returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is not binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="xml_parser:feed" href="#xml_parser:feed"><code>xml_parser:feed(input) → status</code></a></h3>

<p>Feed the string <tt><em>input</em></tt> into the XML parser. On success <tt><em>true</em></tt> is returned,
otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<p><em>This function is binary safe.</em></p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="xml_parser:done" href="#xml_parser:done"><code>xml_parser:done() → status</code></a></h3>

<p>Terminate the parsing and save the resulting parse information. On success
<tt><em>true</em></tt> is returned, otherwise a <tt><em>nil</em></tt> followed by an error message is returned.</p>

<h3><span style="float: right; font-size: small; color: red; opacity: 0.5">test coverage: none<br></span> <a name="xml_parser:geterror" href="#xml_parser:geterror"><code>xml_parser:geterror() → message</code></a></h3>

<p>Fetch additional error information from the parser after one of its methods
has failed.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="xml_parser:getinfo" href="#xml_parser:getinfo"><code>xml_parser:getinfo() → table</code></a></h3>

<p>Convert the parse information to a Lua table following the
<a href="http://www.keplerproject.org/luaexpat/lom.html">Lua Object Model</a> defined by <a href="http://www.keplerproject.org/luaexpat/">LuaExpat</a>.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="xml_parser:close" href="#xml_parser:close"><code>xml_parser:close() → status</code></a></h3>

<p>Close the XML parser and destroy any parse information. This will be done
automatically when the <tt><em>xml_parser</em></tt> object is garbage collected which means
you don&rsquo;t need to call this unless you want to reclaim memory as soon as
possible (e.g. because you just parsed a large XML document).</p>

<h2><a name="miscellaneous_functions" href="#miscellaneous_functions">Miscellaneous functions</a></h2>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.platform_get" href="#apr.platform_get"><code>apr.platform_get() → name</code></a></h3>

<p>Get the name of the platform for which the Lua/APR binding was compiled.
Returns one of the following strings:</p>

<ul>
<li><code>'UNIX'</code></li>
<li><code>'WIN32'</code></li>
<li><code>'NETWARE'</code></li>
<li><code>'OS2'</code></li>
</ul>


<p>Please note that the labels returned by <a href="#apr.platform_get">apr.platform_get()</a> don&rsquo;t imply
that these platforms are fully supported; the author of the Lua/APR binding
doesn&rsquo;t have NETWARE and OS2 environments available for testing.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.version_get" href="#apr.version_get"><code>apr.version_get() → apr_version [, apu_version]</code></a></h3>

<p>Get the version number of the Apache Portable Runtime as a string. The
string contains three numbers separated by dots. These numbers have the
following meaning:</p>

<ul>
<li>The 1st number is used for major <a href="http://en.wikipedia.org/wiki/Application_programming_interface">API</a> changes that can cause
compatibility problems between the Lua/APR binding and APR library</li>
<li>The 2nd number is used for minor API changes that shouldn&rsquo;t impact
existing functionality in the Lua/APR binding</li>
<li>The 3rd number is used exclusively for bug fixes</li>
</ul>


<p>The second return value, the version number of the APR utility library, is
only available when Lua/APR is compiled against APR 1.x because in APR 2.x
the utility library has been absorbed back into the APR library; there is no
longer a distinction between the APR core and APR utility libraries.</p>

<p>This function can be useful when you want to know whether a certain bug fix
has been applied to APR and/or APR-util or if you want to report a bug in
APR, APR-util or the Lua/APR binding.</p>

<p>If you're looking for the version of the Lua/APR binding you can use the
<code>apr._VERSION</code> string, but note that Lua/APR currently does not adhere to
the above versioning rules.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.os_default_encoding" href="#apr.os_default_encoding"><code>apr.os_default_encoding() → name</code></a></h3>

<p>Get the name of the system default character set as a string.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 100%<br></span> <a name="apr.os_locale_encoding" href="#apr.os_locale_encoding"><code>apr.os_locale_encoding() → name</code></a></h3>

<p>Get the name of the current locale character set as a string. If the current
locale&rsquo;s data cannot be retrieved on this system, the name of the system
default character set is returned instead.</p>

<h3><span style="float: right; font-size: small; color: green; opacity: 0.5">test coverage: 88%<br></span> <a name="apr.type" href="#apr.type"><code>apr.type(object) → name</code></a></h3>

<p>Return the type of a userdata object created by the Lua/APR binding. If
<tt><em>object</em></tt> is of a known type one of the following strings will be returned,
otherwise nothing is returned:</p>

<ul>
<li><code>'file'</code></li>
<li><code>'directory'</code></li>
<li><code>'socket'</code></li>
<li><code>'thread'</code></li>
<li><code>'process'</code></li>
<li><code>'dbm'</code></li>
<li><code>'database driver'</code></li>
<li><code>'prepared statement'</code></li>
<li><code>'result set'</code></li>
<li><code>'memcache client'</code></li>
<li><code>'memcache server'</code></li>
<li><code>'md5 context'</code></li>
<li><code>'sha1 context'</code></li>
<li><code>'xml parser'</code></li>
</ul>


<h2><a name="file_system_permissions" href="#file_system_permissions">File system permissions</a></h2>

<p>The Apache Portable Runtime represents file system permissions somewhat
similar to those of <a href="http://en.wikipedia.org/wiki/Unix">UNIX</a>. There are three categories of
permissions: the user, the group and everyone else (the world). Each
category supports read and write permission bits while the meaning of the
third permission bit differs between categories.</p>

<h3>How Lua/APR presents permissions</h3>

<p>The Lua/APR binding uses a string of 9 characters to represent file system
permissions such as those returned by <a href="#apr.stat">apr.stat()</a>. Here&rsquo;s an example:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.stat" style="color: #0e7c6b; text-decoration: none">apr.stat</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'.'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'protection'</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #a8660d">'rwxr-xr-x'</span><br></pre>

<p>This is the syntax of these permissions strings:</p>

<ul>
<li>Character 1: <code>r</code> if the user has read permissions, <code>-</code> otherwise</li>
<li>Character 2: <code>w</code> if the user has write permissions, <code>-</code> otherwise</li>
<li>Character 3: <code>x</code> if the user has execute permissions, <code>S</code> if the user
has set user id permissions or <code>s</code> if the user has both permissions</li>
<li>Characters 4..6: the same respective permissions for the group</li>
<li>Characters 7..8: the same respective permissions for the world</li>
<li>Character 9: <code>x</code> if the world has execute permissions, <code>T</code> if the world
has sticky permissions or <code>t</code> if the world has both permissions</li>
</ul>


<p>As an example, <code>rwxrwx---</code> means the user and group have full permissions
while the world has none. Another example: <code>r-xr-xr-x</code> means no-one has
write permissions.</p>

<h3>How you can request permissions</h3>

<p>When you need to request file system permissions for an operation like
<a href="#apr.file_open">reading</a> or <a href="#apr.file_copy">copying</a> a file there are two
string formats you can use. The first format is a string of nine characters
that lists each permission explicitly. This is the format documented above.</p>

<p>The second format is very flexible and is one of the formats accepted by the
Linux command line program <a href="http://en.wikipedia.org/wiki/chmod">chmod</a>. The permissions are split in
three groups with a one-letter code: user is <code>u</code>, group is <code>g</code> and world is
<code>o</code> (for &ldquo;others&rdquo;). One or more permissions can then be assigned to one or
more of these groups. Here&rsquo;s an example that requests read permission for
user, group and others: <code>ugo=r</code>. Now when you also need write permission for
user and group, you can use <code>ugo=r,ug=w</code>.</p>

<h2><a name="error_handling" href="#error_handling">Error handling</a></h2>

<p>Most functions in the Lua/APR binding follow the Lua idiom of returning <tt><em>nil</em></tt>
followed by an error message string. These functions also return a third
argument which is the symbolic name of the error (or the error code in case
a symbolic name cannot be determined). The following symbolic names are
currently defined (there&rsquo;s actually a lot more but they shouldn&rsquo;t be
relevant when working in Lua):</p>

<ul>
<li><code>'ENOSTAT'</code>: APR was unable to perform a stat on the file</li>
<li><code>'EBADDATE'</code>: APR was given an invalid date</li>
<li><code>'EINVALSOCK'</code>: APR was given an invalid socket</li>
<li><code>'ENOPROC'</code>: APR was not given a process structure</li>
<li><code>'ENOTIME'</code>: APR was not given a time structure</li>
<li><code>'ENODIR'</code>: APR was not given a directory structure</li>
<li><code>'ENOTHREAD'</code>: APR was not given a thread structure</li>
<li><code>'EBADIP'</code>: the specified IP address is invalid</li>
<li><code>'EBADMASK'</code>: the specified netmask is invalid</li>
<li><code>'EDSOOPEN'</code>: APR was unable to open the DSO object</li>
<li><code>'EABSOLUTE'</code>: the given path was absolute</li>
<li><code>'ERELATIVE'</code>: the given path was relative</li>
<li><code>'EINCOMPLETE'</code>: the given path was neither relative nor absolute</li>
<li><code>'EABOVEROOT'</code>: the given path was above the root path</li>
<li><code>'EBADPATH'</code>: the given path was bad</li>
<li><code>'EPATHWILD'</code>: the given path contained wildcards</li>
<li><code>'ESYMNOTFOUND'</code>: could not find the requested symbol</li>
<li><code>'EPROC_UNKNOWN'</code>: the given process was not recognized by APR</li>
<li><code>'ENOTENOUGHENTROPY'</code>: APR could not gather enough <a href="http://en.wikipedia.org/wiki/Entropy_%2528computing%2529">entropy</a> to continue</li>
<li><code>'TIMEUP'</code>: the operation did not finish before the timeout</li>
<li><code>'INCOMPLETE'</code>: the operation was incomplete although some processing was performed and the results are partially valid</li>
<li><code>'EOF'</code>: APR has encountered the end of the file</li>
<li><code>'ENOTIMPL'</code>: the APR function has not been implemented on this platform, either because nobody has gotten to it yet, or the function is impossible on this platform</li>
<li><code>'EMISMATCH'</code>: two passwords do not match</li>
<li><code>'EACCES'</code>: permission denied</li>
<li><code>'EEXIST'</code>: file exists</li>
<li><code>'ENAMETOOLONG'</code>: path name is too long</li>
<li><code>'ENOENT'</code>: no such file or directory</li>
<li><code>'ENOTDIR'</code>: not a directory</li>
<li><code>'ENOSPC'</code>: no space left on device</li>
<li><code>'ENOMEM'</code>: not enough memory</li>
<li><code>'EMFILE'</code>: too many open files</li>
<li><code>'ENFILE'</code>: file table overflow</li>
<li><code>'EBADF'</code>: bad file number</li>
<li><code>'EINVAL'</code>: invalid argument</li>
<li><code>'ESPIPE'</code>: illegal seek</li>
<li><code>'EAGAIN'</code>: operation would block</li>
<li><code>'EINTR'</code>: interrupted system call</li>
<li><code>'ENOTSOCK'</code>: socket operation on a non-socket</li>
<li><code>'ECONNREFUSED'</code>: connection refused</li>
<li><code>'EINPROGRESS'</code>: operation now in progress</li>
<li><code>'ECONNABORTED'</code>: software caused connection abort</li>
<li><code>'ECONNRESET'</code>: connection Reset by peer</li>
<li><code>'ETIMEDOUT'</code>: operation timed out (deprecated)</li>
<li><code>'EHOSTUNREACH'</code>: no route to host</li>
<li><code>'ENETUNREACH'</code>: network is unreachable</li>
<li><code>'EFTYPE'</code>: inappropriate file type or format</li>
<li><code>'EPIPE'</code>: broken pipe</li>
<li><code>'EXDEV'</code>: cross device link</li>
<li><code>'ENOTEMPTY'</code>: directory not empty</li>
<li><code>'EAFNOSUPPORT'</code>: address family not supported</li>
</ul>


<p>Note that the error descriptions above were copied verbatim from <a href="http://svn.apache.org/viewvc/apr/apr/trunk/include/apr_errno.h?view=markup">apr_errno.h</a>.</p>

<h2><a name="example_http_client" href="#example_http_client">Example: HTTP client</a></h2>

<p>The following Lua script implements a minimal <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP client</a> which can
be used to download a given <a href="http://en.wikipedia.org/wiki/Uniform_Resource_Locator">URL</a> on the command line (comparable to
<a href="http://en.wikipedia.org/wiki/wget">wget</a> and <a href="http://en.wikipedia.org/wiki/cURL">curl</a>):</p>

<pre style="color: black; background: white" class="sourcecode lua">$&nbsp;FILE<span style="color: #2239a8; font-weight: bold">=</span>lua<span style="color: #2239a8; font-weight: bold">-</span><span style="color: #a8660d">5.1</span><span style="color: #a8660d">.4</span><span style="color: #2239a8; font-weight: bold">.</span>tar.gz<br>$&nbsp;URL<span style="color: #2239a8; font-weight: bold">=</span>http<span style="color: #2239a8; font-weight: bold">:</span><span style="color: #2239a8; font-weight: bold">/</span><span style="color: #2239a8; font-weight: bold">/</span>www.lua.org<span style="color: #2239a8; font-weight: bold">/</span>ftp<span style="color: #2239a8; font-weight: bold">/</span>$FILE<br>$&nbsp;time&nbsp;curl&nbsp;<span style="color: #2239a8; font-weight: bold">-</span>s&nbsp;$URL&nbsp;<span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;$FILE<br><span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">,</span><span style="color: #a8660d">01</span>s&nbsp;user&nbsp;<span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">,</span><span style="color: #a8660d">02</span>s&nbsp;system&nbsp;<span style="color: #a8660d">6</span><span style="color: #2239a8; font-weight: bold">%</span>&nbsp;cpu&nbsp;<span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">,</span><span style="color: #a8660d">465</span>&nbsp;total<br>$&nbsp;time&nbsp;lua&nbsp;examples<span style="color: #2239a8; font-weight: bold">/</span>download.lua&nbsp;$URL&nbsp;<span style="color: #2239a8; font-weight: bold">&gt;</span>&nbsp;$FILE<br><span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">,</span><span style="color: #a8660d">03</span>s&nbsp;user&nbsp;<span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">,</span><span style="color: #a8660d">02</span>s&nbsp;system&nbsp;<span style="color: #a8660d">9</span><span style="color: #2239a8; font-weight: bold">%</span>&nbsp;cpu&nbsp;<span style="color: #a8660d">0</span><span style="color: #2239a8; font-weight: bold">,</span><span style="color: #a8660d">549</span>&nbsp;total<br></pre>

<p>Note that this script and Lua/APR in general are a bit handicapped in that
they don&rsquo;t support <a href="http://en.wikipedia.org/wiki/HTTPS">HTTPS</a> because the Apache Portable Runtime does
not support encrypted network communication.</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;apr&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-require" style="color: #0e7c6b; text-decoration: none">require</a>&nbsp;<span style="color: #a8660d">'apr'</span><br><br><span style="color: #558817">--&nbsp;Report&nbsp;errors&nbsp;without&nbsp;stack&nbsp;traces.<br></span><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;<span style="color: #2239a8; font-weight: bold">function</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">...</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;status<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;message&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #2239a8; font-weight: bold">...</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;<span style="color: #2239a8; font-weight: bold">not</span>&nbsp;status&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.stderr" style="color: #0e7c6b; text-decoration: none">io.stderr</a><span style="color: #2239a8; font-weight: bold">:</span>write<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'Error:&nbsp;'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;message&nbsp;<span style="color: #2239a8; font-weight: bold">or</span>&nbsp;<span style="color: #a8660d">'(no&nbsp;message)'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'<span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-os.exit" style="color: #0e7c6b; text-decoration: none">os.exit</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">return</span>&nbsp;<span style="color: #2239a8; font-weight: bold">...</span><br><span style="color: #2239a8; font-weight: bold">end</span><br><br><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;<span style="color: #2239a8; font-weight: bold">function</span>&nbsp;getpage<span style="color: #2239a8; font-weight: bold">(</span>url<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;components&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.uri_parse" style="color: #0e7c6b; text-decoration: none">apr.uri_parse</a><span style="color: #2239a8; font-weight: bold">(</span>url<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>components.scheme&nbsp;<span style="color: #2239a8; font-weight: bold">==</span>&nbsp;<span style="color: #a8660d">'http'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">"invalid&nbsp;protocol!"</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;port&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>components.port&nbsp;<span style="color: #2239a8; font-weight: bold">or</span>&nbsp;<a href="http://peterodding.com/code/lua/apr/docs/#apr.uri_port_of_scheme" style="color: #0e7c6b; text-decoration: none">apr.uri_port_of_scheme</a><span style="color: #2239a8; font-weight: bold">(</span>components.scheme<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;socket&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.socket_create" style="color: #0e7c6b; text-decoration: none">apr.socket_create</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>socket<span style="color: #2239a8; font-weight: bold">:</span>connect<span style="color: #2239a8; font-weight: bold">(</span>components.hostname<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;port<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;pathinfo&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.uri_unparse" style="color: #0e7c6b; text-decoration: none">apr.uri_unparse</a><span style="color: #2239a8; font-weight: bold">(</span>components<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'pathinfo'</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>socket<span style="color: #2239a8; font-weight: bold">:</span>write<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'GET&nbsp;'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;pathinfo<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'&nbsp;HTTP/1.0<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">'Host:&nbsp;'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;components.hostname<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">'<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;statusline&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>socket<span style="color: #2239a8; font-weight: bold">:</span>read<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'HTTP&nbsp;response&nbsp;missing&nbsp;status&nbsp;line!'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;protocol<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;statuscode<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;reason&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>statusline<span style="color: #2239a8; font-weight: bold">:</span>match&nbsp;<span style="color: #a8660d">'^(<span style="color: #844631">%S</span>+)<span style="color: #844631">%s</span>+(<span style="color: #844631">%S</span>+)<span style="color: #844631">%s</span>+(.-)$'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;redirect&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;statuscode<span style="color: #2239a8; font-weight: bold">:</span>find&nbsp;<span style="color: #a8660d">'^30[123]$'</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">for</span>&nbsp;line&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;socket<span style="color: #2239a8; font-weight: bold">:</span>lines<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;name<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;value&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;line<span style="color: #2239a8; font-weight: bold">:</span>match&nbsp;<span style="color: #a8660d">'^(<span style="color: #844631">%S</span>+):<span style="color: #844631">%s</span>+(.-)<span style="color: #844631">\r</span>?$'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;name&nbsp;<span style="color: #2239a8; font-weight: bold">and</span>&nbsp;value&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;redirect&nbsp;<span style="color: #2239a8; font-weight: bold">and</span>&nbsp;name<span style="color: #2239a8; font-weight: bold">:</span>lower<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">==</span>&nbsp;<span style="color: #a8660d">'location'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.stderr" style="color: #0e7c6b; text-decoration: none">io.stderr</a><span style="color: #2239a8; font-weight: bold">:</span>write<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">"Following&nbsp;redirect&nbsp;to&nbsp;"</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;value<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">"&nbsp;..<span style="color: #844631">\n</span>"</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">return</span>&nbsp;getpage<span style="color: #2239a8; font-weight: bold">(</span>value<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">return</span>&nbsp;<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>socket<span style="color: #2239a8; font-weight: bold">:</span>read&nbsp;<span style="color: #a8660d">'*a'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'HTTP&nbsp;response&nbsp;missing&nbsp;body?!'</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;statuscode&nbsp;<span style="color: #2239a8; font-weight: bold">~=</span>&nbsp;<span style="color: #a8660d">'200'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">then</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-error" style="color: #0e7c6b; text-decoration: none">error</a><span style="color: #2239a8; font-weight: bold">(</span>reason<span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">end</span><br><br><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;usage&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">"Please&nbsp;provide&nbsp;a&nbsp;URL&nbsp;to&nbsp;download&nbsp;as&nbsp;argument"</span><br><a href="http://www.lua.org/manual/5.1/manual.html#pdf-io.write" style="color: #0e7c6b; text-decoration: none">io.write</a><span style="color: #2239a8; font-weight: bold">(</span>getpage<span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>arg&nbsp;<span style="color: #2239a8; font-weight: bold">and</span>&nbsp;arg<span style="color: #2239a8; font-weight: bold">[</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">]</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;usage<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><br><span style="color: #558817">--&nbsp;vim:&nbsp;ts=2&nbsp;sw=2&nbsp;et<br></span></pre>

<h2><a name="example_single_threaded_webserver" href="#example_single_threaded_webserver">Example: Single threaded webserver</a></h2>

<p>The following script implements a minimalistic webserver on top of Lua/APR.
It should work out of the box on Windows and UNIX, although you might get a
prompt from your firewall. Once the server is running you can open
<a href="http://localhost:8080">http://localhost:8080</a> in your web browser to see the server in action.
Because the server is single threaded I was curious how bad it would perform,
so I tested it with <a href="http://en.wikipedia.org/wiki/ApacheBench">ApacheBench</a>:</p>

<pre style="color: black; background: white" class="sourcecode lua">$&nbsp;lua&nbsp;examples<span style="color: #2239a8; font-weight: bold">/</span>webserver.lua&nbsp;&amp;<br>$&nbsp;ab&nbsp;<span style="color: #2239a8; font-weight: bold">-</span>qt5&nbsp;http<span style="color: #2239a8; font-weight: bold">:</span><span style="color: #2239a8; font-weight: bold">/</span><span style="color: #2239a8; font-weight: bold">/</span>localhost<span style="color: #2239a8; font-weight: bold">:</span><span style="color: #a8660d">8080</span><span style="color: #2239a8; font-weight: bold">/</span>&nbsp;|&nbsp;grep&nbsp;<span style="color: #a8660d">'Requests&nbsp;per&nbsp;second<span style="color: #844631">\|</span>Transfer&nbsp;rate'</span><br>Requests&nbsp;per&nbsp;second<span style="color: #2239a8; font-weight: bold">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">3672.19</span>&nbsp;<span style="color: #2239a8; font-weight: bold">[</span><span style="color: #2239a8; font-weight: bold">#</span><span style="color: #2239a8; font-weight: bold">/</span>sec<span style="color: #2239a8; font-weight: bold">]</span>&nbsp;<span style="color: #2239a8; font-weight: bold">(</span>mean<span style="color: #2239a8; font-weight: bold">)</span><br>Transfer&nbsp;rate<span style="color: #2239a8; font-weight: bold">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">2201.88</span>&nbsp;<span style="color: #2239a8; font-weight: bold">[</span>Kbytes<span style="color: #2239a8; font-weight: bold">/</span>sec<span style="color: #2239a8; font-weight: bold">]</span>&nbsp;received<br></pre>

<p>That&rsquo;s not too bad for 40 lines of code! Here is the script:</p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;port_number&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-tonumber" style="color: #0e7c6b; text-decoration: none">tonumber</a><span style="color: #2239a8; font-weight: bold">(</span>arg<span style="color: #2239a8; font-weight: bold">[</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">]</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">or</span>&nbsp;<span style="color: #a8660d">8080</span><br><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;bind_address&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;arg<span style="color: #2239a8; font-weight: bold">[</span><span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">]</span>&nbsp;<span style="color: #2239a8; font-weight: bold">or</span>&nbsp;<span style="color: #a8660d">'*'</span><br><br><span style="color: #558817">--&nbsp;Load&nbsp;the&nbsp;Lua/APR&nbsp;binding.<br></span><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;apr&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-require" style="color: #0e7c6b; text-decoration: none">require</a>&nbsp;<span style="color: #a8660d">'apr'</span><br><br><span style="color: #558817">--&nbsp;Initialize&nbsp;the&nbsp;server&nbsp;socket.<br></span><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;server&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.socket_create" style="color: #0e7c6b; text-decoration: none">apr.socket_create</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>server<span style="color: #2239a8; font-weight: bold">:</span>bind<span style="color: #2239a8; font-weight: bold">(</span>bind_address<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;port_number<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>server<span style="color: #2239a8; font-weight: bold">:</span>listen<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">"Running&nbsp;webserver&nbsp;on&nbsp;<a href="http://"" style="color: #272fc2">http://"</a></span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;bind_address&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">":"</span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;port_number&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">"&nbsp;.."</span><span style="color: #2239a8; font-weight: bold">)</span><br><br><span style="color: #558817">--&nbsp;Wait&nbsp;for&nbsp;clients&nbsp;to&nbsp;serve.<br></span><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;visitor&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1</span><br><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;template&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;[[<br>&lt;html&gt;<br>&nbsp;&nbsp;&lt;head&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;title&gt;Hello&nbsp;from&nbsp;Lua/APR!&lt;/title&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;style&nbsp;type="text/css"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;body&nbsp;{&nbsp;font-family:&nbsp;sans-serif;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dt&nbsp;{&nbsp;font-weight:&nbsp;bold;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dd&nbsp;{&nbsp;font-family:&nbsp;monospace;&nbsp;margin:&nbsp;-1.4em&nbsp;0&nbsp;0&nbsp;14em;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/style&gt;<br>&nbsp;&nbsp;&lt;/head&gt;<br>&nbsp;&nbsp;&lt;body&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;h1&gt;Hello&nbsp;from&nbsp;Lua/APR!&lt;/h1&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;em&gt;You&nbsp;are&nbsp;visitor&nbsp;number&nbsp;%010i.&lt;/em&gt;&lt;/p&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;headers&nbsp;provided&nbsp;by&nbsp;your&nbsp;web&nbsp;browser:&lt;/p&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;dl&gt;%s&lt;/dl&gt;<br>&nbsp;&nbsp;&lt;/body&gt;<br>&lt;/html&gt;<br>]]<br><span style="color: #2239a8; font-weight: bold">while</span>&nbsp;<span style="color: #a8660d">true</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;status<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;message&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-pcall" style="color: #0e7c6b; text-decoration: none">pcall</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">function</span><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;client&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>server<span style="color: #2239a8; font-weight: bold">:</span>accept<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #558817">--&nbsp;Read&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;receive&nbsp;data.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;request&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>client<span style="color: #2239a8; font-weight: bold">:</span>read<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">"Failed&nbsp;to&nbsp;receive&nbsp;request&nbsp;from&nbsp;client!"</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;method<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;location<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;protocol&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>request<span style="color: #2239a8; font-weight: bold">:</span>match&nbsp;<span style="color: #a8660d">'^(<span style="color: #844631">%w</span>+)<span style="color: #844631">%s</span>+(<span style="color: #844631">%S</span>+)<span style="color: #844631">%s</span>+(<span style="color: #844631">%S</span>+)'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;headers&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #2239a8; font-weight: bold">{</span><span style="color: #2239a8; font-weight: bold">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">for</span>&nbsp;line&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;client<span style="color: #2239a8; font-weight: bold">:</span>lines<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;name<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;value&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;line<span style="color: #2239a8; font-weight: bold">:</span>match&nbsp;<span style="color: #a8660d">'^(<span style="color: #844631">%S</span>+):<span style="color: #844631">%s</span>+(.-)$'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;<span style="color: #2239a8; font-weight: bold">not</span>&nbsp;name&nbsp;<span style="color: #2239a8; font-weight: bold">then</span>&nbsp;<span style="color: #2239a8; font-weight: bold">break</span>&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.insert" style="color: #0e7c6b; text-decoration: none">table.insert</a><span style="color: #2239a8; font-weight: bold">(</span>headers<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'&lt;dt&gt;'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;name&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">':&lt;/dt&gt;&lt;dd&gt;'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;value&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">'&lt;/dd&gt;'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #558817">--&nbsp;Generate&nbsp;the&nbsp;HTTP&nbsp;response.<br></span>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.sort" style="color: #0e7c6b; text-decoration: none">table.sort</a><span style="color: #2239a8; font-weight: bold">(</span>headers<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;content&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;template<span style="color: #2239a8; font-weight: bold">:</span>format<span style="color: #2239a8; font-weight: bold">(</span>visitor<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.concat" style="color: #0e7c6b; text-decoration: none">table.concat</a><span style="color: #2239a8; font-weight: bold">(</span>headers<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;client<span style="color: #2239a8; font-weight: bold">:</span>write<span style="color: #2239a8; font-weight: bold">(</span>protocol<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'&nbsp;200&nbsp;OK<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">'Content-Type:&nbsp;text/html<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">'Content-Length:&nbsp;'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #2239a8; font-weight: bold">#</span>content&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">'<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">'Connection:&nbsp;close<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">'<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;content<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>client<span style="color: #2239a8; font-weight: bold">:</span>close<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;visitor&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;visitor&nbsp;<span style="color: #2239a8; font-weight: bold">+</span>&nbsp;<span style="color: #a8660d">1</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;<span style="color: #2239a8; font-weight: bold">not</span>&nbsp;status&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'Error&nbsp;while&nbsp;serving&nbsp;request:'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;message<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">end</span><br><br><span style="color: #558817">--&nbsp;vim:&nbsp;ts=2&nbsp;sw=2&nbsp;et<br></span></pre>

<h2><a name="example_multi_threaded_webserver" href="#example_multi_threaded_webserver">Example: Multi threaded webserver</a></h2>

<p>Thanks to the <a href="#multi_threading">multi threading</a> and <a href="#thread_queues">thread queue</a> modules in the Apache Portable Runtime it is possible to
improve the performance of the single threaded webserver from the previous
example. Here is a benchmark of the multi threaded implementation listed
below (again using <a href="http://en.wikipedia.org/wiki/ApacheBench">ApacheBench</a>, but now with the <code>-c</code> argument):</p>

<pre style="color: black; background: white" class="sourcecode lua">$&nbsp;NUM_THREADS<span style="color: #2239a8; font-weight: bold">=</span><span style="color: #a8660d">4</span><br>$&nbsp;lua&nbsp;examples<span style="color: #2239a8; font-weight: bold">/</span>threaded<span style="color: #2239a8; font-weight: bold">-</span>webserver.lua&nbsp;$NUM_THREADS&nbsp;&amp;<br>$&nbsp;ab&nbsp;<span style="color: #2239a8; font-weight: bold">-</span>qt5&nbsp;<span style="color: #2239a8; font-weight: bold">-</span>c$NUM_THREADS&nbsp;http<span style="color: #2239a8; font-weight: bold">:</span><span style="color: #2239a8; font-weight: bold">/</span><span style="color: #2239a8; font-weight: bold">/</span>localhost<span style="color: #2239a8; font-weight: bold">:</span><span style="color: #a8660d">8080</span><span style="color: #2239a8; font-weight: bold">/</span>&nbsp;|&nbsp;grep&nbsp;<span style="color: #a8660d">'Requests&nbsp;per&nbsp;second<span style="color: #844631">\|</span>Transfer&nbsp;rate'</span><br>Requests&nbsp;per&nbsp;second<span style="color: #2239a8; font-weight: bold">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">9210.72</span>&nbsp;<span style="color: #2239a8; font-weight: bold">[</span><span style="color: #2239a8; font-weight: bold">#</span><span style="color: #2239a8; font-weight: bold">/</span>sec<span style="color: #2239a8; font-weight: bold">]</span>&nbsp;<span style="color: #2239a8; font-weight: bold">(</span>mean<span style="color: #2239a8; font-weight: bold">)</span><br>Transfer&nbsp;rate<span style="color: #2239a8; font-weight: bold">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">5594.79</span>&nbsp;<span style="color: #2239a8; font-weight: bold">[</span>Kbytes<span style="color: #2239a8; font-weight: bold">/</span>sec<span style="color: #2239a8; font-weight: bold">]</span>&nbsp;received<br></pre>

<p>Comparing these numbers to the benchmark of the single threaded webserver we
can see that the number of requests per second went from 3670 to 9210, more
than doubling the throughput of the webserver on a dual core processor.</p>

<p><em>Note that both benchmarks were run on my Compaq Presario CQ60 laptop (which
features an Intel Core 2 Duo T5800 processor clocked at 2 GHz and 3 GB of
RAM) and that the Lua/APR binding was compiled without debugging symbols.</em></p>

<pre style="color: black; background: white" class="sourcecode lua"><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;num_threads&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-tonumber" style="color: #0e7c6b; text-decoration: none">tonumber</a><span style="color: #2239a8; font-weight: bold">(</span>arg<span style="color: #2239a8; font-weight: bold">[</span><span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">]</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">or</span>&nbsp;<span style="color: #a8660d">2</span><br><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;port_number&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-tonumber" style="color: #0e7c6b; text-decoration: none">tonumber</a><span style="color: #2239a8; font-weight: bold">(</span>arg<span style="color: #2239a8; font-weight: bold">[</span><span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">]</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">or</span>&nbsp;<span style="color: #a8660d">8080</span><br><br><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;template&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;[[<br>&lt;html&gt;<br>&nbsp;&nbsp;&lt;head&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;title&gt;Hello&nbsp;from&nbsp;Lua/APR!&lt;/title&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;style&nbsp;type="text/css"&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;body&nbsp;{&nbsp;font-family:&nbsp;sans-serif;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dt&nbsp;{&nbsp;font-weight:&nbsp;bold;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dd&nbsp;{&nbsp;font-family:&nbsp;monospace;&nbsp;margin:&nbsp;-1.4em&nbsp;0&nbsp;0&nbsp;14em;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/style&gt;<br>&nbsp;&nbsp;&lt;/head&gt;<br>&nbsp;&nbsp;&lt;body&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;h1&gt;Hello&nbsp;from&nbsp;Lua/APR!&lt;/h1&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;em&gt;This&nbsp;web&nbsp;page&nbsp;was&nbsp;served&nbsp;by&nbsp;worker&nbsp;%i.&lt;/em&gt;&lt;/p&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;headers&nbsp;provided&nbsp;by&nbsp;your&nbsp;web&nbsp;browser:&lt;/p&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;dl&gt;%s&lt;/dl&gt;<br>&nbsp;&nbsp;&lt;/body&gt;<br>&lt;/html&gt;<br>]]<br><br><span style="color: #558817">--&nbsp;Load&nbsp;the&nbsp;Lua/APR&nbsp;binding.<br></span><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;apr&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-require" style="color: #0e7c6b; text-decoration: none">require</a>&nbsp;<span style="color: #a8660d">'apr'</span><br><br><span style="color: #558817">--&nbsp;Initialize&nbsp;the&nbsp;server&nbsp;socket.<br></span><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;server&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://peterodding.com/code/lua/apr/docs/#apr.socket_create" style="color: #0e7c6b; text-decoration: none">apr.socket_create</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>server<span style="color: #2239a8; font-weight: bold">:</span>bind<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'*'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;port_number<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>server<span style="color: #2239a8; font-weight: bold">:</span>listen<span style="color: #2239a8; font-weight: bold">(</span>num_threads&nbsp;<span style="color: #2239a8; font-weight: bold">*</span>&nbsp;<span style="color: #a8660d">2</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">"Running&nbsp;webserver&nbsp;with&nbsp;"</span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;num_threads&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">"&nbsp;client&nbsp;threads&nbsp;on&nbsp;<a href="http://localhost:"" style="color: #272fc2">http://localhost:"</a></span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;port_number&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">"&nbsp;.."</span><span style="color: #2239a8; font-weight: bold">)</span><br><br><span style="color: #558817">--&nbsp;Create&nbsp;the&nbsp;thread&nbsp;queue&nbsp;(used&nbsp;to&nbsp;pass&nbsp;sockets&nbsp;between&nbsp;threads).<br></span><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;queue&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;apr.thread_queue<span style="color: #2239a8; font-weight: bold">(</span>num_threads<span style="color: #2239a8; font-weight: bold">)</span><br><br><span style="color: #558817">--&nbsp;Define&nbsp;the&nbsp;function&nbsp;to&nbsp;execute&nbsp;in&nbsp;each&nbsp;child&nbsp;thread.<br></span><span style="color: #2239a8; font-weight: bold">function</span>&nbsp;worker<span style="color: #2239a8; font-weight: bold">(</span>thread_id<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;queue<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;template<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-pcall" style="color: #0e7c6b; text-decoration: none">pcall</a><span style="color: #2239a8; font-weight: bold">(</span><a href="http://www.lua.org/manual/5.1/manual.html#pdf-require" style="color: #0e7c6b; text-decoration: none">require</a><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'luarocks.require'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;apr&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-require" style="color: #0e7c6b; text-decoration: none">require</a>&nbsp;<span style="color: #a8660d">'apr'</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">while</span>&nbsp;<span style="color: #a8660d">true</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;client<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;msg<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;code&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;queue<span style="color: #2239a8; font-weight: bold">:</span>pop<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>client&nbsp;<span style="color: #2239a8; font-weight: bold">or</span>&nbsp;code&nbsp;<span style="color: #2239a8; font-weight: bold">==</span>&nbsp;<span style="color: #a8660d">'EINTR'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;msg<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;client&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;status<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;message&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-pcall" style="color: #0e7c6b; text-decoration: none">pcall</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">function</span><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;request&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>client<span style="color: #2239a8; font-weight: bold">:</span>read<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">"Failed&nbsp;to&nbsp;receive&nbsp;request&nbsp;from&nbsp;client!"</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;method<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;location<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;protocol&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>request<span style="color: #2239a8; font-weight: bold">:</span>match&nbsp;<span style="color: #a8660d">'^(<span style="color: #844631">%w</span>+)<span style="color: #844631">%s</span>+(<span style="color: #844631">%S</span>+)<span style="color: #844631">%s</span>+(<span style="color: #844631">%S</span>+)'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;headers&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #2239a8; font-weight: bold">{</span><span style="color: #2239a8; font-weight: bold">}</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">for</span>&nbsp;line&nbsp;<span style="color: #2239a8; font-weight: bold">in</span>&nbsp;client<span style="color: #2239a8; font-weight: bold">:</span>lines<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;name<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;value&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;line<span style="color: #2239a8; font-weight: bold">:</span>match&nbsp;<span style="color: #a8660d">'^(<span style="color: #844631">%S</span>+):<span style="color: #844631">%s</span>+(.-)$'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;<span style="color: #2239a8; font-weight: bold">not</span>&nbsp;name&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">break</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.insert" style="color: #0e7c6b; text-decoration: none">table.insert</a><span style="color: #2239a8; font-weight: bold">(</span>headers<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'&lt;dt&gt;'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;name&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">':&lt;/dt&gt;&lt;dd&gt;'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;value&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">'&lt;/dd&gt;'</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.sort" style="color: #0e7c6b; text-decoration: none">table.sort</a><span style="color: #2239a8; font-weight: bold">(</span>headers<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;content&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;template<span style="color: #2239a8; font-weight: bold">:</span>format<span style="color: #2239a8; font-weight: bold">(</span>thread_id<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.concat" style="color: #0e7c6b; text-decoration: none">table.concat</a><span style="color: #2239a8; font-weight: bold">(</span>headers<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client<span style="color: #2239a8; font-weight: bold">:</span>write<span style="color: #2239a8; font-weight: bold">(</span>protocol<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<span style="color: #a8660d">'&nbsp;200&nbsp;OK<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">'Content-Type:&nbsp;text/html<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">'Content-Length:&nbsp;'</span>&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #2239a8; font-weight: bold">#</span>content&nbsp;<span style="color: #2239a8; font-weight: bold">..</span>&nbsp;<span style="color: #a8660d">'<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">'Connection:&nbsp;close<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #a8660d">'<span style="color: #844631">\r</span><span style="color: #844631">\n</span>'</span><span style="color: #2239a8; font-weight: bold">,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;content<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>client<span style="color: #2239a8; font-weight: bold">:</span>close<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;<span style="color: #2239a8; font-weight: bold">not</span>&nbsp;status&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'Error&nbsp;while&nbsp;serving&nbsp;request:'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;message<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">end</span><br><br><span style="color: #558817">--&nbsp;We&nbsp;could&nbsp;give&nbsp;apr.thread_create()&nbsp;a&nbsp;string&nbsp;of&nbsp;Lua&nbsp;code&nbsp;but&nbsp;by&nbsp;using&nbsp;byte<br></span><span style="color: #558817">--&nbsp;code&nbsp;instead&nbsp;we&nbsp;enable&nbsp;syntax&nbsp;highlighting&nbsp;and&nbsp;we&nbsp;preserve&nbsp;filename&nbsp;and&nbsp;line<br></span><span style="color: #558817">--&nbsp;numbers&nbsp;in&nbsp;Lua's&nbsp;traceback&nbsp;messages&nbsp;(this&nbsp;makes&nbsp;debugging&nbsp;less&nbsp;of&nbsp;a&nbsp;pain).<br></span><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;bytecode&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-string.dump" style="color: #0e7c6b; text-decoration: none">string.dump</a><span style="color: #2239a8; font-weight: bold">(</span>worker<span style="color: #2239a8; font-weight: bold">)</span><br><br><span style="color: #558817">--&nbsp;Create&nbsp;the&nbsp;child&nbsp;threads&nbsp;and&nbsp;keep&nbsp;them&nbsp;around&nbsp;in&nbsp;a&nbsp;table&nbsp;(so&nbsp;that&nbsp;they&nbsp;are<br></span><span style="color: #558817">--&nbsp;not&nbsp;garbage&nbsp;collected&nbsp;while&nbsp;we&nbsp;are&nbsp;still&nbsp;using&nbsp;them).<br></span><span style="color: #2239a8; font-weight: bold">local</span>&nbsp;pool&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #2239a8; font-weight: bold">{</span><span style="color: #2239a8; font-weight: bold">}</span><br><span style="color: #2239a8; font-weight: bold">for</span>&nbsp;i&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<span style="color: #a8660d">1</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;num_threads&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br>&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-table.insert" style="color: #0e7c6b; text-decoration: none">table.insert</a><span style="color: #2239a8; font-weight: bold">(</span>pool<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>apr.thread_create<span style="color: #2239a8; font-weight: bold">(</span>bytecode<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;i<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;queue<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;template<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br><span style="color: #2239a8; font-weight: bold">end</span><br><br><span style="color: #558817">--&nbsp;Enter&nbsp;the&nbsp;accept()&nbsp;loop&nbsp;in&nbsp;the&nbsp;parent&nbsp;thread.<br></span><span style="color: #2239a8; font-weight: bold">while</span>&nbsp;<span style="color: #a8660d">true</span>&nbsp;<span style="color: #2239a8; font-weight: bold">do</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;status<span style="color: #2239a8; font-weight: bold">,</span>&nbsp;message&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-pcall" style="color: #0e7c6b; text-decoration: none">pcall</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">function</span><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">local</span>&nbsp;client&nbsp;<span style="color: #2239a8; font-weight: bold">=</span>&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>server<span style="color: #2239a8; font-weight: bold">:</span>accept<span style="color: #2239a8; font-weight: bold">(</span><span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-assert" style="color: #0e7c6b; text-decoration: none">assert</a><span style="color: #2239a8; font-weight: bold">(</span>queue<span style="color: #2239a8; font-weight: bold">:</span>push<span style="color: #2239a8; font-weight: bold">(</span>client<span style="color: #2239a8; font-weight: bold">)</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">if</span>&nbsp;<span style="color: #2239a8; font-weight: bold">not</span>&nbsp;status&nbsp;<span style="color: #2239a8; font-weight: bold">then</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print" style="color: #0e7c6b; text-decoration: none">print</a><span style="color: #2239a8; font-weight: bold">(</span><span style="color: #a8660d">'Error&nbsp;while&nbsp;serving&nbsp;request:'</span><span style="color: #2239a8; font-weight: bold">,</span>&nbsp;message<span style="color: #2239a8; font-weight: bold">)</span><br>&nbsp;&nbsp;<span style="color: #2239a8; font-weight: bold">end</span><br><span style="color: #2239a8; font-weight: bold">end</span><br><br><span style="color: #558817">--&nbsp;vim:&nbsp;ts=2&nbsp;sw=2&nbsp;et<br></span></pre>
</body>
</html>
